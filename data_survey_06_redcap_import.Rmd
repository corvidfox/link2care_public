---
title: "Import Link2Care Survey Data - REDCap"
date: "2021-04-23 <br> Updated: `r Sys.Date()`"
---

# ‚≠êÔ∏èOverview

This file is used to import the Link2Care follow-up visit survey data and do some initial data cleaning. 

**NOTE on using multiple import code files:**
Previously, I was trying to clean all the separate data frames (i.e, QDS v1-v5, REDCap, and Master Log) in a single Rmd file. 

In theory, this is more efficient than importing and cleaning each visit file separately. For example, we can clean "race" instead of cleaning "race_v1", "race_v2", etc.

However, there are at least two issues with that approach:   
1. There are intentional differences in the variable names (e.g., "V1" and "V2"), and unintentional errors (e.g., HEIGHT_3) in the variable names, from data frame to data frame that make combining them very difficult.   
2. These differences and errors can be "fixed"; however, doing so makes the variable names so different from the codebook that the codebook is barely usable.

For now, I'm going to try importing and cleaning each data file using a separate code file. There may be opportunities to make this more efficient in the future.

**NOTE on data sources:**
* The QDS data is exported from QDS in SPSS data format. The data has to be exported by visit (i.e., v1, v2, ... v5). The SPSS data is then added to the UTHealth servers.

* Some of the v3-v5 visits are also done using REDCap. That data is exported from REDCap and added to the UTHealth servers.

**NOTE on Kiteworks:**
Currently, I'm importing all of this data from the UTHealth server. The data should also be available on Kiteworks if you are unable to connect to the server for some reason.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# üì¶Load packages

```{r message=FALSE}
library(dplyr)
library(haven)
library(readr)
library(readxl)
```


# üåéConnect to UTH server 

```{bash eval=FALSE}
# Don't drill all the way down to live documents because not all of the data is in live documents.
open 'smb://islgpcifs.uthouston.edu/sph_research/Link2Care/'
```


# üì•Import data 

```{r}
redcap <- read_sav("/Volumes/Link2Care/Participant Data/REDCap/All_Visits_Redcap.sav")

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "REDCap imported with", nrow(redcap), "rows and", ncol(redcap), "columns.\n"
)

# 2021-04-28: REDCap imported with 12 rows and 909 columns.
```


# Clean variable names

_See "Notes on cleaning individual L2C data sets for merging" for the rationale, style guidelines, and instructions for this section._

## Extract content from Excel codebook

The column names in QDS and REDCap do not match. The Excel spreadsheet we import below is a key that bridges the QDS names to the REDCap names. 

```{r}
rc_col_key <- read_excel(
  "docs/codebooks/L2C Column Name Key.xlsx",
  sheet = "QDS to REDCap Key (Edited)",
  col_names = c("qds_name", "rc_name"),
  col_types = c("text"),
  skip = 1
)
```

## Rename REDCap columns

```{r}
current_names <- tibble(current_names = names(redcap))
```

```{r}
# current_names <- 
current_names %>% 
  left_join(rc_col_key, by = c("current_names" = "rc_name"))
```



Does the REDcap data have the same number of unique column names as the REDCap column in the column name key?

```{r}
length(unique(names(redcap)))
```

```{r}
length(unique(na.omit(rc_col_key$rc_name)))
```

No, the REDCap data has 914 - 794 = 120 more columns than the key has column names. Which columns appear in the REDCap data, but not in the column name key?

```{r}
df_col_names <- names(redcap) # 914
key_col_names <- rc_col_key$rc_name %>% na.omit() # 794
```

```{r}
setdiff(df_col_names, key_col_names)
```



## Rename REDCap columns using the key

```{r}
redcap %>% 
  select(rc_col_key$)
```








### Differences between QDS columns and REDCap columns

Check to see what differences, if any, exist between the columns in the QDS data and the columns in the REDCap data frame.

```{r}
in_qds_not_rc <- setdiff(qds_col_names, redcap_col_names)
in_qds_not_rc
```

There are **855** column names in the QDS data that don't appear in the REDCAp data.  

```{r}
# Future proof this by checking to see if the variables have changed over time.
# If this test fails in the future, come back and make adjustments to how we 
# handle columns as needed.
test_that("The expected columns exist in the codebook, but not the v3 df.", {
  expect_equal(
    length(in_cb_not_df),
    0L
  )
})
```

Now, check for columns that exist in the data frame, but not the codebook.

```{r}
in_rc_not_qds <- setdiff(redcap_col_names, qds_col_names)
in_rc_not_qds
```

There are **870** column names in the QDS data that don't appear in the REDCAp data.

```{r}

```


```{r}
# Future proof this by checking to see if the variables have changed over time.
# If this test fails in the future, come back and make adjustments to how we 
# handle columns as needed.
test_that("The expected columns exist in the v3 df, but not the v3 codebook.", {
  expect_equal(
    length(in_df_not_cb),
    77L
  )
})
```

The remainder of these variables are calculated variables created by the SPSS export script. We will save them in a separate data frame and deal with them later. 

```{r}
v3_spss_calc_vars <- v3 %>% 
  select(id = SUBJECT, visit = VISIT_V3, all_of(in_df_not_cb))
```

```{r}
write_sav(v3_spss_calc_vars, "data/v3_spss_calc_vars.sav")
```

Remove calculated variables from the v3 data. This makes it easier to merge with the other QDS data frames later.

```{r}
v3 <- v3 %>% select(!all_of(in_df_not_cb))
```

```{r}
# Future proof this by checking to see if the variables have changed over time.
# If this test fails in the future, come back and make adjustments to how we 
# handle columns as needed.
test_that("The expected number of columns exist in the v3 df after cleaning.", {
  expect_equal(
    length(names(v3)),
    449L
  )
})
```

Clean up

```{r}
rm(v3_spss_calc_vars, in_cb_not_df, in_df_not_cb)
```






# üñ®Print a message for when this file is being sourced

```{r}
cat(
  paste0(Sys.Date(), ":"),
  "REDCap cleaned with", nrow(redcap), "rows and", ncol(redcap), "columns.\n"
)
```


```{r echo=FALSE}
sessionInfo()
```
---
title: "Import Link2Care Survey Data - REDCap"
date: "2021-04-23 <br> Updated: `r Sys.Date()`"
---

# ‚≠êÔ∏èOverview

This file is used to import the Link2Care follow-up visit survey data and do some initial data cleaning. 

**NOTE on using multiple import code files:**
Previously, I was trying to clean all the separate data frames (i.e, QDS v1-v5, REDCap, and Master Log) in a single Rmd file. 

In theory, this is more efficient than importing and cleaning each visit file separately. For example, we can clean "race" instead of cleaning "race_v1", "race_v2", etc.

However, there are at least two issues with that approach:   
1. There are intentional differences in the variable names (e.g., "V1" and "V2"), and unintentional errors (e.g., HEIGHT_3) in the variable names, from data frame to data frame that make combining them very difficult.   
2. These differences and errors can be "fixed"; however, doing so makes the variable names so different from the codebook that the codebook is barely usable.

For now, I'm going to try importing and cleaning each data file using a separate code file. There may be opportunities to make this more efficient in the future.

**NOTE on data sources:**
* The QDS data is exported from QDS in SPSS data format. The data has to be exported by visit (i.e., v1, v2, ... v5). The SPSS data is then added to the UTHealth servers.

* Some of the v3-v5 visits are also done using REDCap. That data is exported from REDCap and added to the UTHealth servers.

**NOTE on Kiteworks:**
Currently, I'm importing all of this data from the UTHealth server. The data should also be available on Kiteworks if you are unable to connect to the server for some reason.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# üì¶Load packages

```{r message=FALSE}
library(dplyr)
library(haven)
library(readr)
library(readxl)
```


# üåéConnect to UTH server 

```{bash eval=FALSE}
# Don't drill all the way down to live documents because not all of the data is in live documents.
open 'smb://islgpcifs.uthouston.edu/sph_research/Link2Care/'
```


# üì•Import data 

```{r}
redcap <- read_sav("/Volumes/Link2Care/Participant Data/REDCap/All_Visits_Redcap.sav")

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "REDCap imported with", nrow(redcap), "rows and", ncol(redcap), "columns.\n"
)

# 2021-04-28: REDCap imported with 12 rows and 909 columns.
```


# Remove fake data rows

Joe created some fake data rows in REDCap that need to be removed.

```{r}
redcap <- redcap %>% filter(record_id > 2000)
```

```{r}
# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "After dropping fake participant rows, REDCap data contains", nrow(redcap), "rows and", ncol(redcap), "columns.\n"
)

# 2021-06-30: After dropping fake participant rows, REDCap data contains 21 rows and 914 columns.
```


# Clean variable names

_See "Notes on cleaning individual L2C data sets for merging" for the rationale, style guidelines, and instructions for this section._

## Extract content from Excel codebook

The column names in QDS and REDCap do not match. The Excel spreadsheet we import below is a key that bridges the QDS names to the REDCap names. 

```{r}
rc_col_key <- read_excel(
  "docs/codebooks/L2C Column Name Key.xlsx",
  sheet = "QDS to REDCap Key (Final)",
  col_names = c("qds_name", "rc_name"),
  col_types = c("text", "text", rep("skip", 5)),
  skip = 1
)
```

Put current REDCap column names into a data frame so that we can use `left_join()` below.

```{r}
current_col_names <- tibble(current_names = names(redcap))
```

Review column names that don't have a match in the QDS data.

```{r eval=FALSE}
current_col_names %>% 
  left_join(rc_col_key, by = c("current_names" = "rc_name")) %>% 
  filter(is.na(qds_name))
```

Did a manual review of current REDCap names that aren't matched to a QDS column name. They all appear to be variables that truly don't exist in QDS. Many of them are time stamps marking the beginning and end of survey sections. 

Some exceptions:   

* There is an ii column, which does have a matching variable in QDS, but there is also an ii_v1 column. It doesn't contain any values. we will just drop it.   

* There is a visit column, which does have a matching variable in QDS, but there is also an visit_v1. It doesn't contain any values. we will just drop it.   

* There is a visit_gender column, which does have a matching variable in QDS, but there is also a gender column. It doesn't contain any values. we will just drop it.   

* sq_7b2 says, "You selected that you received a flyer about the study from the Dallas County Jail. Please enter the study flyer number." This variable doesn't exist in QDS. We will leave it and it will have a missing value for all QDS rows in the combined data.

* vac1, vac2, and vac3 are COVID questions that don't appear in QDS. We will leave them and they will have a missing value for all QDS rows in the combined data.

```{r}
redcap <- redcap %>% 
  select(-ii_v1, -visit_v1, -gender)
```

Put current REDCap column names into a data frame so that we can use `left_join()` below. We have to do this step again because we dropped variables above.

```{r}
current_col_names <- tibble(current_names = names(redcap))
```

Join the QDS names to the REDCap names

```{r eval=FALSE}
current_col_names <- current_col_names %>% 
  left_join(rc_col_key, by = c("current_names" = "rc_name"))
```

## Rename REDCap columns to match QDS

Create a final new set of column names. The new name will be equal to qds_name unless qds_name is missing (i.e., that variable doesn't appear in the QDS data). When qds_name is missing, then the column will keep its current column name.

```{r}
new_col_names <- current_col_names %>% 
  mutate(new_names = if_else(is.na(qds_name), current_names, qds_name))
```

```{r}
names(redcap) <- pull(new_col_names, new_names)
```


# üíæSave the data frame

```{r}
path <- "/Volumes/Link2Care/Participant Data/R Data/redcap_import.rds"
```

```{r}
write_rds(redcap, path)
```

Print a message for when this file is being sourced

```{r}
cat(
  paste0(Sys.Date(), ":"),
  "REDCap data saved to", path
)
```


# üóëClean up

```{r}
rm(current_col_names, new_col_names, rc_col_key, path)
```


# üñ®Print a message for when this file is being sourced

```{r}
cat(
  paste0(Sys.Date(), ":"),
  "REDCap data cleaned with", nrow(redcap), "rows and", ncol(redcap), "columns.\n"
)

# 2021-06-30: REDCap data cleaned with 21 rows and 911 columns.
```

```{r echo=FALSE}
sessionInfo()
```


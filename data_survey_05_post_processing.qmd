---
title: "Step 5 - Post Processing Modifications"
date: "2022-10-20 <br> Updated: `r Sys.Date()`"
format: pdf
editor: 
  markdown: 
    wrap: sentence
---

# ‚≠êÔ∏èOverview

This file is step 5 in processing the source data from Link2Care (L2C) into a single data set for analysis.

This file involves applying a final renaming to variables, flagging PHI variables, and any other post-processing modifications.

[Notes on cleaning individual L2C data sets for merging](https://github.com/brad-cannell/link2care_public/wiki/Notes-on-cleaning-individual-L2C-data-sets-for-merging)

## Process Steps

1.  Pre-process DDT, Arrest, and Bridge Session Minutes data sets so they are compatible with a long-format Subject-Visit composite key structure

2.  Import all source data sets (QDS, REDCap, Master Log, TLFB, DDT, Arrest, Bridge Sessions) to create the variable map

    -   Select variables for inclusion in the final composite data set

    -   Set initial standardization of the variable names for all desired variables in the composite data set

    -   Establish order for the variables in the composite data set

    -   Extract variable label and variable value labels from source data sets to be included in the composite data set

3.  Batch processing of data sets into combined data set

4.  Recreation of calculated variables

    -   Consolidating redundant variables
    
    -   Creation of calculated variables, including labels and addition to the variable map

5.  **Post-processing modifications**

    -  Finalize desired variable names
    
    -  Flag PHI variables


## Notes

Several of our variable standardization were not descriptive, nor did they fit our desired final style.

In this step, we aim to standardize our variable names under the following structure:

-   All digits should be double digit (i.e. "sq_2" should be "sq_02")

-   Variables should have a standard prefix

    -   Initial prefix should indicate the instrument, if possible
    
    -   Item order should immediately follow this prefix

-   Typos should be corrected (i.e. `tq`, not `yq`, `dem` not `dme` in prefixes)

-   Items should have descriptive names if their content is likely to be examined individually

    -   Standardized items that produce a score for inference, rather than inferences being made on the individual items, do not require a descriptive name
    
    -   Descriptive names should be short, and logically ordered similar to names of file/folder structures. Abbreviations should be used when logical
    
    -   Demographic variables that are not located in the demographic instrument should have 'subj' within their descriptive names, to allow for selection in tidyselect

### üïí Change Log

**2023-10-23**,

**2023-10-20**, file initialized

### üî¥üî¥üî¥ Notes for Brad from Morri (2023-10-23)

-   I will revise documentation once the process is completed, to ensure it's complete and streamlined as possible.

# üì¶Load packages & Functions

```{r, message=FALSE, warning=FALSE}
library(dplyr, warn.conflicts = FALSE)
library(purrr, warn.conflicts = FALSE)
library(haven, warn.conflicts = FALSE)
library(here, warn.conflicts = FALSE)
library(stringr, warn.conflicts = FALSE)
library(lubridate, warn.conflicts = FALSE)
library(readxl, warn.conflicts = FALSE)
library(openxlsx, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)
library(tidyverse, warn.conflicts = FALSE)
```

```{r}
source(here("R", "standardize_col_names.R"))
source(here("R", "flag_unmatching_variables.R"))
source(here("R", "vm_make_source_map.R"))
source(here("R", "vm_check.R"))
source(here("R", "vm_create_for_instrument.R"))
source(here("R", "vm_join_inst_section.R"))
source(here("R", "vm_join_sections.R"))
source(here("R", "vm_add_variable.R"))
source(here("R", "vm_delete_variable.R"))
source(here("R", "vm_process_source_df.R"))
source(here("R", "vm_process_many_source.R"))
source(here("R", "data_mod_check.R"))
```

# üì• Import data

## Combined Data Set

We imported our Combined Data Set

```{r}
combined_data_path <- here(
  "data", "Combined Participant Data", "combined_data_02.rds"
  )
```

Import the data.
Check the most recent file modification dates and print for user when this file is being sourced.

```{r message=FALSE}
combined_data <- readRDS(combined_data_path)

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "Combined data imported with", nrow(combined_data), "rows and", 
  ncol(combined_data), "columns.\n"
)

# Check the most recent file modification dates and print for user when this
# file is being sourced.

cat(
      "Combined data last modified on OneDrive", 
      as.character(file.info(combined_data_path)$mtime), "\n"
    )

# 2023-10-23: Combined data imported with 1610 rows and 1063 columns.
# Combined data last modified on OneDrive 2023-10-23 10:56:54 
```

#### Data Check: Changes

We checked for changes to the source data set since this file was last modified.

```{r}
# Inputs last modified: 2023-10-23
# 
data_mod_check(
  'df' = combined_data,
  'df_path_str' = combined_data_path,
  'orig_path_str' = here(
      "data", "Combined Participant Data", "combined_data_02.rds"
      ),
  'mod_dt' = '2023-10-23 10:56:54 CDT',
  'num_rows' = 1610,
  'num_cols' = 1063,
  'col_names' = c(
    'subject', 'group', 'redcap_event_name', 'visit',
    'visit_type', 'today', 'ii', 'name_first',
    'name_middle', 'name_last', 'care_manager', 'ctime',
    'endtime', 'time_to_complete', 'maca_mdd_timestamp',
    'maca_mdd_complete', 'ps_timestamp', 'ps_complete',
    'email', 'days_followed', 'flag_outofwindow',
    'v2_status', 'dropped_status', 'gender', 'ml_gender',
    'sq_2', 'ml_hispanic_latino', 'sq_3', 'ml_race',
    'sq_4', 'ml_dob', 'ml_age', 'sq_5', 'sq_6', 'sq_7',
    'sq_7a', 'sq_7b', 'sq_7c', 'sq_7d', 'sq_8', 'sq_9',
    'sq_9l', 'sq_10', 'sq_11', 'sq_12', 'sq_13', 'sq_14',
    'sq_15', 'sq_16', 'sq_17', 'sq_18', 'sq_18a', 'sq_18b',
    'sq_18c', 'sq_18d', 'sq_18e', 'sq_18f', 'sq_18g',
    'sq_18h', 'sq_18i', 'sq_19', 'sq_20', 'sq_21', 'sq_22',
    'sq_22a', 'sq_22b', 'sq_22c', 'sq_22d', 'sq_22e', 'sq_22f',
    'sq_22g', 'sq_22h', 'sq_23', 'mms_1', 'mms_1a', 'mms_1b',
    'mms_1c', 'mms_1d', 'mms_1e', 'mms_2', 'mms_2a', 'mms_2b',
    'mms_2c', 'mms_2d', 'mms_2e', 'mms_3', 'mms_3g', 'mms_3h',
    'mms_3i', 'mms_3j', 'recal_1', 'mms_4', 'mms_4a', 'mms_4b',
    'mms_4c', 'mms_4d', 'mms_4e', 'mms_4f', 'count', 'mms_4v',
    'mms_4va', 'mms_4vb', 'mms_4vc', 'mms_4vd', 'mms_4ve',
    'mms_4vf', 'num_calc', 'mms_5', 'mms_5a', 'mms_5b',
    'mms_5c', 'mms_5d', 'recal_2', 'mms_6', 'mms_6a', 'mms_6b',
    'mms_6c', 'object', 'mms_7', 'mms_8', 'mms_8a', 'mms_8b',
    'mms_8c', 'mms_8d', 'paper', 'mms_9', 'mms_10', 'mms_11',
    'mms_s_main', 'mms_s_alt', 'mms_total', 'mms_severity',
    'realm', 'realma', 'realmb', 'realmc', 'realmd', 'realme',
    'realmf', 'realmg', 'realmh', 'realmi', 'realm_s',
    'weight', 'weight_kg', 'height', 'height_meters', 'bmi',
    'weight_status', 'obese', 'overwt_obese', 'waist_c',
    'co', 'read_1', 'read_2', 'read_3', 'dem_1', 'dem_2',
    'dem_3', 'dem_4', 'dem_4a', 'dem_4b', 'dem_4c', 'dem_4d',
    'dem_4e', 'dem_4f', 'dem_5', 'dem_5a', 'dem_6', 'dem_6a',
    'dme_6b', 'dem_7', 'dem_7a', 'dem_7b', 'dem_7c', 'dem_7d',
    'dem_7e', 'any_health_insurance', 'dem_8', 'dem_9',
    'dem_10', 'dem_11', 'dem_12', 'dem_12a', 'dem_12b',
    'dem_12c', 'dem_12d', 'dem_12e', 'dem_12f', 'dem_12g',
    'dem_12h', 'dem_12i', 'dem_12j', 'dem_12k', 'dem_12l',
    'dem_13', 'dem_13a', 'dem_13b', 'dem_13c', 'dem_13d',
    'dem_13e', 'dem_13f', 'dem_13g', 'dem_13h', 'dem_13_val',
    'dem_14', 'dem_14a', 'dem_14b', 'dem_14c', 'dem_14d',
    'dem_14e', 'dem_14f', 'dem_14g', 'dem_14h', 'dem_14_val',
    'dem_15', 'dem_16', 'dem_17', 'dem_18', 'bh_1', 'bh_1y',
    'bh_1m', 'bh_1d', 'bh_2', 'bh_3', 'bh_4', 'bh_4y', 'bh_4m',
    'bh_4d', 'bh_5', 'bh_6', 'bh_7', 'bh_7y', 'bh_7m', 'bh_7w',
    'bh_8', 'bh_9', 'bh_10', 'bh_11a', 'bh_12a', 'bh_12aa',
    'bh_12ab', 'bh_12ac', 'bh_12ad', 'bh_12ae', 'bh_12af',
    'bh_12ag', 'bh_12ah', 'bh_12ai', 'bh_12aj', 'bh_12ak',
    'bh_12al', 'bh_13a', 'bh_13aa', 'bh_13ab', 'bh_13ac',
    'bh_13ad', 'bh_13ae', 'bh_13af', 'bh_13b', 'bh_13ba',
    'bh_13bb', 'bh_13bc', 'bh_13bd', 'bh_13be', 'bh_13bf',
    'bh_13bg', 'bh_13bh', 'bh_13c', 'bh_13ca', 'bh_13cb',
    'bh_13cc', 'bh_13cd', 'bh_13ce', 'bh_13cf', 'bh_13cg',
    'bh_13ch', 'bh_14', 'bh_14b', 'bh_14by', 'bh_14bm',
    'bh_14bw', 'bh_14bd', 'bh_15', 'bh_15a', 'bh_16', 'bh_17',
    'bh_17y', 'bh_17m', 'bh_17w', 'bh_18', 'bh_18b', 'bh_18ba',
    'bh_18bb', 'bh_18bc', 'bh_18bd', 'bh_18be', 'bh_18bf',
    'bh_18bg', 'bh_18bh', 'bh_18b1', 'bh_19', 'bh_20', 'sss_1',
    'sss_2', 'well_being_1', 'well_being_2', 'well_being_3',
    'phq_1', 'phq_1_dichot', 'phq_2', 'phq_2_dichot',
    'phq_3', 'phq_3_dichot', 'phq_4', 'phq_4_dichot',
    'phq_5', 'phq_5_dichot', 'phq_6', 'phq_6_dichot',
    'phq_7', 'phq_7_dichot', 'phq_8', 'phq_8_dichot', 'phq_9',
    'phq_10', 'phq_11', 'phq_12', 'phq_13', 'phq_14', 'phq_15',
    'phq_dep_total', 'phq_dep_dichot_total', 'phq_dep_symp',
    'phq_mdd', 'phq_gad_total', 'hs_1', 'hs_1_dichot', 'hs_2',
    'hs_3', 'hs_4', 'hs_5', 'hs_6', 'hs_7', 'hs_8', 'hs_9',
    'hs_10', 'hs_11', 'hs_12', 'hrq_1', 'hrq_2', 'hrq_3',
    's_2', 's_2a', 's_2b', 's_2c', 's_2d', 's_2e', 's_2f',
    's_2g', 's_2h', 'sr_3a', 'sr_3b', 'sr_3c', 'sr_3d',
    'sr_3e', 'sr_3f', 's_3', 's_4', 's_4a', 's_4b', 's_4c',
    's_4d', 's_4e', 's_4f', 's_4g', 's_4h', 's_5', 's_6',
    's_7', 's_7a', 's_7b', 's_7c', 's_7d', 's_7e', 's_7f',
    's_7g', 's_8', 's_8a', 's_8b', 's_8c', 's_8d', 's_8e',
    's_8f', 's_8g', 's_9', 's_9a', 's_9b', 's_9c', 's_9d',
    's_9e', 's_9f', 's_9g', 's_9h', 's_9i', 's_9j', 's_9k',
    's_9l', 's_9m', 's_9n', 's_9o', 's_9p', 's_9q', 's_9r',
    's_10', 's_11', 's_12', 's_13', 's_14', 's_14a', 's_14b',
    's_14c', 's_14d', 's_15', 's_16', 's_17', 's_18', 's_18a',
    's_18b', 's_18c', 's_18d', 's_18e', 's_18f', 's_18g',
    's_18h', 's_18i', 's_18j', 's_18k', 's_18l', 's_19',
    's_20', 's_21', 's_22', 's_23', 's_mental_hx', 's_24',
    's_24a', 's_24b', 's_24c', 's_24d', 's_24e', 's_24f',
    's_25a', 's_26a', 's_26aa', 's_26ab', 's_26ac', 's_26ad',
    's_26ae', 's_26af', 's_26ag', 's_25b', 's_26b', 's_26ba',
    's_26bb', 's_26bc', 's_26bd', 's_26be', 's_26bf', 's_26bg',
    's_25c', 's_26c', 's_26ca', 's_26cb', 's_26cc', 's_26cd',
    's_26ce', 's_26cf', 's_26cg', 's_25d', 's_26d', 's_26da',
    's_26db', 's_26dc', 's_26dd', 's_26de', 's_26df', 's_26dg',
    's_25e', 's_26e', 's_26ea', 's_26eb', 's_26ec', 's_26ed',
    's_26ee', 's_26ef', 's_26eg', 's_27', 's_28', 's_29',
    's_30', 's_30a', 's_30b', 's_30c', 's_30d', 's_30e',
    's_30f', 's_30g', 's_substance_hx', 's_31', 's_32',
    's_32a', 's_32b', 's_32c', 's_32d', 's_32e', 's_32f',
    's_32g', 's_32h', 's_32i', 's_substance_use', 's_33',
    's_34', 's_35', 's_36', 's_37', 's_38', 's_39a', 's_39b',
    's_40', 's_pain', 's_41', 's_42', 's_43', 's_43a', 's_43b',
    's_43c', 's_43d', 's_43e', 's_43f', 's_43g', 's_43h',
    's_43i', 'ds_1', 'ds_2', 'ds_3', 'ds_4', 'ds_5', 'ds_6',
    'ds_7', 'ds_8', 'ds_9', 'ds_10a', 'ds_10b', 'ds_10_val',
    'ds_11a', 'ds_11b', 'ds_11_val', 'ds_total', 'ds_cat',
    'ptsd_1', 'ptsd_2', 'ptsd_3', 'ptsd_4', 'ptsd_total',
    'ptsd_positive', 'brac_1', 'brac_2', 'brac_3', 'brac_4',
    'brac_5', 'brac_6', 'brac_7', 'brac_8', 'brac_9',
    'brac_10', 'brac_11', 't_1', 't_2', 't_3a', 't_3ay',
    't_3am', 't_3b', 't_4', 't_5', 't_5a1', 't_5a2', 't_5a3',
    't_5a4', 't_5a5', 't_5a6', 't_5_val', 't_6', 't_6a1',
    't_6a2', 't_6a3', 't_6a4', 't_6a5', 't_6a6', 't_6_val',
    't_7', 't_8', 't_9', 't_10', 't_11', 't_12', 't_12a',
    't_12b', 't_13', 't_14', 't_14a', 't_14b', 't_14c',
    't_14d', 't_14e', 't_14f', 't_14g', 't_14h', 't_14i',
    't_15', 't_16', 't_17', 't_18', 't_19', 't_20', 't_21',
    't_22', 't_23', 't_23a', 't_23b', 't_23c', 't_23d',
    't_23e', 't_23f', 't_23g', 't_23h', 't_24', 't_25',
    't_26a', 't_26aa', 't_26ab', 't_26ac', 't_26ad', 't_26ae',
    't_26af', 't_27', 't_28', 't_29', 't_30', 't_31', 't_31a',
    't_31b', 't_31c', 't_31d', 't_31e', 't_31f', 't_31g',
    't_31h', 't_31i', 't_31j', 't_31_b', 't_31ba', 't_31bb',
    't_31bc', 't_32', 't_33', 't_33a', 't_33b', 't_33c',
    't_33d', 't_33e', 't_33f', 't_33g', 't_33h', 't_33i',
    't_33j', 't_34', 't_35', 't_spouse', 't_36', 't_37',
    't_38', 't_39', 't_friends', 't_40', 'hsi_1', 'hsi_2',
    'hsi_score', 'hsi_cat', 'brs_1', 'brs_2', 'brs_2_dichot',
    'brs_3', 'brs_4', 'brs_4_dichot', 'brs_5', 'drinks',
    'af_1', 'af_2m', 'af_3tu', 'af_4w', 'af_5th', 'af_6f',
    'af_6sa', 'af_8su', 'af_1_val', 'af_1_heavy', 'af_9',
    'af_9a', 'af_9b', 'af_9c', 'af_9_val', 'af_9_binge',
    'totaldrinks', 'num_alc_abstinent_days',
    'num_drinking_days', 'ave_drinks_day',
    'heavy_drinking_days', 'greatest_drinks_1_day',
    'drinks_wk', 'num_days_using_drugs',
    'per_days_using_drugs', 'per_drug_abstinent_days',
    'drug_use_days_yr', 'drug_use_days_week', 'pbq_1', 'pbq_2',
    'pbq_3', 'pbq_4', 'pbq_5', 'pbq_6', 'pbq_7', 'pbq_total',
    'fss_1', 'fss_1_dichot', 'fss_2', 'fss_2_dichot', 'fss_3',
    'fss_3_dichot', 'fss_3a', 'fss_3a_dichot', 'fss_4',
    'fss_4_dichot', 'fss_5', 'fss_5_dichot', 'fss_total',
    'fss_cat', 'fss_cat_dichot', 'ms_1', 'ms_2', 'ms_3',
    'ms_4', 'cj_1', 'cj_2', 'cj_3', 'cj_4', 'cj_5', 'cj_6',
    'cj_7', 'cj_8', 'cj_9', 'cj_10', 'cj_11', 'cj_12', 'cj_13',
    'cj_14', 'cj_15', 'cj_16', 'cj_17', 'cj_18', 'cj_19',
    'cj_20', 'cj_21', 'cj_22', 'cj_23', 'cj_24', 'cj_25',
    'cj_26', 'cj_27', 'cj_28', 'cj_29', 'cj_30', 'cj_31',
    'cj_32', 'cj_33', 'cj_34', 'cj_35', 'cj_36', 'cj_37',
    'cj_38', 'cj_39', 'cj_40', 'cj_desire', 'cj_needs',
    'cj_satisfaction', 'cj_selfesteem', 'cj_hostility',
    'cj_risktaking', 'sb_1', 'sb_2', 'sb_3', 'sb_4', 'sb_5',
    'sb_6', 'sb_7', 'sb_7a', 'sb_7b', 'sb_7c', 'sb_7d',
    'sb_7e', 'sb_7f', 'sb_7g', 'sb_8', 'sb_9', 'dd_1',
    'dd_2', 'dd_3', 'dd_4', 'dd_5', 'dd_6', 'dd_7', 'dd_8',
    'dd_9', 'dd_10', 'dd_total', 'mmd_1a', 'mmd_1b', 'mmd_1c',
    'mmd_1d', 'mmd_1e', 'mmd_1f', 'mmd_1g', 'mmd_1h', 'mmd_1i',
    'mmd_1j', 'mmd_1k', 'mmd_total', 'mmd_2', 'mmd_3',
    'mmd_4', 'uls_1', 'uls_2', 'uls_3', 'uls_4', 'uls_5',
    'uls_6', 'uls_7', 'uls_8', 'uls_9', 'uls_10', 'uls_11',
    'uls_12', 'uls_13', 'uls_14', 'uls_15', 'uls_16', 'uls_17',
    'uls_18', 'uls_19', 'uls_20', 'uls_21', 'uls_total',
    'pv_1', 'pv_2', 'pv_3', 'ps_1', 'ps_2', 'ps_3', 'ps_4',
    'ps_total', 'dts_1', 'dts_2', 'dts_3', 'dts_4', 'dts_5',
    'dts_6', 'dts_7', 'dts_8', 'dts_9', 'dts_10', 'dts_11',
    'dts_12', 'dts_13', 'dts_14', 'dts_15', 'dts_16',
    'dts_tolerance', 'dts_absorption', 'dts_appraisal',
    'dts_regulation', 'dts_total', 'aq_1', 'aq_2', 'aq_3',
    'aq_4', 'aq_5', 'aq_6', 'aq_7', 'aq_8', 'aq_9', 'aq_10',
    'aq_11', 'aq_12', 'aq_physical', 'aq_verbal', 'aq_anger',
    'aq_hostility', 'aq_total', 'ces_1', 'ces_1_dichot',
    'ces_2', 'ces_2_dichot', 'ces_3', 'ces_3_dichot', 'ces_4',
    'ces_4_dichot', 'ces_5', 'ces_5_dichot', 'ces_6',
    'ces_6_dichot', 'ces_7', 'ces_7_dichot', 'ces_8',
    'ces_8_dichot', 'ces_9', 'ces_9_dichot', 'ces_10',
    'ces_10_dichot', 'ces_total', 'ces_dichot_total',
    'ces_dichot_cat', 'ces_cat', 'is_1', 'is_2', 'is_3',
    'is_4', 'is_5', 'is_6', 'is_7', 'is_8', 'is_9', 'is_10',
    'is_11', 'is_12', 'is_app', 'is_bel', 'is_tan', 'rp_1',
    'rp_2', 'lsn_1', 'lsn_2', 'lsn_3', 'lsn_4', 'lsn_5',
    'lsn_6', 'lsn_family', 'lsn_family_cat', 'lsn_friends',
    'lsn_friends_cat', 'lsn_total', 'lsn_total_cat',
    'num_days_homeless', 'per_days_homeless', 'num_days_home',
    'est_days_homeless_yr', 'avg_days_homeless_wk', 'r_1',
    'r_2', 'r_3', 'r_4', 'r_5', 'r_6', 'r_7', 'r_8', 'r_9',
    'r_10', 'r_11', 'r_11b', 'r_12', 'r_13', 'r_14', 'r_15',
    'r_15a', 'r_15b', 'r_15c', 'r_15d', 'r_15e', 'r_15f',
    'r_15g', 'r_15h', 'r_15i', 'r_15j', 'r_15k', 'r_15l',
    'r_15m', 'r_15n', 'r_15o', 'bpm_1', 'bpm_2', 'bpm_3',
    'bpm_4', 'bpm_5', 'bpm_5a', 'bpm_5b', 'bpm_5c',
    'bpm_5d', 'bpm_5e', 'bpm_5f', 'bpm_5g', 'tq_1_1',
    'tq_2_1', 'tq_3_2', 'tq_4_2', 'tq_5_3', 'tq_6_3',
    'tq_7_3', 'tq_8_3', 'tq_9_2', 'tq_10_2', 'yq_11_2',
    'tq_12_2', 'tq_13_2', 'tq_14_1', 'tq_15_3', 'tq_16_3',
    'tq_17_3', 'tq_18_3', 'ddt_k', 'ddt_ed50', 'vac_1',
    'vac_2', 'vac_2y', 'vac_2m', 'vac_2d', 'vac_3', 'vac_3y',
    'vac_3m', 'vac_3d', 'arrest_count_since_prev_visit',
    'bridge_reg_sessions', 'bridge_crisis_sessions',
    'bridge_other_sessions', 'bridge_total_sessions',
    'bridge_reg_minutes', 'bridge_crisis_minutes',
    'bridge_total_minutes', 'bridge_other_minutes',
    'bridge_reg_avg_duration', 'bridge_crisis_avg_duration',
    'bridge_other_avg_duration', 'bridge_total_avg_duration',
    'bridge_post_visits_reg_sessions',
    'bridge_post_visits_crisis_sessions',
    'bridge_post_visits_other_sessions',
    'bridge_post_visits_total_sessions',
    'bridge_post_visits_reg_minutes',
    'bridge_post_visits_crisis_minutes',
    'bridge_post_visits_other_minutes',
    'bridge_post_visits_total_minutes',
    'bridge_post_visits_reg_avg_duration',
    'bridge_post_visits_crisis_avg_duration',
    'bridge_post_visits_other_avg_duration',
    'bridge_post_visits_total_avg_duration'
      )
  )
# TRUE
```

We purged the import path for memory management.

```{r}
rm(combined_data_path)
```

## Variable Map

We imported our Variable Map.

```{r}
variable_map_path <- here(
  "data", "Combined Participant Data", "variable_map_02.rds"
  )
```

Import the data.
Check the most recent file modification dates and print for user when this file is being sourced.

```{r message=FALSE}
variable_map <- readRDS(variable_map_path)

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "Variable Map imported with", nrow(variable_map), "rows and", 
  ncol(variable_map), "columns.\n"
)

# Check the most recent file modification dates and print for user when this
# file is being sourced.

cat(
      "Variable Map data last modified on OneDrive", 
      as.character(file.info(variable_map_path)$mtime), "\n"
    )

# 2023-10-23: Variable Map imported with 1083 rows and 22 columns.
# Variable Map data last modified on OneDrive 2023-10-23 10:56:54 
```

#### Data Check: Changes

We ensured our Variable Map met our required minimum format.

```{r}
vm_check(variable_map)
# TRUE
```

We checked for changes to the source data set since this file was last modified.

```{r}
# Inputs last modified: 2023-10-23

data_mod_check(
  'df' = variable_map,
  'df_path_str' = variable_map_path,
  'orig_path_str' = here(
      "data", "Combined Participant Data", "variable_map_02.rds"
      ),
  'mod_dt' = '2023-10-23 10:56:54 CDT',
  'num_rows' = 1083,
  'num_cols' = 21,
  'col_names' = c(
      'variable', 'section', 'sec_ord', 'instrument', 'inst_ord', 'item_ord',
      'qds_v1', 'qds_v2', 'qds_v3', 'qds_v4', 'qds_v5', 'redcap',
      'master_log', 'tlfb', 'ddt', 'arrest', 'bridge', 'attr_label',
      'attr_var_labels', 'drop_consolidated', 'calculated'
      )
  )
# TRUE
```

We purged the import path for memory management.

```{r}
rm(variable_map_path)
```

# Flagging PHI Variables

We created a new variable within our data set, which would allow us to flag any variable that contained PHI.

```{r}
variable_map <- variable_map %>%
  add_column(phi = FALSE)

attributes(variable_map$phi)$label <- "Is this variable PHI?"
```

We identified the variables containing the subject's name or date of birth as PHI.

```{r}
phi_vars <- c('name_first', 'name_last', 'name_middle', 'ml_dob')

variable_map <- variable_map %>%
  mutate(phi = ifelse((variable %in% phi_vars), TRUE, phi))

rm(phi_vars)
```

# Renaming Variables

While our initial variable names were useful in pre-processing, the majority of these variable names were not descriptive.
To maintain the usefulness of the Variable Map in tracing processing changes for variables, we created a new column, `final_variable`.

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = variable)

attributes(variable_map$final_variable)$label <- paste(
  "Finalized Variable Names"
)
```

We then manually sorted through our variables and created our desired variable names.

    
    
## Converting Single-Digits to Double-Digits

We could adjust the numerical components of variable names in aggregate.

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = stringr::str_replace_all(variable, 
                                             "\\d+", 
                                             function(m) 
                                               sprintf("%02d", as.integer(m))
                                             )
         )
```

## Administrative Section

We manually inspected and renamed variables from the Administrative Section.

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'subject' ~ 'id',
    variable == 'today' ~ 'visit_date',
    variable == 'ii' ~ 'interviewer',
    variable == 'name_first' ~ 'subj_name_first',
    variable == 'name_middle' ~ 'subj_name_middle',
    variable == 'name_last' ~ 'subj_name_last',
    variable == 'ctime' ~ 'time_start',
    variable == 'endtime' ~ 'time_end',
    variable == 'maca_mdd_timestamp' ~ 'time_mdd_start',
    variable == 'maca_mdd_complete' ~ 'time_mdd_end',
    variable == 'ps_timestamp' ~ 'time_ps_start',
    variable == 'ps_complete' ~ 'time_ps_end',
    variable == 'email' ~ 'subj_email',
    variable == 'days_followed' ~ 'tlfb_days_followed',
    variable == 'flag_outofwindow' ~ 'tlfb_flag_outofwindow',
    variable == 'v2_status' ~ 'subj_randomized_status',
    TRUE ~ variable
    ))
```

## Screening Section

We manually reviewed and renamed variables from the Screening Instrument.

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'gender' ~ 'sq_01_subj_gender',
    variable == 'ml_gender' ~ 'sq_01_subj_gender_ml',
    variable == 'sq_2' ~ 'sq_02_subj_hispanic',
    variable == 'ml_hispanic_latino' ~ 'sq_02_subj_hispanic_ml',
    variable == 'sq_3' ~ 'sq_03_subj_race',
    variable == 'ml_race' ~ 'sq_03_subj_race_ml',
    variable == 'sq_4' ~ 'sq_04_subj_age',
    variable == 'ml_dob' ~ 'sq_04_subj_dob_ml',
    variable == 'ml_age' ~ 'sq_04_subj_age_ml',
    variable == 'sq_5' ~ 'sq_05_residency',
    variable == 'sq_6' ~ 'sq_06_english',
    variable == 'sq_7' ~ 'sq_07_recent_release',
    variable == 'sq_7a' ~ 'sq_07a_release',
    variable == 'sq_7b' ~ 'sq_07b_flier_num',
    variable == 'sq_7c' ~ 'sq_07c_other_proof',
    variable == 'sq_7d' ~ 'sq_07d_verified',
    variable == 'sq_8' ~ 'sq_08_homeless',
    variable == 'sq_9' ~ 'sq_09_slept_loc',
    variable == 'sq_9l' ~ 'sq_09l_shelter',
    variable == 'sq_10' ~ 'sq_10_bridge_enrolled',
    variable == 'sq_11' ~ 'sq_11_willing',
    variable == 'sq_12' ~ 'sq_12_cellphone_has',
    variable == 'sq_13' ~ 'sq_13_cellphone_payer',
    variable == 'sq_14' ~ 'sq_14_cellphone_talkmins',
    variable == 'sq_15' ~ 'sq_15_cellphone_smart',
    variable == 'sq_16' ~ 'sq_16_cellphone_data',
    variable == 'sq_17' ~ 'sq_17_cellphone_change',
    variable == 'sq_18' ~ 'sq_18_media',
    variable == 'sq_18a' ~ 'sq_18_media_email',
    variable == 'sq_18b' ~ 'sq_18_media_fb',
    variable == 'sq_18c' ~ 'sq_18_media_google',
    variable == 'sq_18d' ~ 'sq_18_media_twitter',
    variable == 'sq_18e' ~ 'sq_18_media_blogs',
    variable == 'sq_18f' ~ 'sq_18_media_instagram',
    variable == 'sq_18g' ~ 'sq_18_media_snapchat',
    variable == 'sq_18h' ~ 'sq_18_media_linkedin',
    variable == 'sq_18i' ~ 'sq_18_media_none',
    variable == 'sq_19' ~ 'sq_19_internet_freq',
    variable == 'sq_20' ~ 'sq_20_fb_active',
    variable == 'sq_21' ~ 'sq_21_fb_freq',
    variable == 'sq_22' ~ 'sq_22_id',
    variable == 'sq_22a' ~ 'sq_22_id_dl',
    variable == 'sq_22b' ~ 'sq_22_id_ss',
    variable == 'sq_22c' ~ 'sq_22_id_govt',
    variable == 'sq_22d' ~ 'sq_22_id_birth',
    variable == 'sq_22e' ~ 'sq_22_id_passport',
    variable == 'sq_22f' ~ 'sq_22_id_military',
    variable == 'sq_22g' ~ 'sq_22_id_bridge',
    variable == 'sq_22h' ~ 'sq_22_id_other',
    variable == 'sq_23' ~ 'sq_23_consent',
    TRUE ~ variable
    ))
```

We manually reviewed and renamed variables from the Mini-Mental State Exam

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'mms_1' ~ 'mms_01_time',
    variable == 'mms_1a' ~ 'mms_01_time_year',
    variable == 'mms_1b' ~ 'mms_01_time_season',
    variable == 'mms_1c' ~ 'mms_01_time_date',
    variable == 'mms_1d' ~ 'mms_01_time_day',
    variable == 'mms_1e' ~ 'mms_01_time_month',
    variable == 'mms_2' ~ 'mms_02_loc',
    variable == 'mms_2a' ~ 'mms_02_loc_state',
    variable == 'mms_2b' ~ 'mms_02_loc_county',
    variable == 'mms_2c' ~ 'mms_02_loc_city',
    variable == 'mms_2d' ~ 'mms_02_loc_bldg',
    variable == 'mms_2e' ~ 'mms_02_loc_floor',
    variable == 'mms_3' ~ 'mms_03_word',
    variable == 'mms_3g' ~ 'mms_03_word_penny',
    variable == 'mms_3h' ~ 'mms_03_word_apple',
    variable == 'mms_3i' ~ 'mms_03_word_table',
    variable == 'mms_3j' ~ 'mms_03_word_none',
    variable == 'recal_1' ~ 'mms_03_word_score',
    variable == 'mms_4' ~ 'mms_04a_count',
    variable == 'mms_4a' ~ 'mms_04a_count_93',
    variable == 'mms_4b' ~ 'mms_04a_count_86',
    variable == 'mms_4c' ~ 'mms_04a_count_79',
    variable == 'mms_4d' ~ 'mms_04a_count_72',
    variable == 'mms_4e' ~ 'mms_04a_count_65',
    variable == 'mms_4f' ~ 'mms_04a_count_none',
    variable == 'count' ~ 'mms_04a_count_score',
    variable == 'mms_4v' ~ 'mms_04b_world',
    variable == 'mms_4va' ~ 'mms_04b_world_d',
    variable == 'mms_4vb' ~ 'mms_04b_world_l',
    variable == 'mms_4vc' ~ 'mms_04b_world_r',
    variable == 'mms_4vd' ~ 'mms_04b_world_o',
    variable == 'mms_4ve' ~ 'mms_04b_world_w',
    variable == 'mms_4vf' ~ 'mms_04b_world_none',
    variable == 'num_calc' ~ 'mms_04b_world_score',
    variable == 'mms_4v' ~ 'mms_04b_world',
    variable == 'mms_5' ~ 'mms_05_word2',
    variable == 'mms_5a' ~ 'mms_05_word2_penny',
    variable == 'mms_5b' ~ 'mms_05_word2_apple',
    variable == 'mms_5c' ~ 'mms_05_word2_table',
    variable == 'mms_5d' ~ 'mms_05_word2_none',
    variable == 'recal_2' ~ 'mms_05_word2_score',
    variable == 'mms_6' ~ 'mms_06_obj',
    variable == 'mms_6a' ~ 'mms_06_obj_pen',
    variable == 'mms_6b' ~ 'mms_06_obj_door',
    variable == 'mms_6c' ~ 'mms_06_obj_none',
    variable == 'object' ~ 'mms_06_obj_score',
    variable == 'mms_7' ~ 'mms_07_phrase',
    variable == 'mms_8' ~ 'mms_08_paper',
    variable == 'mms_8a' ~ 'mms_08_paper_hand',
    variable == 'mms_8b' ~ 'mms_08_paper_fold',
    variable == 'mms_8c' ~ 'mms_08_paper_floor',
    variable == 'mms_8d' ~ 'mms_08_paper_none',
    variable == 'paper' ~ 'mms_08_paper_score',
    variable == 'mms_9' ~ 'mms_09_read',
    variable == 'mms_10' ~ 'mms_10_write',
    variable == 'mms_11' ~ 'mms_11_copy',
    TRUE ~ variable
    ))
```

We manually reviewed and renamed variables from the REALM

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'realm' ~ 'realm',
    variable == 'realma' ~ 'realm_01_fat',
    variable == 'realmb' ~ 'realm_02_flu',
    variable == 'realmc' ~ 'realm_03_behav',
    variable == 'realmd' ~ 'realm_04_exerc',
    variable == 'realme' ~ 'realm_05_menop',
    variable == 'realmf' ~ 'realm_06_rectal',
    variable == 'realmg' ~ 'realm_07_antib',
    variable == 'realmh' ~ 'realm_08_anemia',
    variable == 'realmi' ~ 'realm_09_jaund',
    TRUE ~ variable
    ))
```

We added the prefix 'anth_' to all anthropometric variables.

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = ifelse(
      (section == "Screening" & instrument == "Anthropometrics"),
      paste0('anth_', variable),
      variable
      )
    )
```

We manually reviewed and renamed variables from the Demographic Questionnaire

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'dem_1' ~ 'dem_01_marital',
    variable == 'dem_2' ~ 'dem_02_children',
    variable == 'dem_3' ~ 'dem_03_race',
    variable == 'dem_4' ~ 'dem_04_mrace',
    variable == 'dem_4a' ~ 'dem_04_mrace_white',
    variable == 'dem_4b' ~ 'dem_04_mrace_black',
    variable == 'dem_4c' ~ 'dem_04_mrace_asian',
    variable == 'dem_4d' ~ 'dem_04_mrace_pi',
    variable == 'dem_4e' ~ 'dem_04_mrace_ai',
    variable == 'dem_4f' ~ 'dem_04_mrace_other',
    variable == 'dem_5' ~ 'dem_05_edu',
    variable == 'dem_5a' ~ 'dem_05_edu_hs_ged',
    variable == 'dem_6' ~ 'dem_06_empl',
    variable == 'dem_6a' ~ 'dem_06_empl_hours',
    variable == 'dem_6b' ~ 'dem_06_empl_week',
    variable == 'dem_7' ~ 'dem_07_ins',
    variable == 'dem_7a' ~ 'dem_07_ins_medicare',
    variable == 'dem_7b' ~ 'dem_07_ins_medicaid',
    variable == 'dem_7c' ~ 'dem_07_ins_military',
    variable == 'dem_7d' ~ 'dem_07_ins_private',
    variable == 'dem_7e' ~ 'dem_07_ins_none',
    variable == 'any_health_insurance' ~ 'dem_07_ins_any',
    variable == 'dem_8' ~ 'dem_08_ss',
    variable == 'dem_9' ~ 'dem_09_ss_amt',
    variable == 'dem_10' ~ 'dem_10_foodstamps',
    variable == 'dem_11' ~ 'dem_11_foodstamps_amt',
    variable == 'dem_12' ~ 'dem_12_inc',
    variable == 'dem_12a' ~ 'dem_12_inc_work',
    variable == 'dem_12b' ~ 'dem_12_inc_crime',
    variable == 'dem_12c' ~ 'dem_12_inc_disab',
    variable == 'dem_12d' ~ 'dem_12_inc_benefit',
    variable == 'dem_12e' ~ 'dem_12_inc_selfemp',
    variable == 'dem_12f' ~ 'dem_12_inc_sex',
    variable == 'dem_12g' ~ 'dem_12_inc_drugs',
    variable == 'dem_12h' ~ 'dem_12_inc_social',
    variable == 'dem_12i' ~ 'dem_12_inc_student',
    variable == 'dem_12j' ~ 'dem_12_inc_support',
    variable == 'dem_12k' ~ 'dem_12_inc_other',
    variable == 'dem_12l' ~ 'dem_12_inc_none',
    variable == 'dem_13' ~ 'dem_13_income',
    variable == 'dem_13a' ~ 'dem_13_income_a',
    variable == 'dem_13b' ~ 'dem_13_income_b',
    variable == 'dem_13c' ~ 'dem_13_income_c',
    variable == 'dem_13d' ~ 'dem_13_income_d',
    variable == 'dem_13e' ~ 'dem_13_income_e',
    variable == 'dem_13f' ~ 'dem_13_income_f',
    variable == 'dem_13g' ~ 'dem_13_income_g',
    variable == 'dem_13h' ~ 'dem_13_income_h',
    variable == 'dem_13_val' ~ 'dem_13_income_val',
    variable == 'dem_14' ~ 'dem_14_income_mnth',
    variable == 'dem_14a' ~ 'dem_14_income_mnth_a',
    variable == 'dem_14b' ~ 'dem_14_income_mnth_b',
    variable == 'dem_14c' ~ 'dem_14_income_mnth_c',
    variable == 'dem_14d' ~ 'dem_14_income_mnth_d',
    variable == 'dem_14e' ~ 'dem_14_income_mnth_e',
    variable == 'dem_14f' ~ 'dem_14_income_mnth_f',
    variable == 'dem_14g' ~ 'dem_14_income_mnth_g',
    variable == 'dem_14h' ~ 'dem_14_income_mnth_h',
    variable == 'dem_14_val' ~ 'dem_14_income_mnth_val',
    variable == 'dem_15' ~ 'dem_15_veteran',
    variable == 'dem_16' ~ 'dem_16_minority',
    variable == 'dem_17' ~ 'dem_17_sex_orientation',
    variable == 'dem_18' ~ 'dem_18_transgender',
    TRUE ~ variable
    ))
```

We manually reviewed and renamed variables from the Brief Homelessness Questionnaire

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'bh_1' ~ 'bh_01_time_lifetime',
    variable == 'bh_1y' ~ 'bh_01_time_lifetime_year',
    variable == 'bh_1m' ~ 'bh_01_time_lifetime_month',
    variable == 'bh_1d' ~ 'bh_01_time_lifetime_day',
    variable == 'bh_2' ~ 'bh_02_num_times',
    variable == 'bh_3' ~ 'bh_03_age_first',
    variable == 'bh_4' ~ 'bh_04_time_recent',
    variable == 'bh_4y' ~ 'bh_04_time_recent_year',
    variable == 'bh_4m' ~ 'bh_04_time_recent_month',
    variable == 'bh_4d' ~ 'bh_04_time_recent_day',
    variable == 'bh_5' ~ 'bh_05_num_childhood',
    variable == 'bh_6' ~ 'bh_06_num_3yrs',
    variable == 'bh_7' ~ 'bh_07_bridge_time',
    variable == 'bh_7y' ~ 'bh_07_bridge_time_year',
    variable == 'bh_7m' ~ 'bh_07_bridge_time_month',
    variable == 'bh_7w' ~ 'bh_07_bridge_time_week',
    variable == 'bh_8' ~ 'bh_08_attend_sub',
    variable == 'bh_9' ~ 'bh_09_mh_treatmnt',
    variable == 'bh_10' ~ 'bh_10_mh_treatmnt_type',
    variable == 'bh_11a' ~ 'bh_11_time_shelter',
    variable == 'bh_12a' ~ 'bh_12_reasons',
    variable == 'bh_12aa' ~ 'bh_12_reasons_na',
    variable == 'bh_12ab' ~ 'bh_12_reasons_unempl',
    variable == 'bh_12ac' ~ 'bh_12_reasons_evicted',
    variable == 'bh_12ad' ~ 'bh_12_reasons_substance',
    variable == 'bh_12ae' ~ 'bh_12_reasons_mh',
    variable == 'bh_12af' ~ 'bh_12_reasons_med_bills',
    variable == 'bh_12ag' ~ 'bh_12_reasons_family',
    variable == 'bh_12ah' ~ 'bh_12_reasons_legal',
    variable == 'bh_12ai' ~ 'bh_12_reasons_reint',
    variable == 'bh_12aj' ~ 'bh_12_reasons_disaster',
    variable == 'bh_12ak' ~ 'bh_12_reasons_dv',
    variable == 'bh_12al' ~ 'bh_12_reasons_other',
    variable == 'bh_13a' ~ 'bh_13_arrests_drug_count',
    variable == 'bh_13aa' ~ 'bh_13_arrests_drug_pos',
    variable == 'bh_13ab' ~ 'bh_13_arrests_drug_dist',
    variable == 'bh_13ac' ~ 'bh_13_arrests_drug_dui',
    variable == 'bh_13ad' ~ 'bh_13_arrests_drug_disord',
    variable == 'bh_13ae' ~ 'bh_13_arrests_drug_loiter',
    variable == 'bh_13af' ~ 'bh_13_arrests_drug_none',
    variable == 'bh_13b' ~ 'bh_13_arrests_theft_count',
    variable == 'bh_13ba' ~ 'bh_13_arrests_theft_forgery',
    variable == 'bh_13bb' ~ 'bh_13_arrests_theft_theft',
    variable == 'bh_13bc' ~ 'bh_13_arrests_theft_mvtheft',
    variable == 'bh_13bd' ~ 'bh_13_arrests_theft_robbery',
    variable == 'bh_13be' ~ 'bh_13_arrests_theft_fraud',
    variable == 'bh_13bf' ~ 'bh_13_arrests_theft_burglary',
    variable == 'bh_13bg' ~ 'bh_13_arrests_theft_prost',
    variable == 'bh_13bh' ~ 'bh_13_arrests_theft_none',
    variable == 'bh_13c' ~ 'bh_13_arrests_viol_count',
    variable == 'bh_13ca' ~ 'bh_13_arrests_viol_dv',
    variable == 'bh_13cb' ~ 'bh_13_arrests_viol_assault',
    variable == 'bh_13cc' ~ 'bh_13_arrests_viol_rape',
    variable == 'bh_13cd' ~ 'bh_13_arrests_viol_sex',
    variable == 'bh_13ce' ~ 'bh_13_arrests_viol_weap',
    variable == 'bh_13cf' ~ 'bh_13_arrests_viol_murder',
    variable == 'bh_13cg' ~ 'bh_13_arrests_viol_arson',
    variable == 'bh_13ch' ~ 'bh_13_arrests_viol_none',
    variable == 'bh_14' ~ 'bh_14_new_arrests',
    variable == 'bh_14b' ~ 'bh_14_new_arrest_dur',
    variable == 'bh_14by' ~ 'bh_14_new_arrest_dur_year',
    variable == 'bh_14bm' ~ 'bh_14_new_arrest_dur_month',
    variable == 'bh_14bw' ~ 'bh_14_new_arrest_dur_week',
    variable == 'bh_14bd' ~ 'bh_14_new_arrest_dur_day',
    variable == 'bh_15' ~ 'bh_15_incarc_count',
    variable == 'bh_16' ~ 'bh_16_incarc_intent_count',
    variable == 'bh_17' ~ 'bh_17_incarc_time',
    variable == 'bh_17y' ~ 'bh_17_incarc_time_year',
    variable == 'bh_17m' ~ 'bh_17_incarc_time_month',
    variable == 'bh_17w' ~ 'bh_17_incarc_time_week',
    variable == 'bh_18' ~ 'bh_18_supv_now',
    variable == 'bh_18b' ~ 'bh_18_supv',
    variable == 'bh_18ba' ~ 'bh_18_supv_prob',
    variable == 'bh_18bb' ~ 'bh_18_supv_parole',
    variable == 'bh_18bc' ~ 'bh_18_supv_ptr',
    variable == 'bh_18bd' ~ 'bh_18_supv_dtc',
    variable == 'bh_18be' ~ 'bh_18_supv_other_court',
    variable == 'bh_18bf' ~ 'bh_18_supv_none',
    variable == 'bh_18bg' ~ 'bh_18_supv_other',
    variable == 'bh_18b1' ~ 'bh_18_supv_other_txt',
    variable == 'bh_19' ~ 'bh_19_felony',
    variable == 'bh_20' ~ 'bh_20_conv_innocent',
    TRUE ~ variable
    ))
```

We manually reviewed and renamed variables from the MacArthur Scale of Subjective Social Status

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'sss_1' ~ 'sss_01_community',
    variable == 'sss_2' ~ 'sss_02_usa',
    variable == 'well_being_1' ~ 'sss_03_now',
    variable == 'well_being_2' ~ 'sss_04_5yrs',
    variable == 'well_being_3' ~ 'sss_05_financial',
    TRUE ~ variable
    ))
```

## Other

We manually reviewed and renamed a typo-laden variable in the Treatment Quality Instrument.

```{r}
variable_map <- variable_map %>%
  mutate(final_variable = case_when(
    variable == 'yq_11_2' ~ 'tq_11_02',
    TRUE ~ variable
    ))
```

# Ordering and Labeling Variables

We ordered the variables within our variable map, filtered to only include variables present in our current combined data set, and isolated the variables. We used this ordered list to order the columns in our combined data set.

```{r}
variable_order <- pull(
  variable_map %>%
    arrange(sec_ord, inst_ord, item_ord) %>%
    filter(variable %in% colnames(combined_data)) %>%
    select(variable)
  )

combined_data <- combined_data[ ,variable_order]
```

Since the order was enforced, we were able to use this to rename all of our variables to our desired final variable names, in aggregate.

```{r}
final_variables <- pull(
  variable_map %>%
    arrange(sec_ord, inst_ord, item_ord) %>%
    filter(variable %in% colnames(combined_data)) %>%
    select(final_variable)
  )

colnames(combined_data) <- final_variables
```

We ensured the variables in our processed data set had our desired label and value labels attributes.

```{r}
for (var_name in colnames(combined_data)){
  attributes(
    combined_data[[var_name]]
    )$label <- pull(
      variable_map[variable_map$final_variable == var_name, 'attr_label']
      )
   attributes(
     combined_data[[var_name]]
     )$labels <- pull(
       variable_map[variable_map$final_variable == var_name, 'attr_var_labels']
       )[[1]] 
}
```

We purged the remaining variables for memory management.

```{r}
rm(drop_vars)
rm(i)
rm(new_var_i)
rm(prev_var_i)
rm(survey_vars)
rm(var_name)
rm(variable_order)
rm(final_variables)
```

# üíæ Saving the Variable Map

## Combined Data

```{r}
# RDS

combined_data_path <- here(
  "data", "Combined Participant Data", "combined_data_03.rds"
  )

write_rds(combined_data, combined_data_path)
```

We purged the related variables to reduce memory burden and protect against memory leak.

```{r}
rm(combined_data_path)
rm(combined_data)
```

## Variable Map

```{r}
# RDS

variable_map_path <- here(
  "data", "Combined Participant Data", "variable_map_03.rds"
  )

write_rds(variable_map, variable_map_path)

# EXCEL

 variable_map_path <- here(
   "data", "Combined Participant Data", "variable_map_03.xlsx"
   )

# Ensure labels are character to enable writing to EXCEL file

variable_map <- variable_map %>%
  mutate(attr_var_labels = as.character(attr_var_labels))
 
write.xlsx(variable_map, variable_map_path)
```

We purged the related variables to reduce memory burden and protect against memory leak.

```{r}
rm(variable_map_path)
rm(variable_map)
```

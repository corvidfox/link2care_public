---
title: "Step 4 - Consolidating and Calculating Variables"
date: "2022-10-20 <br> Updated: `r Sys.Date()`"
format: pdf
editor: 
  markdown: 
    wrap: sentence
---

# ‚≠êÔ∏èOverview

This file is step 4 in processing the source data from Link2Care (L2C) into a single data set for analysis.

This file involves consolidating redundant variables within the combined data set, and recreation of calculated variables.

[Notes on cleaning individual L2C data sets for merging](https://github.com/brad-cannell/link2care_public/wiki/Notes-on-cleaning-individual-L2C-data-sets-for-merging)

## Process Steps

1.  Pre-process DDT, Arrest, and Bridge Session Minutes data sets so they are compatible with a long-format Subject-Visit composite key structure

2.  Import all source data sets (QDS, REDCap, Master Log, TLFB, DDT, Arrest, Bridge Sessions) to create the variable map

    -   Select variables for inclusion in the final composite data set

    -   Set initial standardization of the variable names for all desired variables in the composite data set

    -   Establish order for the variables in the composite data set

    -   Extract variable label and variable value labels from source data sets to be included in the composite data set

3.  Batch processing of data sets into combined data set

4.  **Recreation of calculated variables**

    -   Consolidating redundant variables
    
    -   Creation of calculated variables, including labels and addition to the variable map

5.  Post-processing modifications

    -  Finalize desired variable names
    
    -  Flag PHI variables


## Notes

Several variables were identified during Step 1 (data_survey_01_preprocess.qmd) which were either redundant (appeared several times and collected identical data) or calculated in SPSS. In this file, we aim to :

-   Consolidating the redundant variables into a single variable

-   Re-create the calculated variables that were dropped in original processing

-   Ensure all dropped or calculated variables are adequately represented in the variable map

# üì¶Load packages & Functions

```{r, message=FALSE, warning=FALSE}
library(dplyr, warn.conflicts = FALSE)
library(purrr, warn.conflicts = FALSE)
library(haven, warn.conflicts = FALSE)
library(here, warn.conflicts = FALSE)
library(stringr, warn.conflicts = FALSE)
library(lubridate, warn.conflicts = FALSE)
library(readxl, warn.conflicts = FALSE)
library(openxlsx, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)
library(tidyverse, warn.conflicts = FALSE)
```

```{r}
source(here::here("R", "data_cols.R"))
source(here::here("R", "standardize_col_names.R"))
source(here::here("R", "flag_unmatching_variables.R"))
source(here::here("R", "vm_make_source_map.R"))
source(here::here("R", "vm_check.R"))
source(here::here("R", "vm_create_for_instrument.R"))
source(here::here("R", "vm_join_inst_section.R"))
source(here::here("R", "vm_join_sections.R"))
source(here::here("R", "vm_add_variable.R"))
source(here::here("R", "vm_delete_variable.R"))
source(here::here("R", "vm_process_source_df.R"))
source(here::here("R", "vm_process_many_source.R"))
source(here::here("R", "data_mod_check.R"))
```

# üì• Import data

## Combined Data Set

We imported our Combined Data Set

```{r}
combined_data_path <- here::here(
  "data", "Combined Participant Data", "combined_data_01.rds"
  )
```

Import the data.
Check the most recent file modification dates and print for user when this file is being sourced.

```{r message=FALSE}
combined_data <- readr::read_rds(combined_data_path)

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "Combined data imported with", nrow(combined_data), "rows and", 
  ncol(combined_data), "columns.\n"
)

# Check the most recent file modification dates and print for user when this
# file is being sourced.

cat(
      "Combined data last modified on OneDrive", 
      as.character(file.info(combined_data_path)$mtime), "\n"
    )

# 2024-01-11: Combined data imported with 1606 rows and 1020 columns.
# Combined data last modified on OneDrive 2023-12-13 13:39:20
```

#### Data Check: Changes

We checked for changes to the source data set since this file was last modified.

```{r}
# Inputs last modified: 2024-01-08

data_stats <- retrieve_data_stats("combined_data_01_stats")

data_mod_check(
  df = combined_data,
  df_path_str = combined_data_path,
  orig_path_str = data_stats$rds_path,
  mod_dt = data_stats$mod_dt,
  num_cols = data_stats$num_cols,
  num_rows = data_stats$num_rows,
  col_names = data_stats$cols
  )
# TRUE
```

We purged the import path for memory management.

```{r}
rm(combined_data_path)
```

## Variable Map

We imported our Variable Map.

```{r}
variable_map_path <- here::here(
  "data", "Combined Participant Data", "variable_map_01.rds"
  )
```

Import the data.
Check the most recent file modification dates and print for user when this file is being sourced.

```{r message=FALSE}
variable_map <- readr::read_rds(variable_map_path)

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "Variable Map imported with", nrow(variable_map), "rows and", 
  ncol(variable_map), "columns.\n"
)

# Check the most recent file modification dates and print for user when this
# file is being sourced.

cat(
      "Variable Map data last modified on OneDrive", 
      as.character(file.info(variable_map_path)$mtime), "\n"
    )

# 2024-01-11: Variable Map imported with 979 rows and 19 columns.
# Variable Map data last modified on OneDrive 2023-12-13 13:26:57
```

#### Data Check: Changes

We ensured our Variable Map met our required minimum format.

```{r}
vm_check(variable_map)
# TRUE
```

We checked for changes to the source data set since this file was last modified.

```{r}
# Inputs last modified: 2024-01-08

data_stats <- retrieve_data_stats("variable_map_01_stats")

data_mod_check(
  df = variable_map,
  df_path_str = variable_map_path,
  orig_path_str = data_stats$rds_path,
  mod_dt = data_stats$mod_dt,
  num_cols = data_stats$num_cols,
  num_rows = data_stats$num_rows,
  col_names = data_stats$cols
  )
# TRUE
```

We purged the import path for memory management.

```{r}
rm(variable_map_path)
```

## Excel Master Log 

We imported the master log data, manually assigning column names and types. 

The Master Log was our only source of several demographic variables, such as subject name, subject date of birth, subject age, and subject care manager. It was also the only source of variables relating to subject continuation vs drop status, or if the research team determined the subject should be omitted from analyses.

The Master Log was also our most reliable source of subject group assignment.

We imported our Master Log with all of these variables.

```{r}
master_log_path  <- here::here("data", "master_log", "master_log.xlsx")
```

Import the data.
Check the most recent file modification dates and print for user when this file is being sourced.

```{r}
master_log <- readxl::read_excel(
  master_log_path, 
  sheet = "Screened In",
  col_names = c(
    "id", "baseline_dt",
    "v2_sched", "v2_dt", "v2_late", "v2_noshow",
    "v3_sched", "v3_dt", "v3_late", "v3_noshow",
    "v4_sched", "v4_dt", "v4_late", "v4_noshow",
    "v5_sched", "v5_dt", "v5_late", "v5_noshow", 
    "group", "v2_status", "dropped_status", 
    "name_first", "name_middle", "name_last",
    "gender", "race", "hispanic_latino", "dob", "age", "care_manager", 
    "v1_attend", "v2_attend", "v3_attend", "v4_attend", "v5_attend"
    ),
  col_types = c(
    "text", "skip", "date", "skip",
    rep("date",2), rep("text",2), "skip",
    rep("date",2), rep("text",2), "skip",
    rep("date",2), rep("text",2), "skip",
    rep("date",2), rep("text",2), 
    rep("text", 3),
    rep("text", 3),
    rep("text", 5),
    rep("skip", 5), "text",
    rep("text", 5), rep("skip", 10)
                ),
  skip = 1
) |> 
  # Coerce group to numeric so that it can be combined with the QDS data.
  dplyr::mutate(
    group = dplyr::case_when(
      group == "UCM"    ~ 1,
      group == "UCM+SP" ~ 2,
      group == "L2C"    ~ 3
    )
  ) |>
  # Coerce age to a numeric
  dplyr::mutate(age = as.numeric(age)) |>
  # Remove empty rows
  dplyr::filter(!is.na(id))

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "Master log imported with", nrow(master_log), "rows and", ncol(master_log),
  "columns.\n"
)

# Check the most recent file modification dates and print for user when this
# file is being sourced.

cat(
      "Master log last modified on OneDrive", 
      as.character(file.info(master_log_path)$mtime), "\n"
    )

# 2024-01-11: Master log imported with 442 rows and 35 columns.
# Master log last modified on OneDrive 2023-09-28 11:52:59
```

#### Data Check: Changes

We checked for changes to the source data set since this file was last modified.

```{r}
# Inputs last modified: 2024-01-08

data_mod_check(
  'df' = master_log,
  'df_path_str' = master_log_path,
  'orig_path_str' =  here::here("data", "master_log", "master_log.xlsx"),
  'mod_dt' = '2023-09-28 11:52:59 CDT',
  'num_rows' = 442,
  'num_cols' = 35,
  'col_names' = c(
      'id', 'baseline_dt', 'v2_sched', 'v2_dt', 'v2_late', 'v2_noshow', 
      'v3_sched', 'v3_dt', 'v3_late', 'v3_noshow', 'v4_sched', 'v4_dt', 
      'v4_late', 'v4_noshow', 'v5_sched', 'v5_dt', 'v5_late', 'v5_noshow', 
      'group', 'v2_status', 'dropped_status', 'name_first', 'name_middle', 
      'name_last', 'gender', 'race', 'hispanic_latino', 'dob', 'age', 
      'care_manager', 'v1_attend', 'v2_attend', 'v3_attend', 'v4_attend', 
      'v5_attend'
      )
  )
# TRUE
```

We purged the import path for memory management.

```{r}
rm(master_log_path)
```

## Visit Windows

We imported our Visit Window Data

```{r}
visit_window_path <- here::here("data", "master_log", "ml_protocol_dates.rds")
```

Import the data.
Check the most recent file modification dates and print for user when this file is being sourced.

```{r message=FALSE}
visit_windows <- readr::read_rds(visit_window_path)

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "Visit Window Data imported with", nrow(visit_windows), "rows and", 
  ncol(visit_windows), "columns.\n"
)

# Check the most recent file modification dates and print for user when this
# file is being sourced.

cat(
      "Visit Window Data last modified on OneDrive", 
      as.character(file.info(visit_window_path)$mtime), "\n"
    )
# 2024-01-11: Visit Window Data imported with 442 rows and 18 columns.
# Visit Window Data last modified on OneDrive 2023-12-13 13:01:02
```

#### Data Check: Changes

We checked for changes to the source data set since this file was last modified.

```{r}
# Inputs last modified: 2024-01-08

data_stats <- retrieve_data_stats("visit_window_stats")

data_mod_check(
  df = visit_windows,
  df_path_str = visit_window_path,
  orig_path_str = data_stats$rds_path,
  mod_dt = data_stats$mod_dt,
  num_cols = data_stats$num_cols,
  num_rows = data_stats$num_rows,
  col_names = data_stats$cols
  )
# TRUE
```

We purged the import path for memory management.

```{r}
rm(visit_window_path)
```

## Race Point-Fixes

We imported an Excel document containing point-fixes for race values. There were several disparities in values for race, Hispanic origin, and age found previously between the Master Log and subject responses. These disparities were resolved in discussion with the PIs on 2023-11-22; The values for race would require several point-fixes

```{r}
race_fixes_path  <- here::here(
  "data","Combined Participant Data", "race_point_fixes.xlsx"
  )
```

Import the data.
Check the most recent file modification dates and print for user when this file is being sourced.

```{r}
race_fixes <- readxl::read_excel(
  race_fixes_path, 
  sheet = "Sheet1",
  col_names = c("subject", "race"),
  col_types = c("text", "text"),
  skip = 1
  ) |>
  dplyr::mutate(subject = as.numeric(subject)) |>
  dplyr::filter(!is.na(subject))

# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  "Race Point Fixes imported with", nrow(race_fixes), "rows and", 
  ncol(race_fixes), "columns.\n"
)

# Check the most recent file modification dates and print for user when this
# file is being sourced.

cat(
      "Race Point Fixes last modified on OneDrive", 
      as.character(file.info(race_fixes_path)$mtime), "\n"
    )

# 2024-01-11: Master log imported with 15 rows and 2 columns.
# Master log last modified on OneDrive 2023-12-14 16:09:58 
```

#### Data Check: Changes

We checked for changes to the source data set since this file was last modified.

```{r}
# Inputs last modified: 2024-01-08

data_mod_check(
  'df' = race_fixes,
  'df_path_str' = race_fixes_path,
  'orig_path_str' =  here::here(
      "data","Combined Participant Data", "race_point_fixes.xlsx"
      ),
  'mod_dt' = '2023-12-14 16:09:58 CDT',
  'num_rows' = 15,
  'num_cols' = 2,
  'col_names' = c(
      'subject', 'race'
      )
  )
# TRUE
```

We purged the import path for memory management.

```{r}
rm(race_fixes_path)
rm(data_stats)
```

# Adding Flag Columns

We initialized two columns within our variable map: one to indicate if a variable was dropped after consolidation, and one to indicate if a variable was created from calculation after import.

```{r}
variable_map <- variable_map |>
  tibble::add_column(drop_consolidated = FALSE, calculated = FALSE)

attributes(variable_map$drop_consolidated)$label <- paste(
  "Was the variable dropped after consolidation?"
  )
attributes(variable_map$calculated)$label <- paste(
  "Was the variable created through calculation?"
  )
```

# Consolidating Duplicated Variables

## Administrative Section

We identified 'Time to Complete' as a previously dropped SPSS calculated variable, which was calculated by subtracting the end time from the start time.
This value was calculated in the QDS data, but not within the other data sets.
We chose to generate the `time_to_complete` value in our variable map, dropping the `etime` variable from the QDS data.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Administrative", "time_to_complete", prev_var = 'etime',
  opts = tibble::tibble(
    'attr_label' = "Time to complete (finish time - start time)",
    'calculated' = TRUE
    )
  )  |>
  dplyr::mutate(drop_consolidated = ifelse(variable == 'etime',
                                    TRUE,
                                    drop_consolidated
                                    )
         )
```

We performed the calculation.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(
    time_to_complete = endtime - ctime
  )
```

## Screening Questionnaire

The Screening Questionnaire was only completed once for each subject. However, The QDS and REDCap data sets had differing options. As a result, the variables `sq_7b` and `sq_7b_1` referenced the same material: Was there a recruitment flier number provided by the subject? We wished to merge these variables.

```{r}
variable_map <- variable_map |>
  dplyr::mutate(
    drop_consolidated = ifelse(
      variable == 'sq_7b_1', TRUE, drop_consolidated
      )
  )
```

We performed the modifications necessary to consolidate the repeated variables.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(
    sq_7b = ifelse(
      is.na(sq_7b), 
      sq_7b_1, 
      sq_7b)
  )
```

We noted that the date of birth value stored in `ml_dob` was not properly stored as a date variable. This was corrected.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(ml_dob = as.Date(as.numeric(ml_dob), origin = "1899-12-30"))
```

## Treatment Quality and Satisfaction

The original coding of the Treatment Quality and Satisfaction Survey created separate variables for the same questions when presented to members of each study group (i.e., "tq_1_1", "tq_1_2", and "tq_1_3" present the same question to members of group 1, group 2, and group 3 respectively).

For analysis, we needed to combine the identical variables into a single variable. We also saw that there were 18 unique questions.

```{r}
survey_vars <- dplyr::pull(
  variable_map |>
    dplyr::filter(instrument == "Treatment Quality and Satisfaction Survey") |>
    dplyr::select(variable)
  )

survey_vars
```

Manual examination of these variables in the source data indicated that there were no occurrences of a single visit having a data value for more than one version of the same question.

We identified the 18 variables we wished to combine all duplicated questions into - the first occurrence of each question.
Questions 1-14 were numeric, and questions 15-18 were text-based.
Questions 5, 6, 7, 8, 15, 16, 17, and 18 only had one variant.

```{r}
drop_vars <- c(
  'tq_1_2', 'tq_1_3', 'tq_2_2', 'tq_2_3', 'tq_3_3', 'tq_4_3', 'tq_9_3', 
  'tq_10_3', 'tq_11_3', 'tq_12_3', 'tq_13_3', 'tq_14_2', 'tq_14_3'
  )

variable_map <- variable_map  |>
  dplyr::mutate(drop_consolidated = ifelse((variable %in% drop_vars),
                                    TRUE,
                                    drop_consolidated
                                    )
         )
```

We consolidated these values.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(
    tq_1_1 = dplyr::case_when(
      !is.na(tq_1_1) ~ tq_1_1,
      (is.na(tq_1_1) & is.na(tq_1_3)) & !is.na(tq_1_2) ~ tq_1_2,
      (is.na(tq_1_1) & is.na(tq_1_2)) & !is.na(tq_1_3) ~ tq_1_3,
      TRUE ~ tq_1_1
      ),
    tq_2_1 = dplyr::case_when(
      !is.na(tq_2_1) ~ tq_2_1,
      (is.na(tq_2_1) & is.na(tq_2_3)) & !is.na(tq_2_2) ~ tq_2_2,
      (is.na(tq_2_1) & is.na(tq_2_2)) & !is.na(tq_2_3) ~ tq_2_3,
      TRUE ~ tq_2_1
      ),
    tq_3_2 = dplyr::case_when(
      !is.na(tq_3_2) ~ tq_3_2,
      is.na(tq_3_2) & !is.na(tq_3_3) ~ tq_3_3,
      TRUE ~ tq_3_2
      ),
    tq_4_2 = dplyr::case_when(
      !is.na(tq_4_2) ~ tq_4_2,
      is.na(tq_4_2) & !is.na(tq_4_3) ~ tq_4_3,
      TRUE ~ tq_4_2
      ),
    tq_9_2 = dplyr::case_when(
      !is.na(tq_9_2) ~ tq_9_2,
      is.na(tq_9_2) & !is.na(tq_9_3) ~ tq_9_3,
      TRUE ~ tq_9_2
      ),
    tq_10_2 = dplyr::case_when(
      !is.na(tq_10_2) ~ tq_10_2,
      is.na(tq_10_2) & !is.na(tq_10_3) ~ tq_10_3,
      TRUE ~ tq_10_2
      ),
    yq_11_2 = dplyr::case_when(
      !is.na(yq_11_2) ~ yq_11_2,
      is.na(yq_11_2) & !is.na(tq_11_3) ~ tq_11_3,
      TRUE ~ yq_11_2
      ),
    tq_12_2 = dplyr::case_when(
      !is.na(tq_12_2) ~ tq_12_2,
      is.na(tq_12_2) & !is.na(tq_12_3) ~ tq_12_3,
      TRUE ~ tq_12_2
      ),
    tq_13_2 = dplyr::case_when(
      !is.na(tq_13_2) ~ tq_13_2,
      is.na(tq_13_2) & !is.na(tq_13_3) ~ tq_13_3,
      TRUE ~ tq_13_2
      ),
    tq_14_1 = dplyr::case_when(
      !is.na(tq_14_1) ~ tq_14_1,
      (is.na(tq_14_1) & is.na(tq_14_3)) & !is.na(tq_14_2) ~ tq_14_2,
      (is.na(tq_14_1) & is.na(tq_14_2)) & !is.na(tq_14_3) ~ tq_14_3,
      TRUE ~ tq_14_1
      )
  )
```

# New Values

## Replacing Visit Dates

Nearly all visit dates as recorded in the REDCap and QDS data sets were found to be erroneous due to clock errors on the computers and phones used to record the data. As such, attendance dates for all subjects were reviewed, and the management strategy agreed by PIs on 2023-12-07. All visit dates, with the exception of 2 visit 5 dates (subjects 2009 and 2198), were to be overwritten by the attendance date in the Master Log.

```{r}
combined_data <- dplyr::left_join(
  combined_data,
  # Extract visit attendance dates for all subjects, and pivot into long
  # format (from wide). Join to existing data by matching subject and visit.
  master_log |>
    dplyr::select(id, baseline_dt, v2_dt, v3_dt, v4_dt, v5_dt) |>
    dplyr::rename_at(
      c('id', 'baseline_dt', 'v2_dt', 'v3_dt', 'v4_dt', 'v5_dt'),
      ~c('subject', '1', '2', '3', '4', '5')
      ) |>
    tidyr::pivot_longer(
      cols = c('1','2', '3', '4', '5'), 
      names_to = 'visit', 
      values_to = 'visit_date'
      ) |>
    dplyr::mutate(
      visit = as.numeric(visit),
      subject = as.numeric(subject)
      ),
  by = c('subject', 'visit')
  ) |>
  # Replace visit date values stored in `today` unless the visit is one of our
  # two exclusions
  dplyr::mutate(
    today = dplyr::if_else(
      !(subject %in% c(2009, 2198) & visit == 5), 
      visit_date, 
      today
      )
  ) |>
  dplyr::select(-visit_date)
```

We additionally calculated the time since randomization for all subject visits.

```{r}
combined_data <- dplyr::left_join(
  combined_data,
  master_log |>
    dplyr::select(id, v2_dt) |>
    dplyr::rename_at( c('id'), ~c('subject')
      ) |>
    dplyr::mutate(
      subject = as.numeric(subject)
      ),
  by = 'subject'
) |>
  dplyr::mutate(
    days_since_randomization = 
      lubridate::interval(v2_dt, today) %/% lubridate::days(1)
  ) |>
  select(-v2_dt)

variable_map <- variable_map |>
  vm_add_variable(
    'Administrative', 'days_since_randomization', 
    prev_var = 'today', 
    opts = tibble::tibble(
    'attr_label' = "Days since V2 Randomization Date",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  )
```

We additionally needed to flag any subjects that had data collection outside of the protocol-based windows. For Visits 3-5, a collection more than 5 days prior to the protocol date should be flagged as 'Early'. For Visits 3 or 4 visits more than 14 days after the protocol date and Visit 5 more than 30 days after the protocol date should be flagged as 'Late'. These protocol dates were stored in our Visit Windows Data.

First, we extracted the protocol dates and calculated our flags for each subject and visit.

```{r}
flag_data <- dplyr::left_join(
    combined_data |>
      dplyr::select(subject, visit, today),
    visit_windows |>
      dplyr::select(id, v3_protocol_wkd, v4_protocol_wkd, v5_protocol_wkd) |>
      dplyr::rename_at(
        c('id', 'v3_protocol_wkd', 'v4_protocol_wkd', 'v5_protocol_wkd'),
        ~c('subject', '3', '4', '5')) |>
      tidyr::pivot_longer(
        cols = c('3','4','5'), 
        names_to = 'visit', 
        values_to = 'protocol_dt'
        ) |>
      dplyr::mutate(visit = as.numeric(visit)),
    by = c('subject', 'visit')
  ) |>
  dplyr::mutate(
    distance = lubridate::interval(protocol_dt, today) %/% lubridate::ddays(1),
    visit_flag_type = dplyr::case_when(
      visit == 3 & distance < -5 ~ 'Early',
      visit == 4 & distance < -5 ~ 'Early',
      visit == 5 & distance < -5 ~ 'Early',
      visit == 3 & distance > 14 ~ 'Late',
      visit == 4 & distance > 14 ~ 'Late',
      visit == 5 & distance > 30 ~ 'Late',
      TRUE ~ NA
    ),
    visit_flag = !is.na(visit_flag_type),
    visit_flag_type = factor(visit_flag_type, levels = c('Early', 'Late'))
  ) |>
  dplyr::select(
    subject, visit, protocol_dt, visit_flag, visit_flag_type, distance
    ) |>
  dplyr::rename_at('distance', ~'attn_days_from_protocol')
```

We then joined this new data into our combined data set, and our variable map.

```{r}
combined_data <- dplyr::left_join(
  combined_data,
  flag_data,
  by = c('subject','visit')
)

variable_map <- variable_map |>
  vm_add_variable(
    'Administrative', 'protocol_dt', 
    prev_var = 'today', 
    opts = tibble::tibble(
    'attr_label' = "Visit Date per Protocol (from V2 Attendance Date)",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'attn_days_from_protocol', 
    prev_var = 'protocol_dt', 
    opts = tibble::tibble(
    'attr_label' = "Days between protocol date and attendance date for visit",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'visit_flag', 
    prev_var = 'attn_days_from_protocol', 
    opts = tibble::tibble(
    'attr_label' = "Was Visit outside of protocol range?",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'visit_flag_type', 
    prev_var = 'visit_flag', 
    opts = tibble::tibble(
    'attr_label' = "Visit flag type",
    'attr_var_labels' = list(c("Early" = "Early", 'Late' = "Late")),
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  )
```

## Flagging Exclusions

There were several subjects that failed to appear after their baseline visit, and were thus excluded. There were additionally three subjects with protocol deviations that were marked for exclusion. We generated a binary exclusion flag, and descriptor for the reason for exclusion.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(
    drop_flag = ifelse(
      ((!is.na(group) &
         v2_status != "Do Not Include")),
      FALSE,
      TRUE
    ),
    drop_reason = dplyr::case_when(
      v2_status == 'Do Not Include' ~ 'Protocol Exclusion',
      is.na(group) ~ 'No show after V1',
      TRUE ~ NA
    )
  ) 

variable_map <- variable_map |>
  vm_add_variable(
    'Administrative', 'drop_flag', 
    prev_var = 'visit_type', 
    opts = tibble::tibble(
    'attr_label' = "Is subject marked for exclusion?",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'drop_flag_type', 
    prev_var = 'drop_flag', 
    opts = tibble::tibble(
    'attr_label' = "Reason for Exclusion, if any",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  )
```

We purged the Master Log, Visit Window, and Flag data sets, as they were no longer necessary.

```{r}
rm(master_log)
rm(visit_windows)
rm(flag_data)
```

## Master Demographics

There were several disparities in values for race between the master log and subjective responses. Similarly, age and Hispanic origin also had disparities. These were resolved in conference with the PIs on 2023-11-22. The race variable from the Master Log required several point-fixes.

```{r}
combined_data <- dplyr::left_join(
  combined_data |>
    dplyr::mutate(
      subj_race = ml_race,
      subj_race = dplyr::case_when(
        subj_race == 'NH/PI' ~ paste0(
                  'Native Hawaiian or Other Pacific Islander (Guam, Samoa)'
                  ),
        subj_race == 'O/U' ~ 'Other',
        subj_race == 'AA' ~ 'Black or African American',
        subj_race == 'A' ~ paste0(
                  'Asian (Cambodia, China, India, Japan, Korea, Malaysia,',
                  ' Pakistan, Vietnam)'
                  ),
        subj_race == 'W' ~ 'White',
        subj_race == 'AI/AN' ~ 'American Indian / Alaska Native',
        subj_race == 'More Than One' ~ 'More than one race/multi-racial'
      )
    ),
  race_fixes,
  by = 'subject'
  ) |>
  dplyr::mutate(
    subj_race = if_else(!is.na(race), race, subj_race)
  ) |>
  dplyr::select(-race)
```

We also created a calculated age, using this date of birth value against the visit date.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Screening Instrument", 'calc_age', 
  prev_var = 'ml_age',
  opts = tibble::tibble(
    'attr_label' = "age in years, calculated from date of birth and visit date",
    'calculated' = TRUE
      )
    )

combined_data <- combined_data |>
  dplyr::mutate(
    calc_age = lubridate::interval(ml_dob, today) %/% lubridate::years(1)
  )
```

The master value for age was the calculated age at randomization, the master value for Hispanic origin was the subjective response in the screening instrument, and the gender variable was the subjective response (which had no deviation from the master log).

```{r}
master_demographics <- dplyr::left_join( 
    # Visit 1 Data
    combined_data |>
      dplyr::filter(visit == 1) |>
      dplyr::select(where(~ any(!is.na(.)))) |>
      dplyr::select(-today),
    # Visit 2 Data
    combined_data |>
      dplyr::filter(visit == 2) |>
      dplyr::select(where(~ any(!is.na(.)))) |>
      dplyr::select(-any_of(
        combined_data |>
          dplyr::filter(visit == 1) |>
          dplyr::select(where(~ any(!is.na(.)))) |>
          dplyr::select(-c(subject, today)) |>
          names()
      )),
    by = 'subject') |>
  dplyr::mutate(
    subj_age = calc_age,
    subj_hispanic = sq_2,
    subj_gender = gender
  ) |>
  dplyr::mutate(
    subj_hispanic = dplyr::case_when(
      subj_hispanic == 1 ~ TRUE,
      subj_hispanic == 0 ~ FALSE
    )
  ) |>
  dplyr::group_by(subject) |>
  tidyr::fill(subj_hispanic, .direction = 'downup') |>
  tidyr::fill(subj_race, .direction = 'downup') |>
  tidyr::fill(subj_gender, .direction = 'downup') |>
  dplyr::ungroup() |>
  dplyr::select(subject, subj_age, subj_hispanic, subj_gender, subj_race) 
```

We calculated each subject's aggregate race and ethnicity similar to use in [NHANES](https://wwwn.cdc.gov/nchs/nhanes/search/variablelist.aspx?Component=Demographics).

```{r}
master_demographics <- master_demographics |>
  dplyr::mutate(
    subj_race_ethn = dplyr::case_when(
      subj_hispanic == TRUE ~ 1,
      subj_race == 'White' ~ 2,
      subj_race == 'Black or African American' ~ 3,
      !is.na(subj_race) ~ 4
    ),
    subj_race = dplyr::case_when(
      subj_race == 'More than one race/multi-racial' ~ 1,
      subj_race == 'White' ~ 2,
      subj_race == 'Black or African American' ~ 3,
      subj_race == paste0(
        'Asian (Cambodia, China, India, Japan, Korea,',
        ' Malaysia, Pakistan, Vietnam)'
        ) ~ 4,
      subj_race=='Native Hawaiian or Other Pacific Islander (Guam, Samoa)' ~ 5,
      subj_race == 'American Indian / Alaska Native' ~ 6,
      subj_race == 'Other' ~ 7
    )
  ) 
```

We added these master demographic variables to our combined data set.

```{r}
combined_data <- dplyr::left_join( 
  combined_data |>
    dplyr::select(-subj_race),
  master_demographics |> 
    select(
      subject, subj_gender, subj_race, subj_race_ethn, subj_hispanic, subj_age
      ),
  by = 'subject')
```

We added these variables to our Variable Map.

```{r}
variable_map <- variable_map |>
  vm_add_variable(
    'Administrative', 'subj_race', 
    prev_var = 'dropped_status', 
    opts = tibble::tibble(
    'attr_label' = "Master Variable: Subject Race",
    'attr_var_labels' = list(c(
      'More than one race/multi-racial' = 1,
      'White' = 2,
      'Black or African American' = 3, 
      'Asian (Cambodia, China, India, Japan, Korea, Malaysia, Pakistan, Vietnam)'
        = 4,
      'Native Hawaiian or Other Pacific Islander (Guam, Samoa)' = 5, 
      'American Indian / Alaska Native' = 6, 
      'Other' = 7
      )),
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'subj_hispanic', 
    prev_var = 'subj_race', 
    opts = tibble::tibble(
    'attr_label' = "Master Variable: Subject Hispanic Ethnicity",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'subj_race_ethn', 
    prev_var = 'subj_hispanic', 
    opts = tibble::tibble(
    'attr_label' = "Subject Race and Ethnicity, 4 Category",
    'attr_var_labels' = list(c(
      'Hispanic (any race)' = 1,
      'Non-Hispanic White' = 2,
      'Non-Hispanic Black' = 3,  
      'Non-Hispanic, Other (including Multiracial)' = 4
      )),
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'subj_age', 
    prev_var = 'subj_race_ethn', 
    opts = tibble::tibble(
    'attr_label' = "Master Variable: Subject Age",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'Administrative', 'subj_gender', 
    prev_var = 'subj_age', 
    opts = tibble::tibble(
    'attr_label' = "Master Variable: Subject Gender",
    'attr_var_labels' = list(c(
      'Male' = 0,
      'Female' = 1,
      'Other' = 2
      )),
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  )

rm(race_fixes)
rm(master_demographics)
```

# Payment Structure

Subjects signed informed consent documents, which reflected remuneration payment structures, at each study visit.

There were two changes made to the payment structure of the project. The first modification was initiated with subject 2074, with subjects 2001-2073 entirely within the original payment structure. The second modification was implemented 2019-06-27; 2154 was enrolled in this structure at baseline, and 2153 was enrolled with randomization. Subject 2120 was the first subject to be enrolled in the second modification at their next visit. Subjects were then enrolled in the second modification on a rolling basis.

We added a variable indicating which payment structure the subject visit was under, and added it to our variable map.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(
    payment_structure = dplyr::case_when(
      subject < 2074 ~ 1,
      subject > 2074 & today >= lubridate::date('2019-06-27')  ~ 3,
      TRUE ~ 2
    )
  )

variable_map <- variable_map |>
  vm_add_variable(
    'Administrative', 'payment_structure', 
    prev_var = 'visit', 
    opts = tibble::tibble(
    'attr_label' = "Payment Structure",
    'attr_var_labels' = list(c(
      'Original' = 1,
      '1st Modification' = 2,
      '2nd Modification' = 3
      )),
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  )
```

# Recreating Calculated Variables

## Screening Section

### Mini-Mental State Exam (MMSE)

There were six dropped calculated variables that referenced the Mini-Mental State Exam measures. These variables calculated scoring for the instrument. Scores for each item were recalculated as automatic QDS calculation failed in several subjects.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(
    mms_1 = (mms_1a + mms_1b + mms_1c + mms_1d + mms_1e),
    mms_2 = (mms_2a + mms_2b + mms_2c + mms_2d + mms_2e),
    recal_1 = (mms_3g + mms_3h + mms_3i + mms_3j),
    mms_3 = recal_1,
    count = (mms_4a + mms_4b + mms_4c + mms_4d + mms_4e + mms_4f),
    mms_4 = count,
    num = (mms_4va + mms_4vb + mms_4vc + mms_4vd + mms_4ve + mms_4vf),
    mms_4v = num,
    recal_2 = (mms_5a + mms_5b + mms_5c + mms_5d),
    mms_5 = recal_2,
    object = (mms_6a + mms_6b + mms_6c),
    mms_6 = object,
    paper = (mms_8a + mms_8b + mms_8c + mms_8d),
    mms_8 = paper
    )

```

There were two possible versions - if subjects were unable to count backwards from 100 by 7s, they were offered the ability to spell WORLD backwards.

This resulted in two potential scoring systems (one using `count` when numerically tested, and one using `num` when tested using WORLD).

Unfortunately `num` values were not consistent in the original instrument and required recalculation.

The Mini-Mental State Exam automatically calculated a total score for the `num` item based on two potential forms of the question, but there were notable errors in this calculation (such as impossible negative values). We opted to recalculate this value.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Mini-Mental State Exam (MMSE)", "num_calc", prev_var = 'num',
  opts = tibble::tibble(
    'attr_label' = "Number Count (revised)",
    'calculated' = TRUE
    )
  ) |>
  dplyr::mutate(drop_consolidated = ifelse(variable == 'num',
                               TRUE,
                               drop_consolidated)
  )

combined_data <- combined_data |>
  dplyr::mutate(num_calc = ifelse(is.na(mms_4v) & !is.na(mms_4), 0, num))
```

We calculated scores for both possible versions scores, and marked the original total for dropping.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Mini-Mental State Exam (MMSE)", "mms_s_main", 
  prev_var = 'mms_s',
  opts = tibble::tibble(
    'attr_label' = paste(
                        "MINI Mental State Exam Score when participant",
                        "is able count backwards from 100 by 7s"  
                        ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable("Mini-Mental State Exam (MMSE)", "mms_s_alt", 
                  prev_var = 'mms_s_main',
                  opts = tibble::tibble(
    'attr_label' = paste(
                        "MINI Mental State Exam Score when participant is",
                        "unable to count backwards from 100 by 7s and is", 
                        "asked to spell WORLD backwards" 
                        ),
    'calculated' = TRUE
    )
  ) |>
  dplyr::mutate(drop_consolidated = ifelse(variable == 'mms_s',
                               TRUE,
                               drop_consolidated)
  )

combined_data <- combined_data |>
  dplyr::mutate(
    mms_s_main = (mms_1 + mms_2 + recal_1 + count + recal_2 + object +
                    mms_7 + paper + mms_9 + mms_10 + mms_11),
    mms_s_alt = (mms_1 + mms_2 + recal_1 + num_calc + recal_2 + object + 
                   mms_7 + paper + mms_9 + mms_10 + mms_11)
    )
```

We created a variable that would determine which score would predominate, and store that score. We also created a variable that would store the interpreted results as a categorical.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Mini-Mental State Exam (MMSE)", "mms_total", 
  prev_var = 'mms_s_alt',
  opts = tibble::tibble(
    'attr_label' = "MINI Mental State Exam total score",
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Mini-Mental State Exam (MMSE)", "mms_severity", 
    prev_var = 'mms_total',
    opts = tibble::tibble(
      'attr_label' = "What is the likelihood of cognitive impairment?",
      'calculated' = TRUE,
      'attr_var_labels' = list(c("No cognitive impairment" = 0, 
                                'Mild congnitive impairment' = 1,
                                'Severe cognitive impairment' = 2
                                )
                               )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    mms_total = dplyr::case_when(
      !is.na(num_calc) & (num_calc != 0) ~ mms_s_alt,
      (count > 0) & 
        (num_calc == 0 | is.na(num_calc)) ~ mms_s_main, 
      TRUE ~ NA),
    mms_severity = dplyr::case_when(
      mms_total >= 24 ~ 0, 
      (mms_total >=18) & (mms_total <24) ~ 1, 
      (mms_total < 18) ~ 2, 
      TRUE ~ NA)
    )
```

### REALM

The REALM scoring ignored the first two words ("Fat", "Flu"). Unfortunately, QDS scoring failed to automatically calculate scores for several subjects, so scoring was recalculated.

```{r}
combined_data <- combined_data |>
  dplyr::mutate(
    realm_s = (realmc + realmd + realme + realmf + realmg + realmh + realmi)
  )
```

### Anthropometrics

We found 28 dropped calculated variables that referenced the anthropometric measures.

Calculation of BMI required height in meters squared and weight in kilograms.
Height was originally collected in centimeters, so we calculated height in meters. We also calculated weight in kilograms.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Anthropometrics", "height_meters", prev_var = 'height',
  opts = tibble::tibble(
    'attr_label' = "Height (meters)",
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Anthropometrics", "weight_kg", prev_var = 'weight',
    opts = tibble::tibble(
      'attr_label' = "Weight (kilograms)",
      'calculated' = TRUE
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    weight_kg = weight * 0.453592,
    height_meters = height * 0.01
    )
```

We then calculated BMI.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Anthropometrics", "bmi", prev_var = 'height_meters',
  opts = tibble::tibble(
    'attr_label' = "Body Mass Index (kilograms per meters squared)",
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    bmi = weight_kg / (height_meters * height_meters)
    )
```


BMI categories were created, as were binary flag variables to indicate if a subject was obese or overweight.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Anthropometrics", "weight_status", prev_var = 'bmi',
  opts = tibble::tibble(
    'attr_label' = "BMI Categorization",
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "underweight" = 0, 
                              "normal" = 1,
                              "overweight" = 2,
                              "obese" = 3
                              )
                            )
    )
  ) |>
  vm_add_variable(
    "Anthropometrics", "obese", prev_var = 'weight_status',
    opts = tibble::tibble(
      'attr_label' = "Is subject obese?",
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "obese" = TRUE, 
                                "not obese" = FALSE
                                )
                              )
      )
  ) |>
  vm_add_variable(
    "Anthropometrics", "overwt_obese", prev_var = 'obese',
    opts = tibble::tibble(
      'attr_label' = "Is subject overweight or obese?",
      'calculated' = TRUE,
      'attr_var_labels' = alist(c(
                                "overweight or obese" = TRUE, 
                                "neither overweight nor obese" = FALSE
                                )
                              )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    weight_status = dplyr::case_when(
      (!is.na(bmi) & bmi < 18.5) ~ 0, 
      (!is.na(bmi) & (bmi >= 18.5) & (bmi < 25)) ~ 1, 
      (!is.na(bmi) & (bmi >= 25) & (bmi < 30)) ~ 2, 
      (!is.na(bmi) & bmi >= 30) ~ 3, 
      is.na(bmi) ~ NA),
    obese = dplyr::case_when(
      is.na(weight_status) ~ NA, 
      weight_status == 3 ~ TRUE, 
      (!is.na(weight_status) | (weight_status != 3)) ~ FALSE),
    overwt_obese = dplyr::case_when(
      is.na(weight_status) ~ NA, 
      (weight_status == 2 | weight_status == 3) ~ TRUE,
      (!is.na(weight_status) & (weight_status < 2)) ~ FALSE)
    )
```

## Demographic Section

### Demographic Questionnaire

There was a single variable dropped from the SPSS calculations in the demographic questionnaire - `Any_health_insurance`.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Demographic Questionnaire", 'any_health_insurance', 
  prev_var = 'dem_7e',
  opts = tibble::tibble(
    'attr_label' = "Does the subject have any form of health insurance?",
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    any_health_insurance = dplyr::case_when( 
      ((dem_7a == 1) | (dem_7b == 1) | (dem_7c == 1) | (dem_7d == 1)) ~ TRUE,
      ((dem_7a == 0) & (dem_7b == 0) & (dem_7c == 0) & (dem_7d == 0)) ~ FALSE,
      (dem_7e == 1) ~ FALSE, 
      TRUE ~ NA)
    )
```

Items 13 and 14 were collected from several categories. As such, we converted these into a single value

```{r}
variable_map <- vm_add_variable(
  variable_map, "Demographic Questionnaire", 'dem_13_val', 
  prev_var = 'dem_13h',
  opts = tibble::tibble(
    'attr_label' = "Total combined family income for the past 12 months",
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
      '$0' = 0, '$1000' = 1, '$2000' = 2, '$3000' = 3, '$4000' = 4, 
      '$5000' = 5, '$6000' = 6, '$7000' = 7, '$8000' = 8, '$9000' = 9,
      '$10000' = 10, '$11000' = 11, '$12000' = 12, '$13000' = 13, 
      '$14000' = 14, '$15000' = 15, '$16000' = 16, '$17000' = 17, 
      '$18000' = 18, '$19000' = 19, '$20000' = 20, '$21000' = 21, 
      '$22000' = 22, '$23000' = 23, '$24000' = 24, '$25000' = 25, 
      '$26000' = 26, '$27000' = 27, '$28000' = 28, '$29000' = 29,
      '$30000' = 30, '$31000' = 31, '$32000' = 32, '$33000' = 33, 
      '$34000' = 34, '$35000' = 35, '$36000' = 36, '$37000' = 37, 
      '$38000' = 38, '$39000' = 39, '$40000' = 40, '$41000' = 41, 
      '$42000' = 42, '$43000' = 43, '$44000' = 44, '$45000' = 45, 
      '$46000' = 46, '$47000' = 47, '$48000' = 48, '$49000' = 49, 
      '$50000' = 50, '$51000' = 51, '$52000' = 52, '$53000' = 53, 
      '$54000' = 54, '$55000' = 55, '$56000' = 56, '$57000' = 57, 
      '$58000' = 58, '$59000' = 59, '$60000' = 60, '$61000' = 61, 
      '$62000' = 62, '$63000' = 63, '$64000' = 64, '$65000' = 65, 
      '$66000' = 66, '$67000' = 67, '$68000' = 68, '$69000' = 69,
      '$70000' = 70, '$71000' = 71, '$72000' = 72, '$73000' = 73, 
      '$74000' = 74, '$75000' = 75, '$76000' = 76, '$77000' = 77, 
      '$78000' = 78, '$79000' = 79
      )
      )
    )
  ) |>
  vm_add_variable(
  "Demographic Questionnaire", 'dem_14_val', 
  prev_var = 'dem_14h',
  opts = tibble::tibble(
    'attr_label' = "Total income from all sources LAST MONTH",
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
      '$0' = 0, '$1 to $250' = 1, '$251 to $500' = 2, '$501 to $750' = 3,
      '$751 to $999' = 4, '$1000 to $1,250' = 5, '$1,251 to $1,500' = 6,
      '$1,501 to $1,750' = 7, '$1,751 to $1,999' = 8, '$2000 to $2,250' = 9,
      '$2,251 to $2,500' = 10, '$2,501 to $2,750' = 11, 
      '$2,751 to $2,999' = 12, '$3000 to $3,250' = 13, 
      '$3,251 to $3,500' = 14, '$3,501 to $3,750' = 15, 
      '$3,751 to $3,999' = 16, '$4000 to $4,250' = 17, 
      '$4,251 to $4,500' = 18, '$4,501 to $4,750' = 19, 
      '$4,751 to $4,999' = 20, '$5000 to $5,250' = 21, 
      '$5,251 to $5,500' = 22, '$5,501 to $5,750' = 23, 
      '$5,751 to $5,999' = 24, '$6000 to $6,250' = 25, 
      '$6,251 to $6,500' = 26, '$6,501 to $6,750' = 27, 
      '$6,751 to $6,999' = 28, '$6000 to $6,250' = 29, 
      '$6,251 to $6,500' = 30, '$6,501 to $6,750' = 31, 
      '$6,751 to $6,999' = 32
      )
      )
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    dem_13_val = dplyr::case_when( 
      !is.na(dem_13a) ~ dem_13a, 
      !is.na(dem_13b) ~ dem_13b + 10, 
      !is.na(dem_13c) ~ dem_13c + 20, 
      !is.na(dem_13d) ~ dem_13d + 30, 
      !is.na(dem_13e) ~ dem_13e + 40, 
      !is.na(dem_13f) ~ dem_13f + 50, 
      !is.na(dem_13g) ~ dem_13g + 60, 
      !is.na(dem_13h) ~ dem_13h + 70, TRUE ~ NA),
    dem_14_val = dplyr::case_when( 
      !is.na(dem_14a) ~ dem_14a, 
      !is.na(dem_14b) ~ dem_14b + 5, 
      !is.na(dem_14c) ~ dem_14c + 9, 
      !is.na(dem_14d) ~ dem_14d + 13, 
      !is.na(dem_14e) ~ dem_14e + 17, 
      !is.na(dem_14f) ~ dem_14f + 21, 
      !is.na(dem_14g) ~ dem_14g + 25, 
      !is.na(dem_14h) ~ dem_14h + 29, 
      TRUE ~ NA)
    )
```

### The Brief Homelessness Questionnaire

The Criminal History items (question 13 and its derivatives) were initially calculated to include a selection of 'none of the above' as an arrest item. These items were recalculated.

```{r}
combined_data <- combined_data <- combined_data |>
  dplyr::mutate(
    bh_13a = bh_13aa + bh_13ab + bh_13ac + bh_13ad + bh_13ae,
    bh_13b = bh_13ba + bh_13bb + bh_13bc + bh_13bd + bh_13be + 
      bh_13bf + bh_13bg,
    bh_13c = bh_13ca + bh_13cb + bh_13cc + bh_13cd + bh_13ce + 
      bh_13cf + bh_13cg
  )

```

We calculated binary variables to indicate if a subject had any form of endorsed criminal history, and if that history did or did not include the violent offenses listed in 13c

```{r}
variable_map <- variable_map |>
  vm_add_variable(
    'The Brief Homelessness Questionnaire', 'subj_criminal_hx', 
    prev_var = 'bh_13ch', 
    opts = tibble::tibble(
    'attr_label' = "Did the subject endorse any criminal history?",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  ) |>
  vm_add_variable(
    'The Brief Homelessness Questionnaire', 'subj_criminal_hx_violent', 
    prev_var = 'subj_criminal_hx', 
    opts = tibble::tibble(
    'attr_label' = "Did the subject endorse any violent criminal history?",
    'calculated' = TRUE,
    'drop_consolidated' = FALSE
    )
  )

combined_data <- dplyr::left_join(
  combined_data,
  combined_data |>
      dplyr::filter(visit == 1) |>
      dplyr::select(subject, bh_13a, bh_13b, bh_13c) |>
      dplyr::mutate(
        subj_criminal_hx = dplyr::case_when(
          ((bh_13a > 0) | (bh_13b > 0)| (bh_13c > 0)) ~ TRUE,
          ((bh_13a == 0) & (bh_13b == 0) & (bh_13c == 0)) ~ FALSE,
        ),
        subj_criminal_hx_violent = dplyr::case_when(
          subj_criminal_hx & (bh_13c > 0) ~ TRUE,
          subj_criminal_hx & (bh_13c == 0) ~ FALSE,
          !subj_criminal_hx ~ FALSE
        ) 
    )|>
    dplyr::select(subject, subj_criminal_hx, subj_criminal_hx_violent) |>
    dplyr::distinct(),
  by = 'subject'
  )
```

## Health Section

### Patient Health Questionnaire (PHQ)

We found 48 dropped calculated variables that referenced the Patient Health Questionnaire measures.

We calculated the total for the PHQ Depression items (Questions 1-8).

```{r}
variable_map <- vm_add_variable(
  variable_map, "Patient Health Questionnaire (PHQ)", 'phq_dep_total', 
  prev_var = 'phq_15',
  opts = tibble::tibble(
    'attr_label' = "Sum of PHQ MDD questions",
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    phq_dep_total = (phq_1 + phq_2 + phq_3 + phq_4 + phq_5 + phq_6 +
                       phq_7 + phq_8)
    )
```

here was also a dichotomous version of each of the PHQ Depression Items (Questions 1-8): a score of 0-1 ("not at all" or "several days") was coded as a 0, and any other answer as a 1.

```{r}
for (i in c(1:8)){
  new_var_i = paste0("phq_", i, "_dichot")
  prev_var_i = paste0("phq_", i) 

  variable_map <- vm_add_variable(
    variable_map, "Patient Health Questionnaire (PHQ)", new_var_i, 
    prev_var = prev_var_i,
    opts = tibble::tibble(
      'attr_label' = paste(
                           variable_map[variable_map$variable == 
                                         prev_var_i,]$attr_label,
                           "dichotomized"
                          ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                            "Not at all and several days" = 0, 
                            "More than half the days and nearly every day" = 1
                            )
                          )
      )
    )
}

combined_data <- combined_data |>
  dplyr::mutate(
    phq_1_dichot = dplyr::case_when( 
      ((phq_1  == 0) | ( phq_1  == 1)) ~ 0, 
      phq_1 > 1 ~ 1, 
      TRUE ~ NA),
    phq_2_dichot = dplyr::case_when(
      ((phq_2  == 0) | ( phq_2  == 1)) ~ 0, 
      phq_2 > 1 ~ 1, 
      TRUE ~ NA),
    phq_3_dichot = dplyr::case_when(
      ((phq_3  == 0) | ( phq_3  == 1)) ~ 0, 
      phq_3 > 1 ~ 1, 
      TRUE ~ NA),
    phq_4_dichot = dplyr::case_when(
      ((phq_4  == 0) | ( phq_4  == 1)) ~ 0, 
      phq_4 > 1 ~ 1, 
      TRUE ~ NA),
    phq_5_dichot = dplyr::case_when(
      ((phq_5  == 0) | ( phq_5  == 1)) ~ 0, 
      phq_5 > 1 ~ 1, 
      TRUE ~ NA),
    phq_6_dichot = dplyr::case_when(
      ((phq_6  == 0) | ( phq_6  == 1)) ~ 0, 
      phq_6 > 1 ~ 1, 
      TRUE ~ NA),
    phq_7_dichot = dplyr::case_when(
      ((phq_7  == 0) | ( phq_7  == 1)) ~ 0, 
      phq_7 > 1 ~ 1, 
      TRUE ~ NA),
    phq_8_dichot = dplyr::case_when(
      ((phq_8  == 0) | ( phq_8  == 1)) ~ 0, 
      phq_8 > 1 ~ 1, 
      TRUE ~ NA)
    )
```

We calculated the total number of items where "More than half the days" or "Nearly every day" were selected for these items.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Patient Health Questionnaire (PHQ)", 
  'phq_dep_dichot_total', prev_var = 'phq_dep_total',
  opts = tibble::tibble(
    'attr_label' = "PHQ depression dichotomized total",
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    phq_dep_dichot_total = (phq_1_dichot + phq_2_dichot + phq_3_dichot +
                              phq_4_dichot + phq_5_dichot + phq_6_dichot +
                              phq_7_dichot + phq_8_dichot)
    )
```

We determined the categorical score of probable MDD.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Patient Health Questionnaire (PHQ)", 
  'phq_dep_symp', prev_var = 'phq_dep_dichot_total',
  opts = tibble::tibble(
    'attr_label' = paste(
                      "Does PHQ1 or PHQ2 have more than half the days", 
                      "or nearly every day selected?"
                      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
     "Patient Health Questionnaire (PHQ)", 
    'phq_mdd', prev_var = 'phq_dep_symp',
     opts = tibble::tibble(
        'attr_label' = "Is there probable major depressive disorder?",
        'calculated' = TRUE
        )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    phq_dep_symp = dplyr::case_when( 
      ((phq_1_dichot == 1) | (phq_2_dichot == 1)) ~ 1, 
      ((phq_1_dichot == 0) & (phq_2_dichot == 0)) ~ 0, 
      TRUE ~ NA),
    phq_mdd = dplyr::case_when( 
      ((phq_dep_symp == 1) | (phq_dep_dichot_total > 4)) ~ TRUE, 
      phq_dep_symp == 0 ~ FALSE, 
      phq_dep_dichot_total < 5 ~ FALSE, 
      TRUE ~ FALSE)
    )
```

We calculated the total for the PHQ GAD items (Questions 9-15).

```{r}
variable_map <- vm_add_variable(
  variable_map, "Patient Health Questionnaire (PHQ)", 
  'phq_gad_total', prev_var = 'phq_mdd',
  opts = tibble::tibble(
    'attr_label' = "Sum of PHQ GAD questions",
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    phq_gad_total = (phq_9 + phq_10 + phq_11 + phq_12 + phq_13 + 
                       phq_14 + phq_15)
    )
```


### SF12 Health Survey

We found 4 dropped calculated variables that referenced the SF 12 Health Survey measures. We dichotomized the outcomes for the first question of the instrument.

```{r}
variable_map <- vm_add_variable(
  variable_map, "SF12 Health Survey", 
  'hs_1_dichot', prev_var = 'hs_1',
  opts = tibble::tibble(
    'attr_label' = "Self-Rated health dichot",
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "excellent to good health" = 0, 
                              "fair or poor health" = 1
                              )
                   )
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    hs_1_dichot = dplyr::case_when( 
      (hs_1  <= 3) ~ 0, 
      (hs_2 > 3) ~ 1, 
      TRUE ~ NA)
    )
```

### Self-Rated Health

There were 4 dropped calculated variables that referenced the Self-Rated Health measures.

We dichotomized our items for mental health history, substance abuse history, and pain.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Self-Rated Health", 
  's_mental_hx', prev_var = 's_23',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Is a history of depression, anxiety, ptsd, bipolar,", 
      "or schizophrenia present?"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                    "has no history of mental illnes" = FALSE,
                    "has a history of at least one mental illness" = TRUE
                    )
                  )
    )
  ) |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_hx_ever_any', prev_var = 's_4h',
    opts = tibble::tibble(
      'attr_label' = paste(
        "If endorsement of any (ever) history of alcohol, cannabis, cocaine, ",
        "opiate, amphetamine, sedative, hypnotic, anxiolytic or other abuse",
        " present"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
              "has no endorsed (ever) history of substance abuse" = FALSE,
              "has a endorsed (ever) history of at least one substance abuse" = TRUE)
                    )
      )
  ) |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_hx_ever_etoh', 
    prev_var = 's_substance_hx_ever_any',
    opts = tibble::tibble(
      'attr_label' = paste(
        "If endorsement of any (ever) history of alcohol abuse present"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
              "has no endorsed (ever) history of etoh abuse" = FALSE,
              "has a endorsed (ever) history of etoh abuse" = TRUE)
                    )
      )
  ) |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_hx_ever_non_etoh', 
    prev_var = 's_substance_hx_ever_etoh',
    opts = tibble::tibble(
      'attr_label' = paste(
        "If endorsement of any (ever) history of non-alcohol abuse of cannabis,",
        " cocaine, opiate, amphetamine, sedative, hypnotic, anxiolytic or ",
        "other substances present"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
              "has no endorsed (ever) history of non-etoh substance abuse" = FALSE,
              "has a endorsed (ever) history of at least one non-etoh substance abuse" = TRUE)
                    )
      )
  ) |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_dx_any', prev_var = 's_30g',
    opts = tibble::tibble(
      'attr_label' = paste(
        "If history of medical diagnosis for alcohol, cannabis, cocaine, ",
        "opiate, amphetamine, sedative, hypnotic, anxiolytic or other abuse",
        " present"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
              "has no diagnosed history of substance abuse" = FALSE,
              "has a diagnosed history of at least one substance abuse disorder" = TRUE)
                    )
      )
  )  |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_dx_etoh', 
    prev_var = 's_substance_dx_any',
    opts = tibble::tibble(
      'attr_label' = paste(
        "If history of medical diagnosis for alcohol abuse present"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
              "has no diagnosed history of etoh abuse disorder" = FALSE,
              "has a diagnosed history of etoh abuse disorder" = TRUE)
                    )
      )
  )  |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_dx_non_etoh', 
    prev_var = 's_substance_dx_etoh',
    opts = tibble::tibble(
      'attr_label' = paste(
        "If history of medical diagnosis for non-alcohol abuse of cannabis, ",
        "cocaine, opiate, amphetamine, sedative, hypnotic, anxiolytic or other",
        " substance abuse present"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
              "has no diagnosed history of non-etoh substance abuse" = FALSE,
              "has a diagnosed history of at least one non-etoh substance abuse disorder" = TRUE)
                    )
      )
  ) |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_use_any', prev_var = 's_32i',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Endorsed use of alcohol cannabis, cocaine, opiate, amphetamine, ",
        "sedative, hypnotic, anxiolytic, K2, or other substance in the past ",
        "30 days"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "has not used a substance" = FALSE,
                                "has used a substance" = TRUE
                                )
                    )
      )
  )  |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_use_etoh', 
    prev_var = 's_substance_use_any',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Endorsed use of alcohol in the past 30 days"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "has not used alcohol" = FALSE,
                                "has used alcohol" = TRUE
                                )
                    )
      )
  )  |>
  vm_add_variable(
    "Self-Rated Health", 's_substance_use_non_etoh', 
    prev_var = 's_substance_use_etoh',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Endorsed use of non-alcohol substances of cannabis, cocaine, opiate, ",
        "amphetamine, sedative, hypnotic, anxiolytic, K2, or other substance ",
        "in the past 30 days"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "has not used a substance" = FALSE,
                                "has used a substance" = TRUE
                                )
                    )
      )
  ) |>
  vm_add_variable(
    "Self-Rated Health", 's_pain', prev_var = 's_40',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Pain level in last 4 weeks categorized into none-mild and mod-severe"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "none to mild pain" = FALSE,
                                "moderate or severe pain" = TRUE
                                )
                              )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    s_mental_hx = dplyr::case_when(
      ((s_19 == 1) | (s_20 == 1) | (s_21 == 1) | 
         (s_22 == 1) | (s_23 == 1)) ~ TRUE, 
      ((s_19 == 0) & (s_20 == 0) & (s_21 == 0) & 
         (s_22 == 0) & (s_23 == 0)) ~ FALSE, 
      TRUE ~ NA),
    s_substance_hx_ever_any = dplyr::case_when( 
      ((s_4a == 1) | (s_4b == 1) | (s_4c == 1) | (s_4d == 1) | (s_4e == 1) | 
         (s_4f == 1) | (s_4g == 1) | (s_4h == 1)) ~ TRUE,
      ((s_4a == 0) & (s_4b == 0) & (s_4c == 0) & (s_4d == 0) & (s_4e == 0) & 
         (s_4f == 0) & (s_4g == 0) & (s_4h == 0)) ~ FALSE, 
      s_3 == 0 ~ FALSE, 
      TRUE ~ NA),    
    s_substance_hx_ever_etoh = dplyr::case_when( 
      ((s_4a == 1)) ~ TRUE,
      ((s_4a == 0)) ~ FALSE, 
      s_3 == 0 ~ FALSE, 
      TRUE ~ NA),   
    s_substance_hx_ever_non_etoh = dplyr::case_when( 
      ((s_4b == 1) | (s_4c == 1) | (s_4d == 1) | (s_4e == 1) | 
         (s_4f == 1) | (s_4g == 1) | (s_4h == 1)) ~ TRUE,
      ((s_4b == 0) & (s_4c == 0) & (s_4d == 0) & (s_4e == 0) & 
         (s_4f == 0) & (s_4g == 0) & (s_4h == 0)) ~ FALSE, 
      s_3 == 0 ~ FALSE, 
      TRUE ~ NA),   
    s_substance_dx_any = dplyr::case_when( 
      ((s_30a == 1) | (s_30b == 1) | (s_30c == 1) | 
         (s_30d == 1) | (s_30e == 1) | (s_30f == 1) | (s_30g == 1)) ~ TRUE,
      ((s_30a == 0) & (s_30b == 0) & (s_30c == 0) & (s_30d == 0) & 
         (s_30e == 0) & (s_30f == 0) & (s_30g == 0)) ~ FALSE, 
      s_29 == 0 ~ FALSE, 
      TRUE ~ NA),
    s_substance_dx_etoh = dplyr::case_when( 
      ((s_30a == 1)) ~ TRUE,
      ((s_30a == 0)) ~ FALSE, 
      s_29 == 0 ~ FALSE, 
      TRUE ~ NA),
    s_substance_dx_non_etoh = dplyr::case_when( 
      ((s_30b == 1) | (s_30c == 1) | 
         (s_30d == 1) | (s_30e == 1) | (s_30f == 1) | (s_30g == 1)) ~ TRUE,
      ((s_30b == 0) & (s_30c == 0) & (s_30d == 0) & 
         (s_30e == 0) & (s_30f == 0) & (s_30g == 0)) ~ FALSE, 
      s_29 == 0 ~ FALSE, 
      TRUE ~ NA),
    s_substance_use_any = dplyr::case_when( 
      ((s_32a == 1) | (s_32b == 1) | (s_32c == 1) | (s_32d == 1) | 
         (s_32e == 1) | (s_32f == 1) | (s_32g == 1) | (s_32h == 1)) ~ TRUE,
      ((s_32a == 0) & (s_32b == 0) & (s_32c == 0) & (s_32d == 0) & 
         (s_32e == 0) & (s_32f == 0) & (s_32g == 0) & (s_32h == 0)) ~ FALSE, 
      TRUE ~ NA),
    s_substance_use_etoh = dplyr::case_when( 
      ((s_32a == 1)) ~ TRUE,
      ((s_32a == 0)) ~ FALSE, 
      TRUE ~ NA),
    s_substance_use_non_etoh = dplyr::case_when( 
      ((s_32b == 1) | (s_32c == 1) | (s_32d == 1) | (s_32e == 1) | 
         (s_32f == 1) | (s_32g == 1) | (s_32h == 1)) ~ TRUE,
      ((s_32b == 0) & (s_32c == 0) & (s_32d == 0) & (s_32e == 0) & 
         (s_32f == 0) & (s_32g == 0) & (s_32h == 0)) ~ FALSE, 
      TRUE ~ NA),
    s_pain = dplyr::case_when( 
      s_40 > 2 ~ TRUE, 
      s_40 <=2 ~ FALSE, 
      TRUE ~ NA)
    )
```

### TCU Drug Screen 5

There were 8 dropped calculated variables that referenced the TCU Drug Screen 5 measures.

We calculated the total of the items, and categorized the result.

```{r}
variable_map <- vm_add_variable(
  variable_map, "TCU Drug Screen 5", 
  'ds_10_val', prev_var = 'ds_10b',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Combined 10A & 10B, tolerance"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "No to both" = 0, 
                              "Yes to either" = 1
                              )
                            )
    )
  ) |>
  vm_add_variable(
    "TCU Drug Screen 5", 'ds_11_val', prev_var = 'ds_11b',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Combined 11A & 11B, withdrawal"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "No to both" = 0, 
                                "Yes to either" = 1
                                )
                              )
      )
  ) |>
  vm_add_variable(
    "TCU Drug Screen 5", 'ds_total', prev_var = 'ds_11_val',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Total TCU Drug Screen 5 Score"
        ),
      'calculated' = TRUE,
      )
  ) |>
  vm_add_variable(
    "TCU Drug Screen 5", 'ds_cat', prev_var = 'ds_total',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Total TCU Drug Screen 5 Score Category"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "Score <= 1" = 0, 
                                "Mild disorder" = 1,
                                "Moderate disorder" = 2,
                                "Severe disorder" = 3
                                )
                              )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    ds_10_val = dplyr::case_when( 
      ((ds_10a == 1) | (ds_10b == 1)) ~ 1, 
      ((ds_10a == 0) & (ds_10b == 0)) ~ 0, 
      TRUE ~ NA),
    ds_11_val = dplyr::case_when( 
      ((ds_11a == 1) | (ds_11b == 1)) ~ 1, 
      ((ds_11a == 0) & (ds_11b == 0)) ~ 0, 
      TRUE ~ NA),
    ds_total = (ds_1 + ds_2 + ds_3 + ds_4 + ds_5 + ds_6 + ds_7
                + ds_8 + ds_9 + ds_10_val + ds_11_val),
    ds_cat = dplyr::case_when( 
      (ds_total <= 1) ~ 0, 
      ((ds_total >= 2) & (ds_total <= 3)) ~ 1, 
      ((ds_total >= 4) & (ds_total <= 5)) ~ 2, 
      (ds_total >5) ~ 3, 
      TRUE ~ NA)
  )
```

### Primary Care PTSD Screen (PC-PTSD)

There were 2 dropped calculated variables that referenced the Primary Care PTSD Screen (PC-PTSD) measures.

We calculated the total of the items, and categorized the result.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Primary Care PTSD Screen (PC-PTSD)", 
  'ptsd_total', prev_var = 'ptsd_4',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Sum of PC-PTSD"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Primary Care PTSD Screen (PC-PTSD)", 'ptsd_positive', 
    prev_var = 'ptsd_total',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Probable PTSD"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "No PTSD" = FALSE, 
                                "Probable PTSD" = TRUE
                                )
                              )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    ptsd_total = (ptsd_1 + ptsd_2 + ptsd_3 + ptsd_4),
    ptsd_positive= dplyr::case_when( 
      ptsd_total >= 3 ~ TRUE, 
      ptsd_total < 3 ~ FALSE, 
      TRUE ~ NA)
)
```

### Tobacco History

There were 8 dropped calculated variables that referenced the Tobacco History.

We calculated the values of Questions 5 and 6.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Tobacco History", 
  't_5_val', prev_var = 't_5a6',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Exact number of cigarettes smoked in the last 24 hours"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Tobacco History", 't_6_val', prev_var = 't_6a6',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Exact number of cigarettes usually smoked in a day"
        ),
      'calculated' = TRUE
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    t_5_val = dplyr::case_when(
                      (t_5 == 0) ~ 0,
                      (t_5 == 1) ~ t_5a1,
                      (t_5 == 2) ~ t_5a2,
                      (t_5 == 3) ~ t_5a3,
                      (t_5 == 4) ~ t_5a4,
                      (t_5 == 5) ~ t_5a5,
                      (t_5 == 6) ~ t_5a6,
                      TRUE ~ NA
                      ),
    t_6_val =  dplyr::case_when(
                        (t_6 == 0) ~ 0,
                        (t_6 == 1) ~ t_6a1,
                        (t_6 == 2) ~ t_6a2,
                        (t_6 == 3) ~ t_6a3,
                        (t_6 == 4) ~ t_6a4,
                        (t_6 == 5) ~ t_6a5,
                        (t_6 == 6) ~ t_6a6,
                        TRUE ~ NA
                        )
  )
```

We also calculated the ratio of friends that smoke, and created a dichotomous if a spouse smokes.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Tobacco History", 
  't_spouse', prev_var = 't_35',
  opts = tibble::tibble(
    'attr_label' = paste(
      "if a participant has a spouse that smokes"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
        "participant does not have spouse who smokes" = FALSE, 
        "participant does have spouse who smokes" = TRUE
        )
      )
    )
  ) |>
  vm_add_variable(
    "Tobacco History", 't_friends', prev_var = 't_39',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Ratio of close friends who smoke"
        ),
      'calculated' = TRUE
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    t_spouse = dplyr::case_when(
                      ((t_34 == 1) & (t_35 == 1)) ~ TRUE,
                      ((t_34 == 1) & (t_35 == 1)) ~ FALSE,
                      TRUE ~ NA
                      ),
    t_friends = dplyr::case_when(
                        (t_38 > 0) ~ (t_39 / t_38),
                        TRUE ~ NA
                        )
  )
```

### Heaviness of Smoking Index (HSI)

There were 8 dropped calculated variables that referenced the Heaviness of Smoking Index (HSI) measures.

We calculated the total of the items, and categorized the result.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Heaviness of Smoking Index", 
  'hsi_score', prev_var = 'hsi_2',
  opts = tibble::tibble(
    'attr_label' = paste(
      "HSI score"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Heaviness of Smoking Index", 'hsi_cat', prev_var = 'hsi_score',
    opts = tibble::tibble(
      'attr_label' = paste(
        "HSI score recoded into categories"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "very low dependence" = 0, 
                                "low to moderate dependence" = 1,
                                "moderate dependence" = 2,
                                "high dependence" = 3
                                )
                            )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    hsi_score = (hsi_1 + hsi_2),
    hsi_cat = dplyr::case_when(
                        hsi_score < 3 ~ 0,
                        hsi_score == 3 ~ 1,
                        hsi_score == 4 ~ 2,
                        hsi_score > 4 ~ 3,
                        TRUE ~ NA
                        )
  )
```

### BRFSS Inadequate Sleep

There were 8 dropped calculated variables that referenced the BRFSS Inadequate Sleep measures.

We dichotomized the results for question 2 and question 4, and labeled the categories.

```{r}
variable_map <- vm_add_variable(
  variable_map, 
  "Behavioral Risk Factor Surveillance System (BRFSS) Inadequate Sleep", 
  'brs_2_dichot', prev_var = 'brs_2',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Average Hours of Sleep dichot"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "7 hours or more" = 0, 
                              "less than 7 hours" = 1
                              )
                            )
    )
  ) |>
  vm_add_variable(
  "Behavioral Risk Factor Surveillance System (BRFSS) Inadequate Sleep", 
  'brs_4_dichot', prev_var = 'brs_4',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Unintentional sleep dichot"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                            "No unintentional sleeping" = 0, 
                            "at least one day of unintentional sleeping" = 1
                              )
                            )
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    brs_2_dichot = dplyr::case_when(
                            brs_2 >= 7 ~ 0,
                            brs_2 < 7 ~ 1,
                            TRUE ~ NA
                            ),
    brs_4_dichot = dplyr::case_when(
                              brs_4 == 0 ~ 0,
                              brs_4 > 0 ~ 1,
                              TRUE ~ NA
                              )
  )
```

### Alcohol Quantity and Frequency Questionnaire

There were 12 dropped calculated variables that referenced the Alcohol Quantity and Frequency Questionnaire measures.

We calculated the total for item 1.
We also calculated if each subject was or was not a heavy drinker, number of days binge drinking, and a binary category indicating if a subject engaged in binge drinking in the past 30 days.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Alcohol Quantity and Frequency Questionnaire", 
  'af_1_val', prev_var = 'af_8su',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Total drinks in an average week"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Alcohol Quantity and Frequency Questionnaire", 
    'af_1_heavy', prev_var = 'af_1_val',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Heavy drinking (men > 14 drinks per week, women > 7 drinks per week)"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "not a heavy drinker" = FALSE, 
                                "heavy drinker" = TRUE
                                )
                            )
      )
  )  |>
  vm_add_variable(
    "Alcohol Quantity and Frequency Questionnaire", 
    'af_9_val', prev_var = 'af_9c',
    opts = tibble::tibble(
      'attr_label' = paste(
        "How often in the past 30 days have you consumed", 
        "(4 if female; 5 if male) or more STANDARD DRINKS?"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "Alcohol Quantity and Frequency Questionnaire", 
    'af_9_binge', prev_var = 'af_9_val',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Binge drinking in the past 30 days"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
            "no binge drinking in the past 30 days" = FALSE,
            "binge drinking in the past 30 days" = TRUE
            )
        )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    af_1_val = dplyr::case_when(
                      af_1 == 0 ~ 0,
                      af_1 > 0 ~ (af_2m + af_3tu + af_4w + af_5th + af_6f
                                  + af_6sa + af_8su),
                      TRUE ~ NA
                      ),
    af_1_heavy = dplyr::case_when(
                          ((gender == 0) & (af_1_val <= 14)) ~ FALSE,
                          ((gender == 0) & (af_1_val > 14)) ~ TRUE,
                          ((gender == 1) & (af_1_val <= 7)) ~ FALSE,
                          ((gender == 1) & (af_1_val > 7)) ~ TRUE,
                          TRUE ~ NA
                          ),
    af_9_val = dplyr::case_when(
                        (af_9 == 0) ~ af_9a,
                        (af_9 == 1) ~ af_9b,
                        (af_9 == 2) ~ af_9c,
                        TRUE ~ NA
                        ),
    af_9_binge = dplyr::case_when(
                          af_9_val >= 1 ~ TRUE,
                          af_9_val == 0 ~ FALSE,
                          TRUE ~ NA
                          )
  )
```

### Alcohol and Drug Timeline Follow Back

We calculated a dichotomous variable to indicate if a subject endorsed any drug use in the timeline follow-back period.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Alcohol and Drug Timeline Follow-Back (TLFB)", 
  'tlfb_drug_use', prev_var = 'num_days_using_drugs',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Did the Subject Endorse Any Drug Use in the TLFB Period?"
      ),
    'calculated' = TRUE,
      'attr_var_labels' = list(c(
              "denied any drug use" = FALSE,
              "endorsed any drug use" = TRUE)
                    )
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    tlfb_drug_use = dplyr::case_when(
                      num_days_using_drugs > 0 ~ TRUE,
                      num_days_using_drugs == 0 ~ FALSE,
                      TRUE ~ NA
                      )
  )
```

We also calculated the percentage of days a subject endorsed using alcohol.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Alcohol and Drug Timeline Follow-Back (TLFB)", 
  'tlfb_alc_drink_perc', prev_var = 'num_drinking_days',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Percentage of days in the TLFB period with reported alcohol intake"
      ),
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    tlfb_alc_drink_perc = num_drinking_days * 100 / days_followed
  )
```

### Personality Beliefs Questionnaire

There was 1 dropped calculated variable that referenced the Personality Beliefs Questionnaire measures.

We calculated the total for the instrument

```{r}
variable_map <- vm_add_variable(
  variable_map, "Personality Beliefs Questionnaire", 
  'pbq_total', prev_var = 'pbq_7',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Personality Beliefs Questionaire Antisocial Subscale total"
      ),
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    pbq_total = (pbq_1 + pbq_2 + pbq_3 + pbq_4 + pbq_5 + pbq_6 + pbq_7)
  )
```

### USDA Food Security Survey

There were 37 dropped calculated variables that referenced the USDA Food Security Survey measures.

We calculated scoring for each item.

```{r}
variable_map <- vm_add_variable(
  variable_map, "USDA Food Security Survey", 
  'fss_1_dichot', prev_var = 'fss_1',
  opts = tibble::tibble(
    'attr_label' = paste(
      "food didn't last dichot"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "no" = 0, 
                              "affirmative yes" = 1
                              )
                            )
    )
  ) |>
  vm_add_variable(
    "USDA Food Security Survey", 'fss_2_dichot', prev_var = 'fss_2',
    opts = tibble::tibble(
      'attr_label' = paste(
        "unable to afford balanced meals dichot"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                  "no" = 0, 
                                  "affirmative yes" = 1
                                  )
                                )
      )
  ) |>
  vm_add_variable(
    "USDA Food Security Survey", 'fss_3_dichot', prev_var = 'fss_3',
    opts = tibble::tibble(
      'attr_label' = paste(
        "cut/skip meal due to cost dichot"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                  "no" = 0, 
                                  "affirmative yes" = 1
                                  )
                                )
      )
  ) |>
  vm_add_variable(
    "USDA Food Security Survey", 'fss_3a_dichot', prev_var = 'fss_3a',
    opts = tibble::tibble(
      'attr_label' = paste(
        "frequency of cutting/skipping meals dichot"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                  "1 to 2 days per month or less" = 0, 
                                  "some days to every day" = 1
                                  )
                                )
      )
  ) |>
  vm_add_variable(
    "USDA Food Security Survey", 'fss_4_dichot', prev_var = 'fss_4',
    opts = tibble::tibble(
      'attr_label' = paste(
        "ate less than felt one should due to cost dichot"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                  "no" = 0, 
                                  "affirmative yes" = 1
                                  )
                                )
      )
  ) |>
  vm_add_variable(
    "USDA Food Security Survey", 'fss_5_dichot', prev_var = 'fss_5',
    opts = tibble::tibble(
      'attr_label' = paste(
        "hungry but didn't eat due to cost dichot"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "no" = 0, 
                                "affirmative yes" = 1
                                )
                              )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    fss_1_dichot = dplyr::case_when(
                            ((fss_1 == 0) | (fss_1 == 1)) ~ 1,
                            ((fss_1 == 2) | (fss_1 == 99)) ~ 0,
                            TRUE ~ NA
                            ),
    fss_2_dichot = dplyr::case_when(
                        ((fss_2 == 0) | (fss_2 == 1)) ~ 1,
                        ((fss_2 == 2) | (fss_2 == 99)) ~ 0,
                        TRUE ~ NA
                        ),
    fss_3_dichot = dplyr::case_when(
                        (fss_3 == 1) ~ 1,
                        ((fss_3 == 0) | (fss_2 == 9)) ~ 0,
                        TRUE ~ NA
                        ),
    fss_3a_dichot = dplyr::case_when(
                        ((fss_3a == 0) | (fss_3a == 1)) ~ 1,
                        ((fss_3a == 2) | (fss_3a == 9) | (fss_3 == 0)) ~ 0,
                        TRUE ~ NA
                        ),
    fss_4_dichot = dplyr::case_when(
                        (fss_4 == 1) ~ 1,
                        ((fss_4 == 0) | (fss_4 == 9)) ~ 0,
                        TRUE ~ NA
                        ),
    fss_5_dichot = dplyr::case_when(
                        (fss_5 == 1) ~ 1,
                        ((fss_5 == 0) | (fss_5 == 9)) ~ 0,
                        TRUE ~ NA
                        )
  )
```

We calculated the total scale, and the category interpretations of the scores for this instrument.

```{r}
variable_map <- vm_add_variable(
  variable_map, "USDA Food Security Survey", 
  'fss_total', prev_var = 'fss_5_dichot',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Total USDA Food Security Survey score"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "USDA Food Security Survey", 'fss_cat', prev_var = 'fss_total',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Food security status"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "High or marginal food security" = 1, 
                                "Low food security" = 2,
                                "Very low food security" = 3
                              )
                            )
      )
  ) |>
  vm_add_variable(
    "USDA Food Security Survey", 'fss_cat_dichot', prev_var = 'fss_cat',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Food security status dichot"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "food secure" = FALSE, 
                                "food insecure" = TRUE
                              )
                            )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    fss_total = (fss_1_dichot + fss_2_dichot + fss_3_dichot + 
                   fss_3a_dichot + fss_4_dichot + fss_5_dichot),
    fss_2_dichot = dplyr::case_when(
                        ((fss_2 == 0) | (fss_2 == 1)) ~ 1,
                        ((fss_2 == 2) | (fss_2 == 99)) ~ 0,
                        TRUE ~ NA
                        ),
    fss_cat = dplyr::case_when(
                        (fss_total <= 1) ~ 1,
                        ((fss_total < 5) | (fss_total > 1)) ~ 2,
			(fss_total >= 5) ~ 3,
                        TRUE ~ NA
                        ),
    fss_cat_dichot = dplyr::case_when(
                        (fss_total <=1) ~ FALSE,
                        (fss_total > 1) ~ TRUE,
                        TRUE ~ NA
                        )
  )
```

### TCU CJ Client Evaluation of Self and Treatment (CJ CEST)

There were 16 dropped calculated variables that referenced the TCU CJ Client Evaluation of Self and Treatment (CJ CEST) measures.

```{r}
variable_map <- vm_add_variable(
  variable_map, "TCU CJ Client Evaluation of Self and Treatment (CJ CEST)", 
  'cj_desire', prev_var = 'cj_40',
  opts = tibble::tibble(
    'attr_label' = paste(
      "TCU CJ desire for help subscale score"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "TCU CJ Client Evaluation of Self and Treatment (CJ CEST)", 
    'cj_needs', prev_var = 'cj_desire',
    opts = tibble::tibble(
      'attr_label' = paste(
        "TCU CJ treatment needs subscale score"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "TCU CJ Client Evaluation of Self and Treatment (CJ CEST)", 
    'cj_satisfaction', prev_var = 'cj_needs',
    opts = tibble::tibble(
      'attr_label' = paste(
        "TCU CJ treatment satisfaction subscale score"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "TCU CJ Client Evaluation of Self and Treatment (CJ CEST)", 
    'cj_selfesteem', prev_var = 'cj_satisfaction',
    opts = tibble::tibble(
      'attr_label' = paste(
        "TCU CJ self-esteem subscale score"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "TCU CJ Client Evaluation of Self and Treatment (CJ CEST)", 
    'cj_hostility', prev_var = 'cj_selfesteem',
    opts = tibble::tibble(
      'attr_label' = paste(
        "TCU CJ hostility subscale score"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "TCU CJ Client Evaluation of Self and Treatment (CJ CEST)", 
    'cj_risktaking', prev_var = 'cj_hostility',
    opts = tibble::tibble(
      'attr_label' = paste(
        "TCU CJ risk taking subscale score"
        ),
      'calculated' = TRUE
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    cj_desire = ifelse(
        cj_1 == 1,
        ((cj_2 + cj_3 + cj_4 + cj_5 + cj_6 + cj_7)*10/6),
        NA
      ),
    cj_needs = ((cj_8 + cj_9 + cj_10 + cj_11 + cj_12)*10/5),
    cj_satisfaction = ((cj_13 + cj_14 + cj_15 + cj_16 + cj_17 + cj_18 
                        + cj_19) * 10/7),
    cj_selfesteem = ((cj_20 + (6 - cj_21) + (6 - cj_22) + (6 - cj_23) + 
                        (6 - cj_24) + (6 - cj_25))*10/6),
    cj_hostility = ((cj_26 + cj_27 + cj_28 + cj_29 + cj_30 + cj_31 + 
                       cj_32 + cj_33)*10/8),
    cj_risktaking = (((6 - cj_34) + (6 - cj_35) + (6 - cj_36) + cj_37 + 
                        cj_38 + cj_39 + cj_40)*10/7)
  )
```

## Stress

### Detroit Area Study Assessment of Day-to-Day Discrimination

There were 4 dropped calculated variables that referenced the Detroit Area Study Assessment of Day-to-Day Discrimination measures.

We calculated the total score for the instrument.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Detroit Area Study Assessment of Day-to-Day Discrimination", 
  'dd_total', prev_var = 'dd_10',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Detroit Area Study Assessment of Day-to-Day Discrimination total"
      ),
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    dd_total = (dd_1 + dd_2 + dd_3 + dd_4 + dd_5 + dd_6 + dd_7 + dd_8 + dd_9)
  )
```

### MacArthur Major Discrimination

There were 1 dropped calculated variable that referenced the MacArthur Major Discrimination measures.

We calculated the total score for the instrument.

```{r}
variable_map <- vm_add_variable(
  variable_map, "MacAurthur Major Discrimination", 
  'mmd_total', prev_var = 'mmd_1k',
  opts = tibble::tibble(
    'attr_label' = paste(
      "MacArthur Major Discrimination total"
      ),
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    mmd_total = (mmd_1a + mmd_1b + mmd_1c + mmd_1d + mmd_1f + mmd_1g + 
                   mmd_1h + mmd_1i + mmd_1j + mmd_1k)
  )
```

### Urban Life Stress Scale

There were 4 dropped calculated variables that referenced the Urban Life Stress Scale measures.

We calculated the score for the item.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Urban Life Stress Scale", 
  'uls_total', prev_var = 'uls_21',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Urban Life Stress Scale Total"
      ),
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    uls_total = (uls_1 + uls_2 + uls_3 + uls_4 + uls_5 + uls_6 + uls_7 + 
                   uls_8 + uls_9 + uls_10 + uls_11 + uls_12 + uls_13 + 
                   uls_14 + uls_15 + uls_16 + uls_17 + uls_18 + uls_19 + 
                   uls_20 + uls_21)
  )
```

### Perceived Stress Scale

They were 12 dropped calculated variables that referenced the Perceived Stress Scale measures.

We calculated the score for the item, taking care to reverse scoring for Questions 2 and 3.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Perceived Stress Scale", 
  'ps_total', prev_var = 'ps_4',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Percieved Stress Score Total"
      ),
    'calculated' = TRUE
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    ps_total = (ps_1 + (4 - ps_2) + (4 - ps_3) + ps_4)
  )
```

### Distress Tolerance Scale (DTS)

There were 20 dropped calculated variables that referenced the Distress Tolerance Scale (DTS) measures.

All QDS variables were written with reverse coding, with the exception of Question 7.
We calculated sub-scales within the instrument.
Question 6 is not used in scoring, and was a reversal of Question 8.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Distress Tolerance Scale", 
  'dts_tolerance', prev_var = 'dts_16',
  opts = tibble::tibble(
    'attr_label' = paste(
      "DTS Tolerance Subscale Mean"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Distress Tolerance Scale", 'dts_absorption', 
    prev_var = 'dts_tolerance',
    opts = tibble::tibble(
      'attr_label' = paste(
        "DTS Absorption Subscale Mean"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "Distress Tolerance Scale", 'dts_appraisal', 
    prev_var = 'dts_absorption',
    opts = tibble::tibble(
      'attr_label' = paste(
        "DTS Appraisal Subscale Mean"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "Distress Tolerance Scale", 'dts_regulation', 
    prev_var = 'dts_appraisal',
    opts = tibble::tibble(
      'attr_label' = paste(
        "DTS Regulation Subscale Mean"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "Distress Tolerance Scale", 'dts_total', 
    prev_var = 'dts_regulation',
    opts = tibble::tibble(
      'attr_label' = paste(
        "DTS Total Mean"
        ),
      'calculated' = TRUE
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    dts_tolerance = ( ((6 - dts_1) + (6 - dts_3) + (6 - dts_5))/3),
    dts_absorption = ( ((6 - dts_2) + (6 - dts_4) + (6 - dts_16))/3),
    dts_appraisal = ( (dts_7 + (6 - dts_8) + (6 - dts_10) + (6 - dts_11) + 
                         (6 - dts_12) + (6 - dts_13))/6),
    dts_regulation = ( ((6 - dts_9) + (6 - dts_14) + (6 - dts_15))/3),
    dts_total = ((dts_tolerance + dts_absorption + dts_appraisal + 
                    dts_regulation)/4)
  )
```

## Negative Affect

### Aggression Questionnaire (AQ-12)

There were 20 dropped calculated variables that referenced the Aggression Questionnaire (AQ-12) measures.

We calculated the total of the items, and categorized the result.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Aggression Questionnaire (AQ-12)", 
  'aq_physical', prev_var = 'aq_12',
  opts = tibble::tibble(
    'attr_label' = paste(
      "AQ Physical Aggression subscale"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Aggression Questionnaire (AQ-12)", 
    'aq_verbal', prev_var = 'aq_physical',
    opts = tibble::tibble(
      'attr_label' = paste(
        "AQ Verbal Aggression subscale"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "Aggression Questionnaire (AQ-12)", 
    'aq_anger', prev_var = 'aq_verbal',
    opts = tibble::tibble(
      'attr_label' = paste(
        "AQ Anger subscale"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "Aggression Questionnaire (AQ-12)", 
    'aq_hostility', prev_var = 'aq_anger',
    opts = tibble::tibble(
      'attr_label' = paste(
        "AQ Hostility subscale"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
    "Aggression Questionnaire (AQ-12)", 
    'aq_total', prev_var = 'aq_hostility',
    opts = tibble::tibble(
      'attr_label' = paste(
        "AQ Total"
        ),
      'calculated' = TRUE
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    aq_physical = (aq_1 + aq_2 + aq_3),
    aq_verbal = (aq_4 + aq_5 + aq_6),
    aq_anger = (aq_7 + aq_8 + aq_9),
    aq_hostility = (aq_10 + aq_11 + aq_12),
    aq_total = (aq_physical + aq_verbal + aq_anger + aq_hostility)
  )
```

### Center for Epidemiological Studies Depression (CES-D)

There were 64 dropped calculated variables that referenced the Center for Epidemiological Studies Depression (CES-D) measures.

We calculated the overall total, taking care to ensure reverse scoring of items 5 and 8, and the resulting category based on this score.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Center for Epidemiological Studies Depression (CES-D)", 
  'ces_total', prev_var = 'ces_10',
  opts = tibble::tibble(
    'attr_label' = paste(
      "CESD Total"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Center for Epidemiological Studies Depression (CES-D)", 
    'ces_cat', prev_var = 'ces_total',
    opts = tibble::tibble(
      'attr_label' = paste(
        "CESD outcome categorized"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "negative depression" = FALSE, 
                                "probable depression" = TRUE
                                )
                              )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    ces_total = (ces_1 + ces_2 + ces_3 + ces_4 + (3-ces_5) + ces_6 + 
                   ces_7 + (3-ces_8) + ces_9 + ces_10),
    ces_cat = dplyr::case_when(
                       ces_total >= 10 ~ TRUE,
                       ces_total < 10 ~ FALSE,
                       TRUE ~ NA
                       )
  )
```

We also dichotomized all of the variables, taking care to ensure reverse scoring of items 5 and 8.

```{r}
for (i in setdiff(c(1:10), c(5, 8))){
  new_var_i = paste0("ces_", i, "_dichot")
  prev_var_i = paste0("ces_", i) 

  variable_map <- vm_add_variable(
    variable_map, "Center for Epidemiological Studies Depression (CES-D)", 
    new_var_i, prev_var = prev_var_i,
    opts = tibble::tibble(
      'attr_label' = paste(
                           variable_map[variable_map$variable == 
                                         prev_var_i,]$attr_label,
                           "dichotomized"
                          ),
      'calculated' = TRUE
      )
    )
}

for (i in c(5, 8)){
  new_var_i = paste0("ces_", i, "_dichot")
  prev_var_i = paste0("ces_", i) 

  variable_map <- vm_add_variable(
    variable_map, "Center for Epidemiological Studies Depression (CES-D)", 
    new_var_i, prev_var = prev_var_i,
    opts = tibble::tibble(
      'attr_label' = paste(
                           variable_map[variable_map$variable == 
                                         prev_var_i,]$attr_label,
                           "dichotomized"
                          ),
      'calculated' = TRUE
      )
    )
}

combined_data <- combined_data |>
  dplyr::mutate(
    ces_1_dichot = dplyr::case_when( 
                          (ces_1 == 0) | (ces_1 == 1) ~ 0,
                          (ces_1 == 2) | (ces_1 == 3) ~ 1,
                          TRUE ~ NA
                          ),
    ces_2_dichot = dplyr::case_when( 
                          (ces_2 == 0) | (ces_2 == 1) ~ 0,
                          (ces_2 == 2) | (ces_2 == 3) ~ 1,
                          TRUE ~ NA
                          ),
    ces_3_dichot = dplyr::case_when( 
                          (ces_3 == 0) | (ces_3 == 1) ~ 0,
                          (ces_3 == 2) | (ces_3 == 3) ~ 1,
                          TRUE ~ NA
                          ),
    ces_4_dichot = dplyr::case_when( 
                          (ces_4 == 0) | (ces_4 == 1) ~ 0,
                          (ces_4 == 2) | (ces_4 == 3) ~ 1,
                          TRUE ~ NA
                          ),
    ces_5_dichot = dplyr::case_when( 
                          (ces_5 == 2) | (ces_5 == 3) ~ 0,
                          (ces_5 == 0) | (ces_5 == 1) ~ 1,
                          TRUE ~ NA
                          ),
    ces_6_dichot = dplyr::case_when( 
                          (ces_6 == 0) | (ces_6 == 1) ~ 0,
                          (ces_6 == 2) | (ces_6 == 3) ~ 1,
                          TRUE ~ NA
                          ),
    ces_7_dichot = dplyr::case_when( 
                          (ces_7 == 0) | (ces_7 == 1) ~ 0,
                          (ces_7 == 2) | (ces_7 == 3) ~ 1,
                          TRUE ~ NA
                          ),
    ces_8_dichot = dplyr::case_when( 
                          (ces_8 == 2) | (ces_8 == 3) ~ 0,
                          (ces_8 == 0) | (ces_8 == 1) ~ 1,
                          TRUE ~ NA
                          ),
    ces_9_dichot = dplyr::case_when( 
                          (ces_9 == 0) | (ces_9 == 1) ~ 0,
                          (ces_9 == 2) | (ces_9 == 3) ~ 1,
                          TRUE ~ NA
                          ),
    ces_10_dichot = dplyr::case_when( 
                          (ces_10 == 0) | (ces_10 == 1) ~ 0,
                          (ces_10 == 2) | (ces_10 == 3) ~ 1,
                          TRUE ~ NA
                          )
  )
```

We calculated the dichotomized score and categorization.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Center for Epidemiological Studies Depression (CES-D)", 
  'ces_dichot_total', prev_var = 'ces_total',
  opts = tibble::tibble(
    'attr_label' = paste(
      "Sum of CESD Dichotomized Items"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
    "Center for Epidemiological Studies Depression (CES-D)", 
    'ces_dichot_cat', prev_var = 'ces_dichot_total',
    opts = tibble::tibble(
      'attr_label' = paste(
        "Dichotomized CESD outcome, categorized"
        ),
      'calculated' = TRUE,
      'attr_var_labels' = list(c(
                                "negative depression" = FALSE, 
                                "probable depression" = TRUE
                                )
                              )
      )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    ces_dichot_total = (ces_1_dichot + ces_2_dichot + ces_3_dichot +
                        ces_4_dichot + ces_5_dichot + ces_6_dichot + 
                        ces_7_dichot + ces_8_dichot + ces_9_dichot + 
                        ces_10_dichot),
    ces_dichot_cat = dplyr::case_when(
                               ces_dichot_total >= 4 ~ TRUE,
                               ces_dichot_total < 4 ~ FALSE,
                               TRUE ~ NA)
  )
```

## Interpersonal Resources

### Interpersonal Support Evaluation List

There were 36 dropped calculated variables that referenced the Interpersonal Support Evaluation List measures.

We calculated sub-scales within the instrument, with care taken to reverse score for items 1, 5, 7, 8, 11 and 12.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Interpersonal Support Evaluation List", 
  'is_app', prev_var = 'is_12',
  opts = tibble::tibble(
    'attr_label' = paste(
      "ISE appraisal subscale"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
  "Interpersonal Support Evaluation List", 
      'is_bel', prev_var = 'is_app',
      opts = tibble::tibble(
        'attr_label' = paste(
          "ISE belonging subscale"
          ),
        'calculated' = TRUE
        )
  ) |>
  vm_add_variable(
  "Interpersonal Support Evaluation List", 
      'is_tan', prev_var = 'is_bel',
      opts = tibble::tibble(
        'attr_label' = paste(
          "ISE tangible subscale"
          ),
        'calculated' = TRUE
        )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    is_app = ( (5 - is_2) + is_4 + is_6 + (5 - is_11)),
    is_bel = ( (5 - is_1) + is_5 + (5 - is_7) + is_9),
    is_tan = (is_3 + (5 - is_8) + is_10 + (5 - is_12))
  )
```

### Lubben Social Network Scale 6

There were 12 dropped calculated variables that referenced the Lubben Social Network Scale 6 measures.

We calculated the sub-scales and categories within the instrument.

```{r}
variable_map <- vm_add_variable(
  variable_map, "Lubben Social Network Scale 6", 
  'lsn_family', prev_var = 'lsn_6',
  opts = tibble::tibble(
    'attr_label' = paste(
      "LSN Family subscale"
      ),
    'calculated' = TRUE
    )
  ) |>
  vm_add_variable(
  "Lubben Social Network Scale 6", 
  'lsn_family_cat', prev_var = 'lsn_family',
  opts = tibble::tibble(
    'attr_label' = paste(
      "LSN Family subscale category"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "marginal support" = FALSE, 
                              "social engagement" = TRUE
                              )
                          )
    )
  ) |>
  vm_add_variable(
    "Lubben Social Network Scale 6", 
    'lsn_friends', prev_var = 'lsn_family_cat',
    opts = tibble::tibble(
      'attr_label' = paste(
        "LSN Friends subscale"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
  "Lubben Social Network Scale 6", 
  'lsn_friends_cat', prev_var = 'lsn_friends',
  opts = tibble::tibble(
    'attr_label' = paste(
      "LSN Friends subscale category"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "marginal support" = FALSE, 
                              "social engagement" = TRUE
                              )
                          )
    )
  ) |>
  vm_add_variable(
    "Lubben Social Network Scale 6", 
    'lsn_total', prev_var = 'lsn_friends_cat',
    opts = tibble::tibble(
      'attr_label' = paste(
        "LSN Total score"
        ),
      'calculated' = TRUE
      )
  ) |>
  vm_add_variable(
  "Lubben Social Network Scale 6", 
  'lsn_total_cat', prev_var = 'lsn_total',
  opts = tibble::tibble(
    'attr_label' = paste(
      "LSN Friends subscale category"
      ),
    'calculated' = TRUE,
    'attr_var_labels' = list(c(
                              "marginal support" = FALSE, 
                              "social engagement" = TRUE
                              )
                          )
    )
  )

combined_data <- combined_data |>
  dplyr::mutate(
    lsn_family = (lsn_1 + lsn_2 + lsn_3),
    lsn_family_cat = dplyr::case_when(
                              lsn_family < 6 ~ FALSE,
                              lsn_family >= 6 ~ TRUE,
                              TRUE ~ NA
                              ),
    lsn_friends = (lsn_4 + lsn_5 + lsn_6),
    lsn_friends_cat = dplyr::case_when(
                                lsn_friends < 6 ~ FALSE,
                                lsn_friends >= 6 ~ TRUE,
                                TRUE ~ NA
                                ),
    lsn_total = (lsn_family + lsn_friends),
    lsn_total_cat = dplyr::case_when(
                              lsn_total <= 12 ~ FALSE,
                              lsn_total > 12 ~ TRUE,
                              TRUE ~ NA
                              )
  )
```

# Ensuring `drop_consolidated` is "FALSE" (not missing)

We ensured all variables with a missing (`NA`) value for `drop_consolidated` instead gained a value of FALSE.

```{r}
variable_map <- variable_map |>
  dplyr::mutate(drop_consolidated = ifelse(
      is.na(drop_consolidated), 
      FALSE, 
      drop_consolidated
      )
    )
```

We also identified that `redcap_event_name` failed to be marked for consolidation. This was corrected.

```{r}
variable_map <- variable_map |>
  dplyr::mutate(drop_consolidated = ifelse(
      variable == 'redcap_event_name', 
      TRUE, 
      drop_consolidated
      )
    )
```

# Ordering and Labeling Variables

We ordered the variables within our variable map, filtered to only include variables present in our current combined data set, and isolated the variables. We used this ordered list to order the columns in our combined data set.

```{r}
variable_order <- dplyr::pull(
  variable_map |>
    dplyr::arrange(sec_ord, inst_ord, item_ord) |>
    dplyr::filter(variable %in% colnames(combined_data)) |>
    dplyr::select(variable)
  )

combined_data <- combined_data[ ,variable_order]
```

We ensured the variables in our processed data set had our desired label and value labels attributes.

```{r}
for (var_name in colnames(combined_data)){
  attributes(
    combined_data[[var_name]]
    )$label <- dplyr::pull(
      variable_map[variable_map$variable == var_name, 'attr_label']
      )
   attributes(
     combined_data[[var_name]]
     )$labels <- dplyr::pull(
       variable_map[variable_map$variable == var_name, 'attr_var_labels']
       )[[1]] 
}
```

We dropped the variables that were marked for exclusion.

```{r}
dropping_vars <- dplyr::pull(
  variable_map |>
    dplyr::filter(drop_consolidated) |>
    dplyr::select(variable)
)

combined_data <- combined_data |>
  dplyr::select(-all_of(dropping_vars))
```

We purged the remaining variables for memory management.

```{r}
rm(drop_vars)
rm(i)
rm(new_var_i)
rm(prev_var_i)
rm(survey_vars)
rm(var_name)
rm(variable_order)
rm(dropping_vars)
```

# üíæ Saving the Data

## Combined Data

```{r}
# RDS
combined_data_path <- here::here(
  "data", "Combined Participant Data", "combined_data_02.rds"
  )

readr::write_rds(combined_data, combined_data_path)

# SPSS
combined_data_path <- here::here(
  "data", "Combined Participant Data", "combined_data_02.sav"
  )

haven::write_sav(combined_data, combined_data_path)
```

We purged the related variables to reduce memory burden and protect against memory leak.

```{r}
rm(combined_data_path)
rm(combined_data)
```

## Variable Map

```{r}
# RDS

variable_map_path <- here::here(
  "data", "Combined Participant Data", "variable_map_02.rds"
  )

readr::write_rds(variable_map, variable_map_path)

# EXCEL

 variable_map_path <- here::here(
   "data", "Combined Participant Data", "variable_map_02.xlsx"
   )

# Ensure labels are character to enable writing to EXCEL file

variable_map <- variable_map |>
  dplyr::mutate(attr_var_labels = as.character(attr_var_labels))
 
openxlsx::write.xlsx(variable_map, variable_map_path)
```

We purged the related variables to reduce memory burden and protect against memory leak.

```{r}
rm(variable_map_path)
rm(variable_map)
```

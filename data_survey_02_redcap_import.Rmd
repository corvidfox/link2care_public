---
title: "Import Link2Care Survey redcap - REDCap"
date: "2021-04-23 <br> Updated: `r Sys.Date()`"
---

# ‚≠êÔ∏èOverview

This file is used to import the Link2Care follow-up visit survey redcap and do some initial redcap cleaning.

[Notes on cleaning individual L2C redcap sets for merging](https://github.com/brad-cannell/link2care_public/wiki/Notes-on-cleaning-individual-L2C-redcap-sets-for-merging)


# üì¶Load packages

```{r message=FALSE}
library(dplyr, warn.conflicts = FALSE)
library(haven, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)
library(readxl, warn.conflicts = FALSE)
library(stringr, warn.conflicts = FALSE)
```

# üì•Import redcap 

```{r}
path <- "data/redcap/All_Visits_Redcap.sav"
```

# Check the most recent file modification dates on the UTHealth servers and print for user when this file is being sourced. 

```{r}
cat(
  stringr::str_extract(path, "([^/]+$)"),
  "last modified on UTHealth server:",
  as.character(file.info(path)$mtime), "\n"
)
```

# Print a message for when this file is being sourced

```{r}
redcap <- read_sav(path)

cat(
  paste0(Sys.Date(), ":"),
  "REDCap imported with", nrow(redcap), "rows and", ncol(redcap), "columns.\n"
)

# 2023-03-15: REDCap imported with 112 rows and 882 columns.
# 2022-07-11: REDCap imported with 24 rows and 914 columns.
# 2023-03-15: REDCap imported with 112 rows and 882 columns.
# 2023-04-18: REDCap imported with 115 rows and 920 columns.
# 2023-05-11: REDCap imported with 119 rows and 845 columns.
```

# Remove fake redcap rows

Joe created some fake redcap rows in REDCap that need to be removed.

```{r}
redcap <- redcap %>%
  mutate(record_id = as.numeric(record_id)) %>% 
  # Warnings are from converting character strings (e.g., -948_TEST) to
  # numeric. R is forced to set them to NA. This is what we want to happen.
  filter(!is.na(record_id))
```

# Clean variable names

See [Notes on cleaning individual L2C redcap sets for merging](https://github.com/brad-cannell/link2care_public/wiki/Notes-on-cleaning-individual-L2C-redcap-sets-for-merging) for the rationale, style guidelines, and instructions for this section._

# üî¥ After you get this to work, move this section. I want all of the variable naming to exist in the Rmd code. 

## Extract content from Excel codebook

The column names in QDS and REDCap do not match. The Excel spreadsheet we import below is a key that bridges the QDS names to the REDCap names. 

```{r}
rc_col_key <- read_excel(
  "codebooks/data_usage_notes/L2C Column Name Key.xlsx",
  sheet = "QDS to REDCap Key (Final)",
  col_names = c("qds_name", "rc_name"),
  col_types = c("text", "text", rep("skip", 5)),
  skip = 1
)
```

Put current REDCap column names into a redcap frame so that we can use `left_join()` below.

```{r}
current_col_names <- tibble(current_name = names(redcap))
```

Review column names that don't have a match in the QDS.

```{r eval=FALSE}
current_col_names %>% 
  left_join(rc_col_key, by = c("current_name" = "rc_name")) %>% 
  filter(is.na(qds_name))
```

Did a manual review of current REDCap names that aren't matched to a QDS column name.

Some exceptions:   

* There is a column called redcap_event_name that contains values like a string value like, visit_4_arm_1. Thre is also a column named visit that contains only the visit number. We will drop redcap_event_name.

* There is an email column that can be dropped.

* There is an ii_v1 column, which does have a matching variable in QDS. It doesn't contain any values. we will just drop it.   

* There is a visit_v1 column, which does have a matching variable in QDS. It doesn't contain any values. we will just drop it.   

* There is a gender column and a visit_gender column. The visit_gender column contains the values -- the gender column is all missing data, but we need to change the column name from visit_gender to gender. We do that below. 

* sq_7b2 says, "You selected that you received a flyer about the study from the Dallas County Jail. Please enter the study flyer number." This variable doesn't exist in QDS. We will leave it and it will have a missing value for all QDS rows in the combined redcap.

* The well_being questions do exist in QDS, they just need to be renamed to match. We do that in the "Rename REDCap columns to match QDS" section below.

* macarthur_major_discrimination_timestamp, macarthur_major_discrimination_complete, perceived_stress_scale_timestamp, and perceived_stress_scale_complete don't exist in QDS. We will drop them.

* staffperc_q1 isn't used in QDS or REDCap. We will drop it.

```{r}
redcap <- redcap %>%
  select(
    -redcap_event_name, -email, -ii_v1, -visit_v1, 
    -macarthur_major_discrimination_timestamp, 
    -macarthur_major_discrimination_complete, 
    -perceived_stress_scale_timestamp, -perceived_stress_scale_complete,
    -staffperc_q1
  ) %>% 
  mutate(
    gender = visit_gender,
    visit_gender = NULL
  )
```

Put current REDCap column names into a redcap frame so that we can use `left_join()` below. We have to do this step again because we dropped variables above.

## Rename REDCap columns to match QDS

Create a final new set of column names. The new name will be equal to qds_name unless qds_name is missing (i.e., that variable doesn't appear in the QDS redcap). When qds_name is missing, then the column will keep its current column name.

Rename and reorder column names using `select()` like we did with the QDS redcap.

# üî¥ Sangeeta: Delete

When the code is working, please make a note that we aren't using the Excel sheet anymore and why, that it is no longer current, and that changes to the redcap names should be made directly to the code below.

```{r}
# Move this to another file after you get everything working.
# current_col_names %>% 
#   left_join(rc_col_key, by = c("current_name" = "rc_name")) %>% 
#   mutate(copy_and_paste = if_else(
#     is.na(qds_name), current_name, paste0(qds_name, " = ", current_name)
#   )) %>% 
#   pull(copy_and_paste) %>% 
#   paste(collapse = ", \n") %>% 
#   cat()
```

```{r}
redcap <- redcap %>% 
  select(
    id = record_id, 
    visit, 
    date_visit = visit_date, 
    group = group,
    sq_hispanic = sq_2, 
    sq_race = sq_3, 
    sq_age = sq_4, 
    sq_5 = sq_5, 
    sq_6 = sq_6, 
    sq_7 = sq_7, 
    sq_7a = sq_7a, 
    sq_7b = sq_7b1, 
    sq_7d = sq_7d, 
    sq_8 = sq_8, 
    sq_9 = sq_9, 
    sq_9l = sq_9l, 
    sq_10 = sq_10, 
    sq_11 = sq_11, 
    sq_12 = sq_12, 
    sq_13 = sq_13, 
    sq_14 = sq_14, 
    sq_15 = sq_15, 
    sq_16 = sq_16, 
    sq_17 = sq_17, 
    sq_18a = sq_18___0, 
    sq_18b = sq_18___1, 
    sq_18c = sq_18___2, 
    sq_18d = sq_18___3, 
    sq_18e = sq_18___4, 
    sq_18f = sq_18___5, 
    sq_18g = sq_18___6, 
    sq_18h = sq_18___7, 
    sq_18i = sq_18___8, 
    sq_19 = sq_19, 
    sq_20 = sq_20, 
    sq_21 = sq_21, 
    sq_22a = sq_22___0, 
    sq_22b = sq_22___1, 
    sq_22c = sq_22___2, 
    sq_22d = sq_22___3, 
    sq_22e = sq_22___4, 
    sq_22f = sq_22___5, 
    sq_22g = sq_22___6, 
    sq_22h = sq_22___7, 
    mms_1a = mms_1a, 
    mms_1b = mms_1b, 
    mms_1c = mms_1c, 
    mms_1d = mms_1d, 
    mms_1e = mms_1e, 
    mms_2a = mms_2a, 
    mms_2b = mms_2b, 
    mms_2c = mms_2c, 
    mms_2d = mms_2d, 
    mms_2e = mms_2e, 
    mms_3g = mms_3___1, 
    mms_3h = mms_3___2, 
    mms_3i = mms_3___3, 
    mms_3j = mms_3___0, 
    mms_4f = mms_4___0, 
    mms_4a = mms_4___1, 
    mms_4b = mms_4___2, 
    mms_4c = mms_4___3, 
    mms_4d = mms_4___4, 
    mms_4e = mms_4___5, 
    mms_5a = mms4v___1, 
    mms_5b = mms4v___2, 
    mms_5c = mms4v___3, 
    mms_5d = mms4v___4, 
    mms_5e = mms4v___5, 
    mms_5f = mms4v___0, 
    mms_6a = mms_5___1, 
    mms_6b = mms_5___2, 
    mms_6c = mms_5___3, 
    mms_6d = mms_5___0, 
    mms_7a = mms_6___1, 
    mms_7b = mms_6___2, 
    mms_7c = mms_6___0, 
    mms_8 = mms_7, 
    mms_9a = mms_8___1, 
    mms_9b = mms_8___2, 
    mms_9c = mms_8___3, 
    mms_9d = mms_8___0, 
    mms_10 = mms_9, 
    mms_11 = mms_10, 
    mms_12 = mms_11, 
    realm_a = realm___0, 
    realm_b = realm___1, 
    realm_c = realm___2, 
    realm_d = realm___3, 
    realm_e = realm___4, 
    realm_f = realm___5, 
    realm_g = realm___6, 
    realm_h = realm___7, 
    realm_i = realm___8, 
    realm_total = realm_score, 
    sq_23 = sq_23, 
    read_1 = read1_v1, 
    read_2 = read2_v1, 
    read_3 = read3_v5, 
    dem_marital_status = dem1v1, 
    dem_children = dem2v1, 
    dem_race = dem3v1, 
    dem_race_mult_white = dem4v1___1, 
    dem_race_mult_black = dem4v1___2, 
    dem_race_mult_asian = dem4v1___3, 
    dem_race_mult_pacific = dem4v1___4, 
    dem_race_mult_native = dem4v1___5, 
    dem_race_mult_other = dem4v1___6, 
    dem_edu_20_cat = dem5v1, 
    dem_edu_ged = dem5av1, 
    dem_employ_status = dem6v1, 
    dem_employ_hpw = dem6av1, 
    dem_employ_7days = dme6bv3, 
    dem_ins_medicare = dem7v1___1, 
    dem_medicaid = dem7v1___2, 
    dem_ins_military = dem7v1___3, 
    dem_ins_private = dem7v1___4, 
    dem_ins_none = dem7v1___5, 
    dem_social_security = dem8v1, 
    dem_social_security_amount = dem9v1, 
    dem_snap = dem10v1, 
    dem_snap_amount = dem11v1, 
    dem_income_source_work = dem12v1___1, 
    dem_income_source_criminalized = dem12v1___2, 
    dem_income_source_disability = dem12v1___3, 
    dem_income_source_emp_benefits = dem12v1___4, 
    dem_income_source_self_emp = dem12v1___5, 
    dem_income_source_sex = dem12v1___6, 
    dem_income_source_drugs = dem12v1___7, 
    dem_income_source_social_assistance = dem12v1___8, 
    dem_income_source_student_loans = dem12v1___9, 
    dem_income_source_friends_relatives = dem12v1___10, 
    dem_income_source_other = dem12v1___11, 
    dem_income_source_none = dem12v1___12, 
    dem_income_12_mnth_8_cat = dem13v1, 
    dem_13a = dem13av1, 
    dem_13b = dem13bv1, 
    dem_13c = dem13cv1, 
    dem_13d = dem13dv1, 
    dem_13e = dem13ev1, 
    dem_13f = dem13fv1, 
    dem_13g = dem13gv1, 
    dem_13h = dem13hv1, 
    dem_income_1_mnth_7_cat = dem14v1, 
    dem_14a = dem14av1, 
    dem_14b = dem14bv1, 
    dem_14c = dem14cv1, 
    dem_14d = dem14dv1, 
    dem_14e = dem14ev1, 
    dem_14f = dem14fv1, 
    dem_14g = dem14gv1, 
    dem_veteran = dem15v1, 
    dem_16 = dem16v1, 
    dem_sexual_orientation = dem17v1, 
    dem_transgender = dem18v1, 
    bh_1y = bh1v1y, 
    bh_1m = bh1v1m, 
    bh_1d = bh1v1d, 
    bh_2 = bh2v1, 
    bh_3 = bh3v1, 
    bh_4y = bh4v1y, 
    bh_4m = bh4v1m, 
    bh_4d = bh4v1d, 
    bh_5 = bh5v1, 
    bh_6 = bh6v1, 
    bh_7y = bh7v1y, 
    bh_7m = bh7v1m, 
    bh_7w = bh7v1w, 
    bh_8 = bh8v1, 
    bh_9 = bh9v1, 
    bh_10 = bh10v1, 
    bh_11 = bh11av1, 
    bh_12a = bh12av1___1, 
    bh_12b = bh12av1___2, 
    bh_12c = bh12av1___3, 
    bh_12d = bh12av1___4, 
    bh_12e = bh12av1___5, 
    bh_12f = bh12av1___6, 
    bh_12g = bh12av1___7, 
    bh_12h = bh12av1___8, 
    bh_12i = bh12av1___9, 
    bh_12j = bh12av1___10, 
    bh_12k = bh12av1___11, 
    bh_12l = bh12av1___12, 
    bh_13a = bh13av1___1, 
    bh_13b = bh13av1___2, 
    bh_13c = bh13av1___3, 
    bh_13d = bh13av1___4, 
    bh_13e = bh13av1___5, 
    bh_13f = bh13av1___6, 
    bh_14a = bh13bv1___1, 
    bh_14b = bh13bv1___2, 
    bh_14c = bh13bv1___3, 
    bh_14d = bh13bv1___4, 
    bh_14e = bh13bv1___5, 
    bh_14f = bh13bv1___6, 
    bh_14g = bh13bv1___7, 
    bh_14h = bh13bv1___8, 
    bh_15a = bh13cv1___1, 
    bh_15b = bh13cv1___2, 
    bh_15c = bh13cv1___3, 
    bh_15d = bh13cv1___4, 
    bh_15e = bh13cv1___5, 
    bh_15f = bh13cv1___6, 
    bh_15g = bh13cv1___7, 
    bh_15h = bh13cv1___8, 
    bh_16 = bh14v1, 
    bh_18y = bh14bv1y, 
    bh_18m = bh14bv1m, 
    bh_18w = bh14bv1w, 
    bh_18d = bh14bv3d,
    bh_19 = bh15v1, 
    bh_20 = bh15av1, 
    bh_21 = bh16v1, 
    bh_22y = bh17v1y, 
    bh_22m = bh17v1m, 
    bh_22w = bh17v1w, 
    bh_23 = bh18v1, 
    bh_24a = bh18bv1___1, 
    bh_24b = bh18bv1___2, 
    bh_24c = bh18bv1___3, 
    bh_24d = bh18bv1___4, 
    bh_24e = bh18bv1___5, 
    bh_24f = bh18bv1___6, 
    bh_24g = bh18bv1___7, 
    bh_24h = bh18bv1___8, 
    bh_24i = bh18b1v1, 
    bh_25 = bh19v1, 
    bh_26 = bh20v, 
    sss_1 = sss1_v1, 
    sss_2 = sss2_v1, 
    phq_1 = phq1_v1, 
    phq_2 = phq2_v1, 
    phq_3 = phq3_v1, 
    phq_4 = phq4_v1, 
    phq_5 = phq5_v1, 
    phq_6 = phq6_v1, 
    phq_7 = phq7_v1, 
    phq_8 = phq8_v1, 
    phq_9 = phq9_v1, 
    phq_10 = phq10_v1, 
    phq_11 = phq11_v1, 
    phq_12 = phq12_v1, 
    phq_13 = phq13_v1, 
    phq_14 = phq14_v1, 
    phq_15 = phq15_v1, 
    hs_1 = hs1_v1, 
    hs_2 = hs2_v1, 
    hs_3 = hs3_v1, 
    hs_4 = hs4_v1, 
    hs_5 = hs5_v1, 
    hs_6 = hs6_v1, 
    hs_7 = hs7_v1, 
    hs_8 = hs8_v1, 
    hs_9 = hs9_v1, 
    hs_10 = hs10_v1, 
    hs_11 = hs11_v1, 
    hs_12 = hs12_v1, 
    hrq_1 = hrq1_v1, 
    hrq_2 = hrq2_v1, 
    hrq_3 = hrq3_v1, 
    srh_1a = s2_v1___1, 
    srh_1b = s2_v1___2, 
    srh_1c = s2_v1___3, 
    srh_1d = s2_v1___4, 
    srh_1e = s2_v1___5, 
    srh_1f = s2_v1___6, 
    srh_1g = s2_v1___7, 
    srh_1h = s2_v1___8, 
    srh_2a = sr3a_v1, 
    srh_2b = sr3b_v1, 
    srh_2c = sr3c_v1, 
    srh_2d = sr3d_v1, 
    srh_2e = sr3e_v1, 
    srh_2f = sr3f_v1, 
    srh_3 = s3_v1, 
    srh_4a = s4_v1___1, 
    srh_4b = s4_v1___2, 
    srh_4c = s4_v1___3, 
    srh_4d = s4_v1___4, 
    srh_4e = s4_v1___5, 
    srh_4f = s4_v1___6, 
    srh_4g = s4_v1___7, 
    srh_4h = s4_v1___8, 
    srh_5 = s5_v1, 
    srh_6 = s6_v1, 
    srh_7a = s7_v1___1, 
    srh_7b = s7_v1___2, 
    srh_7c = s7_v1___3, 
    srh_7d = s7_v1___4, 
    srh_7e = s7_v1___5, 
    srh_7f = s7_v1___6, 
    srh_7g = s7_v1___7, 
    srh_8a = s8_v1___1, 
    srh_8b = s8_v1___2, 
    srh_8c = s8_v1___3, 
    srh_8d = s8_v1___4, 
    srh_8e = s8_v1___5, 
    srh_8f = s8_v1___6, 
    srh_8g = s8_v1___7, 
    srh_9a = s9_v1___1, 
    srh_9b = s9_v1___2, 
    srh_9c = s9_v1___3, 
    srh_9d = s9_v1___4, 
    srh_9e = s9_v1___5, 
    srh_9f = s9_v1___6, 
    srh_9g = s9_v1___7, 
    srh_9h = s9_v1___8, 
    srh_9i = s9_v1___9, 
    srh_9j = s9_v1___10, 
    srh_9k = s9_v1___11, 
    srh_9l = s9_v1___12, 
    srh_9m = s9_v1___13, 
    srh_9n = s9_v1___14, 
    srh_9o = s9_v1___15, 
    srh_9p = s9_v1___16, 
    srh_9q = s9_v1___17, 
    srh_9r = s9_v1___18, 
    srh_10 = s10_v1, 
    srh_11 = s11_v1, 
    srh_12 = s12_v1, 
    srh_13 = s13_v1, 
    srh_14a = s14_v1___1, 
    srh_14b = s14_v1___2, 
    srh_14c = s14_v1___3, 
    srh_14d = s14_v1___4, 
    srh_15 = s15_v1, 
    srh_16 = s16_v1, 
    srh_17 = s17_v1, 
    srh_18a = s18_v1___1, 
    srh_18b = s18_v1___2, 
    srh_18c = s18_v1___3, 
    srh_18d = s18_v1___4, 
    srh_18e = s18_v1___5, 
    srh_18f = s18_v1___6, 
    srh_18g = s18_v1___7, 
    srh_18h = s18_v1___8, 
    srh_18i = s18_v1___9, 
    srh_18j = s18_v1___10, 
    srh_18k = s18_v1___11, 
    srh_18l = s18_v1___12, 
    srh_19 = s19_v1, 
    srh_20 = s20_v1, 
    srh_21 = s21_v1, 
    srh_22 = s22_v1, 
    srh_23 = s23_v1, 
    srh_24a = s24_v1___1, 
    srh_24b = s24_v1___2, 
    srh_24c = s24_v1___3, 
    srh_24d = s24_v1___4, 
    srh_24e = s24_v1___5, 
    srh_24f = s24_v1___6, 
    srh_25 = s25a_v1, 
    srh_26a = s26a_v1___1, 
    srh_26b = s26a_v1___2, 
    srh_26c = s26a_v1___3, 
    srh_26d = s26a_v1___4, 
    srh_26e = s26a_v1___5, 
    srh_26f = s26a_v1___6, 
    srh_26g = s26a_v1___7, 
    srh_27 = s25b_v1, 
    srh_28a = s26b_v1___1, 
    srh_28b = s26b_v1___2, 
    srh_28c = s26b_v1___3, 
    srh_28d = s26b_v1___4, 
    srh_28e = s26b_v1___5, 
    srh_28f = s26b_v1___6, 
    srh_28g = s26b_v1___7, 
    srh_29 = s25c_v1, 
    srh_30a = s26c_v1___1, 
    srh_30b = s26c_v1___2, 
    srh_30c = s26c_v1___3, 
    srh_30d = s26c_v1___4, 
    srh_30e = s26c_v1___5, 
    srh_30f = s26c_v1___6, 
    srh_30g = s26c_v1___7, 
    srh_31 = s25d_v1, 
    srh_32a = s26d_v1___1, 
    srh_32b = s26d_v1___2, 
    srh_32c = s26d_v1___3, 
    srh_32d = s26d_v1___4, 
    srh_32e = s26d_v1___5, 
    srh_32f = s26d_v1___6, 
    srh_32g = s26d_v1___7, 
    srh_33 = s25e_v1, 
    srh_34a = s26e_v1___1, 
    srh_34b = s26e_v1___2, 
    srh_34c = s26e_v1___3, 
    srh_34d = s26e_v1___4, 
    srh_34e = s26e_v1___5, 
    srh_34f = s26e_v1___6, 
    srh_34g = s26e_v1___7, 
    srh_35 = s27_v1, 
    srh_36 = s28_v1, 
    srh_37 = s29_v1, 
    srh_38a = s30_v1___1, 
    srh_38b = s30_v1___2, 
    srh_38c = s30_v1___3, 
    srh_38d = s30_v1___4, 
    srh_38e = s30_v1___5, 
    srh_38f = s30_v1___6, 
    srh_38g = s30_v1___7, 
    srh_39 = s31_v1, 
    srh_40a = s32_v1___1, 
    srh_40b = s32_v1___2, 
    srh_40c = s32_v1___3, 
    srh_40d = s32_v1___4, 
    srh_40e = s32_v1___5, 
    srh_40f = s32_v1___6, 
    srh_40g = s32_v1___7, 
    srh_40h = s32_v1___8, 
    srh_40i = s32_v1___9, 
    srh_41 = s33_v1, 
    srh_42 = s34_v1, 
    srh_43 = s35_v1, 
    srh_44 = s36_v1, 
    srh_45 = s37_v1, 
    srh_46 = s38_v1, 
    srh_47 = s39a_v1, 
    srh_48 = s39b_v1, 
    srh_49 = s40_v1, 
    srh_50 = s41_v1, 
    srh_51 = s42_v1, 
    srh_52a = s43_v1___1, 
    srh_52b = s43_v1___2, 
    srh_52c = s43_v1___3, 
    srh_52d = s43_v1___4, 
    srh_52e = s43_v1___5, 
    srh_52f = s43_v1___6, 
    srh_52g = s43_v1___7, 
    srh_52h = s43_v1___8, 
    srh_52i = s43_v1___9, 
    ds_1 = ds1_v2, 
    ds_2 = ds2_v2, 
    ds_3 = ds3_v2, 
    ds_4 = ds4_v2, 
    ds_5 = ds5_v2, 
    ds_6 = ds6_v2, 
    ds_7 = ds7_v2, 
    ds_8 = ds8_v2, 
    ds_9 = ds9_v2, 
    ds_10a = ds10a_v2, 
    ds_10b = ds10b_v2, 
    ds_11a = ds11a_v2, 
    ds_11b = ds11b_v2, 
    ptsd_1 = ptsd1_v1, 
    ptsd_2 = ptsd2_v1, 
    ptsd_3 = ptsd3_v1, 
    ptsd_4 = ptsd4_v1, 
    brac_1 = brac1, 
    brac_2 = brac2, 
    brac_3 = brac3, 
    brac_4 = brac4, 
    brac_5 = brac5, 
    brac_6 = brac6, 
    brac_7 = brac7, 
    brac_8 = brac8, 
    brac_9 = brac9, 
    brac_10 = brac10, 
    brac_11 = brac11, 
    t_1 = t1_v1, 
    t_2 = t2_v1, 
    t_3y = t3a_v1y, 
    t_3m = t3a_v1m, 
    t_4 = t3b_v1, 
    t_5 = t4_v1, 
    t_6 = t5_v1, 
    t_6a = t5a1_v1, 
    t_6b = t5a2_v1, 
    t_6c = t5a3_v1, 
    t_6d = t5a4_v1, 
    t_6e = t5a5_v1, 
    t_6f = t5a6_v1, 
    t_7 = t6_v1, 
    t_7a = t6a1_v1, 
    t_7b = t6a2_v1, 
    t_7c = t6a3_v1, 
    t_7d = t6a4_v1, 
    t_7e = t6a5_v1, 
    t_7f = t6a6_v1, 
    t_8 = t7_v1, 
    t_9 = t8_v1, 
    t_10 = t9_v1, 
    t_11 = t10_v1, 
    t_12 = t11_v1, 
    t_13 = t12_v1, 
    t_13a = t12a_v1, 
    t_13b = t12b_v1, 
    t_14 = t13_v1, 
    t_15a = t14_v1___1, 
    t_15b = t14_v1___2, 
    t_15c = t14_v1___3, 
    t_15d = t14_v1___4, 
    t_15e = t14_v1___5, 
    t_15f = t14_v1___6, 
    t_15g = t14_v1___7, 
    t_15h = t14_v1___8, 
    t_15i = t14_v1___9, 
    t_16 = t15_v1, 
    t_17 = t16_v1, 
    t_18 = t17_v1, 
    t_19 = t18_v1, 
    t_20 = t19_v1, 
    t_21 = t20_v1, 
    t_22 = t21_v1, 
    t_23 = t22_v1, 
    t_24a = t23_v1___1, 
    t_24b = t23_v1___2, 
    t_24c = t23_v1___3, 
    t_24d = t23_v1___4, 
    t_24e = t23_v1___5, 
    t_24f = t23_v1___6, 
    t_24g = t23_v1___7, 
    t_24h = t23_v1___8, 
    t_25 = t24_v1, 
    t_26 = t25_v1, 
    t_27 = t26_v1___1, 
    t_27a = t26_v1___2, 
    t_27b = t26_v1___3, 
    t_27c = t26_v1___4, 
    t_27d = t26_v1___5, 
    t_27e = t26_v1___6, 
    t_28 = t27_v1, 
    t_29 = t28_v1, 
    t_30 = t29_v1, 
    t_31 = t30_v1, 
    t_32a = t31_v1___1, 
    t_32b = t31_v1___2, 
    t_32c = t31_v1___3, 
    t_32d = t31_v1___4, 
    t_32e = t31_v1___5, 
    t_32f = t31_v1___6, 
    t_32g = t31_v1___7, 
    t_32h = t31_v1___8, 
    t_32i = t31_v1___9, 
    t_32j = t31_v1___10, 
    t_33a = t31b_v1___1, 
    t_33b = t31b_v1___2, 
    t_33c = t31b_v1___3, 
    t_34 = t32_v1, 
    t_35a = t33_v1___1, 
    t_35b = t33_v1___2, 
    t_35c = t33_v1___3, 
    t_35d = t33_v1___4, 
    t_35e = t33_v1___5, 
    t_35f = t33_v1___6, 
    t_35g = t33_v1___7, 
    t_35h = t33_v1___8, 
    t_35i = t33_v1___9, 
    t_35j = t33_v1___10, 
    t_36 = t34_v1, 
    t_37 = t35_v1, 
    t_38 = t36_v1, 
    t_39 = t37_v1, 
    t_40 = t38_v1, 
    t_41 = t39_v1, 
    t_42 = t40_v1, 
    hsi_1 = hsi1_v1, 
    hsi_2 = hsi2_v13, 
    brs_1 = brs1_v1, 
    brs_2 = brs2_v1, 
    brs_3 = brs3_v1, 
    brs_4 = brs4_v1, 
    brs_5 = brs5_v1, 
    af_1 = af1_v1, 
    af_2m = af2m_v1, 
    af_3tu = af3tu_v1, 
    af_4w = af4w_v1, 
    af_5th = af5th_v1, 
    af_6f = af6f_v1, 
    af_6sa = af6sa_v1, 
    af_8su = af8su_v1, 
    af_drinks = drinks, 
    af_9 = af9_v1, 
    af_9a = af9a_v1, 
    af_9b = af9b_v1, 
    af_9c = af9c_v1, 
    pbq_1 = pbq1, 
    pbq_2 = pbq2, 
    pbq_3 = pbq3, 
    pbq_4 = pbq4, 
    pbq_5 = pbq5, 
    pbq_6 = pbq6, 
    pbq_7 = pbq7, 
    fss_1 = fss1_v2, 
    fss_2 = fss2_v2, 
    fss_3 = fss3_v2, 
    fss_3a = fss3a_v2, 
    fss_4 = fss4_v2, 
    fss_5 = fss5_v2, 
    ms_1 = ms1_v1, 
    ms_2 = ms2_v1, 
    ms_3 = ms3_v1, 
    ms_4 = ms8_v1, 
    cj_1 = cj1_v2, 
    cj_2 = cj2_v2, 
    cj_3 = cj3_v2, 
    cj_4 = cj4_v2, 
    cj_5 = cj5_v2, 
    cj_6 = cj6_v2, 
    cj_7 = cj7_v2, 
    cj_8 = cj8_v2, 
    cj_9 = cj9_v2, 
    cj_10 = cj10_v2, 
    cj_11 = cj11_v2, 
    cj_12 = cj12_v2, 
    cj_13 = cj13_v2, 
    cj_14 = cj14_v2, 
    cj_15 = cj15_v2, 
    cj_16 = cj16_v2, 
    cj_17 = cj17_v2, 
    cj_18 = cj18_v2, 
    cj_19 = cj19_v2, 
    cj_20 = cj20_v2, 
    cj_21 = cj21_v2, 
    cj_22 = cj22_v2, 
    cj_23 = cj23_v2, 
    cj_24 = cj24_v2, 
    cj_25 = cj25_v2, 
    cj_26 = cj26_v2, 
    cj_27 = cj27_v2, 
    cj_28 = cj28_v2, 
    cj_29 = cj29_v2, 
    cj_30 = cj30_v2, 
    cj_31 = cj31_v2, 
    cj_32 = cj32_v2, 
    cj_33 = cj33_v2, 
    cj_34 = cj34_v2, 
    cj_35 = cj35_v2, 
    cj_36 = cj36_v2, 
    cj_37 = cj37_v2, 
    cj_38 = cj38_v2, 
    cj_39 = cj39_v2, 
    cj_40 = cj40_v2, 
    sb_1 = sb1_v1, 
    sb_2 = sb2_v1, 
    sb_3 = sb3_v1, 
    sb_4 = sb4_v1, 
    sb_5 = sb5_v1, 
    sb_6 = sb6_v1, 
    sb_7a = sb7_v1___1, 
    sb_7b = sb7_v1___2, 
    sb_7c = sb7_v1___3, 
    sb_7d = sb7_v1___4, 
    sb_7e = sb7_v1___5, 
    sb_7f = sb7_v1___6, 
    sb_7g = sb7_v1___7, 
    sb_8 = sb8_v1, 
    sb_9 = sb9_v1, 
    vac_1 = vac1, 
    vac_2 = vac2, 
    vac_3 = vac3, 
    well_being_1 = well_being1,
    well_being_2 = well_being2,
    well_being_3 = well_being3,
    dd_1 = dd1_v1, 
    dd_2 = dd2_v1, 
    dd_3 = dd3_v1, 
    dd_4 = dd4_v1, 
    dd_5 = dd5_v1, 
    dd_6 = dd6_v1, 
    dd_7 = dd7_v1, 
    dd_8 = dd8_v1, 
    dd_9 = dd9_v1, 
    dd_10 = dd10_v1, 
    mmd_1a = mmd1a, 
    mmd_1b = mmd1b, 
    mmd_1c = mmd1c, 
    mmd_1d = mmd1d, 
    mmd_1e = mmd1e, 
    mmd_1f = mmd1f, 
    mmd_1g = mmd1g, 
    mmd_1h = mmd1h, 
    mmd_1i = mmd1i, 
    mmd_1j = mmd1j, 
    mmd_1k = mmd1k, 
    mmd_2 = mmd2, 
    mmd_3 = mmd3, 
    mmd_4 = mmd4, 
    uls_1 = uls1_v2, 
    uls_2 = uls2_v2, 
    uls_3 = uls3_v2, 
    uls_4 = uls4_v2, 
    uls_5 = uls5_v2, 
    uls_6 = uls6_v2, 
    uls_7 = uls7_v2, 
    uls_8 = uls8_v2, 
    uls_9 = uls9_v2, 
    uls_10 = uls10_v2, 
    uls_11 = uls11_v2, 
    uls_12 = uls12_v2, 
    uls_13 = uls13_v2, 
    uls_14 = uls14_v2, 
    uls_15 = uls15_v2, 
    uls_16 = uls16_v2, 
    uls_17 = uls17_v2, 
    uls_18 = uls18_v2, 
    uls_19 = uls19_v2, 
    uls_20 = uls20_v2, 
    uls_21 = uls21_v2, 
    pv_1 = pv1_v2, 
    pv_2 = pv2_v2, 
    pv_3 = pv3_v2, 
    ps_1 = ps1_v2, 
    ps_2 = ps2_v2, 
    ps_3 = ps3_v2, 
    ps_4 = ps4_v2, 
    dts_1 = dts1_v2, 
    dts_2 = dts2_v2, 
    dts_3 = dts3_v2, 
    dts_4 = dts4_v2, 
    dts_5 = dts5_v2, 
    dts_6 = dts6_v2, 
    dts_7 = dts7_v2, 
    dts_8 = dts8_v2, 
    dts_9 = dts9_v2, 
    dts_10 = dts10_v2, 
    dts_11 = dts11_v2, 
    dts_12 = dts12_v2, 
    dts_13 = dts13_v2, 
    dts_14 = dts14_v2, 
    dts_15 = dts15_v2, 
    dts_16 = dts16_v2, 
    aq_1 = aq1_v1, 
    aq_2 = aq2_v1, 
    aq_3 = aq3_v1, 
    aq_4 = aq4_v1, 
    aq_5 = aq5_v1, 
    aq_6 = aq6_v1, 
    aq_7 = aq7_v1, 
    aq_8 = aq8_v1, 
    aq_9 = aq9_v1, 
    aq_10 = aq10_v1, 
    aq_11 = aq11_v1, 
    aq_12 = aq12_v1, 
    ces_1 = ces1_v1, 
    ces_2 = ces2_v1, 
    ces_3 = ces3_v1, 
    ces_4 = ces4_v1, 
    ces_5 = ces5_v1, 
    ces_6 = ces6_v1, 
    ces_7 = ces7_v1, 
    ces_8 = ces8_v1, 
    ces_9 = ces9_v1, 
    ces_10 = ces10_v1, 
    is_1 = is1_v1, 
    is_2 = is2_v1, 
    is_3 = is3_v1, 
    is_4 = is4_v1, 
    is_5 = is5_v1, 
    is_6 = is6_v1, 
    is_7 = is7_v1, 
    is_8 = is8_v1, 
    is_9 = is9_v1, 
    is_10 = is10_v1, 
    is_11 = is11_v1, 
    is_12 = is12_v1, 
    rp_1 = rp1_v1, 
    rp_2 = rp2_v1, 
    lsn_1 = lsn1_v1, 
    lsn_2 = lsn2_v1, 
    lsn_3 = lsn3_v1, 
    lsn_4 = lsn4_v1, 
    lsn_5 = lsn5_v1, 
    lsn_6 = lsn6_v1, 
    r_1 = r1_v1, 
    r_2 = r2_v1, 
    r_3 = r3_v1, 
    r_4 = r4_v1, 
    r_5 = r5_v1, 
    r_6 = r6_v1, 
    r_7 = r7_v1, 
    r_8 = r8_v1, 
    r_9 = r9_v1, 
    r_11 = r11_v1, 
    r_12 = r11b_v1, 
    r_13 = r12_v1, 
    r_14 = r13_v1, 
    r_15 = r14_v1, 
    r_16a = r15_v1___1, 
    r_16b = r15_v1___2, 
    r_16c = r15_v1___3, 
    r_16d = r15_v1___4, 
    r_16e = r15_v1___5, 
    r_16f = r15_v1___6, 
    r_16g = r15_v1___7, 
    r_16h = r15_v1___8, 
    r_16i = r15_v1___9, 
    r_16j = r15_v1___10, 
    r_16k = r15_v1___11, 
    r_16l = r15_v1___12, 
    r_16m = r15_v1___13, 
    r_16n = r15_v1___14, 
    r_16o = r15_v1___15, 
    bpm_1 = bpm1_v1, 
    bpm_2 = bpm2_v1, 
    bpm_3 = bpm3_v1, 
    bpm_4 = bpm4_v1, 
    bpm_5a = bpm5_v1___0, 
    bpm_5b = bpm5_v1___1, 
    bpm_5c = bpm5_v1___2, 
    bpm_5d = bpm5_v1___3, 
    bpm_5e = bpm5_v1___4, 
    bpm_5f = bpm5_v1___5, 
    bpm_5g = bpm5_v1___6, 
    tq_1_1 = tq1_1v3, 
    tq_2_1 = tq2_1v3, 
    tq_14_1 = tq14_1v3, 
    tq_1_2 = tq1_2v3, 
    tq_2_2 = tq2_2v3, 
    tq_3_2 = tq3_2v3, 
    tq_4_2 = tq4_2v3, 
    tq_9_2 = tq9_2v3, 
    tq_10_2 = tq10_2v3, 
    tq_11_2 = tq11_2v3, 
    tq_12_2 = tq12_2v3, 
    tq_13_2 = tq13_2v3, 
    tq_14_2 = tq14_2v3, 
    tq_1_3 = tq1_3v3, 
    tq_2_3 = tq2_3v3, 
    tq_3_3 = tq3_3v3, 
    tq_4_3 = tq4_3v3, 
    tq_5_3 = tq5_3v3, 
    tq_6_3 = tq6_3v3, 
    tq_7_3 = tq7_3v3, 
    tq_8_3 = tq8_3v3, 
    tq_9_3 = tq9_3v3, 
    tq_10_3 = tq10_3v3, 
    tq_11_3 = tq11_3v3, 
    tq_12_3 = tq12_3v3, 
    tq_13_3 = tq13_3v3, 
    tq_14_3 = tq14_3v3, 
    everything()
)
```


# Data management 

## Change group number

2023-03-20 PTs 2336 and 2349 have incorrect grouping in REDCap. Manually fix grouping errors for both PTs to match QDS and Master Log.

```{r}
redcap$group[redcap$id == 2336] <- 3
redcap$group[redcap$id == 2349] <- 2
```

## Change visit number

2023-08-25: participant 2349 had their baseline visit on 2022-02-28. The other visit marked as visit 1 on 2022-04-12 in the combined_participant_data was pulled from REDCap. It was actually their visit 3. We correct that error below

```{r}
redcap$visit[redcap$id == 2349 & redcap$date_visit == "2022-04-12"] <- 3
```

# Remove all screening variables

2023-05-11: Screening questions were built into REDCap, but it was never actually used to collect screening data. Therefore, the screening question columns all contain missing data. Will will remove those here to make the data easier to work with.

First, which columns contain nothing but missing data?

```{r}
all_missing <- names(which(colSums(is.na(redcap)) == nrow(redcap))) # 176
```

There are 181 columns that contain nothing but missing data. Sangeeta reviewed them and determined that they are all screening and randomization questions or visit 2 questions. REDCap was not used to collect that data. We will drop those columns now.

NOTE: The vac_2 column is dropped above because it contains only missing data. It is supposed to contain the date of the participants first COVID vaccine. There are cases where the date of the second vaccine is listed, but no first vaccine. Sangeeta and Brad thought that was weird and looked into it. Although, the vac_2 variable appears in the REDCap codebook, it wasn't actually displayed to participants when they were completing REDCap.

```{r}
redcap <- redcap %>% 
  select(-all_of(all_missing))
```

```{r}
dim(redcap) # 108 659
```

# Coerce variable types

This will facilitate merging in QDS in data_survey_21_merge.Rmd.

```{r}
redcap <- redcap %>% 
  mutate(
    vac_3 = as.character.Date(vac_3),
    date_visit = as.Date(date_visit)
  )
```


# üíæSave the redcap frame

```{r}
path <- "data/redcap/redcap_import.rds"
```

```{r}
write_rds(redcap, path)
```

Print a message for when this file is being sourced

```{r}
cat(
  paste0(Sys.Date(), ":"),
  "REDCap Data saved to", path
)
```


# üóëClean up

Don't use `rm(list = ls())` because is causes R to drop the helper functions in redcap_survey_21_update_all_redcap.Rmd

```{r}
rm(list = ls()[ls() != "source_rmd"])
```



---
title: "Import and manage Link2Care Survey Data"
date: "2020-12-23"
---

This file is used to import the Link2Care follow-up visit survey data and do some initial data cleaning (e.g., create calculated variables). 

**NOTE on data sources:**
* Initially, I tried to separate importing the data from QDS, REDCap, and the Excel master log. However, that doesn't work very well because the three different data sources are so intertwined. For example, some people have visit 1 in QDS and visit 2 in REDCap. Further, the QDS data often doesn't contain every participant's group membership information (i.e., which study arm the participants were randomly assigned to). Therefore, we kind of need to import all three data sources and combine them to create complete follow-up visit survey data.

* The QDS data is exported from QDS in SPSS data format. The data has to be exported by visit (i.e., v1, v2, ... v5). The SPSS data is then added to the UTHealth servers.

* Some of the v3-v5 visits are also done using REDCap. That data is exported from REDCap and added to the UTHealth servers. Because I'm only creating tables of statistics from baseline visit right now, I'm not currently importing and cleaning the REDCap data. Correction, I still need the REDCap data for group membership at v3-v5.

**NOTE on Kiteworks:**
Currently, I'm importing all of this data from the UTHealth server. The data should also be available on Kiteworks if you are unable to connect to the server for some reason.

# ðŸ“¦Load packages

```{r}
library(dplyr, warn.conflicts = FALSE)
library(haven, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)
library(readxl, warn.conflicts = FALSE)
library(purrr, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(stringr, warn.conflicts = FALSE)
library(forcats, warn.conflicts = FALSE)
```

```{r}
path <- "../Participant Data/R data/combined_participant_data.rds"
```

```{r}
combined_participant_data <- read_rds(path)
```

```{r}
# Print a message for when this file is being sourced
cat(
  paste0(Sys.Date(), ":"),
  path, "imported as", "combined_participant_data", 
  "with", nrow(combined_participant_data), "rows and", 
  ncol(combined_participant_data), "columns.\n"
)
```


# ðŸš§Data management 

**NOTE on converting to lowercase:** 
* Don't convert all variable names to lowercase. Leaving the column names in uppercase makes it easier to use the Word code book and the SPSS code that Michael wrote. 
* Make all calculated/created variables that will be used for analysis using lowercase names.

## Create a single group variable

Instead of group_v3, group_v4, and group_v5 (which can be conflicting). 

First, gather all of the group information from the v3-v5 QDS data. We aren't using v1 and v2 because group membership isn't in the QDS survey at v1 and v2 (which is part of the problem).

As of 2023-03-20 the combined dataset accounts for the group membership issue. This has been fixed and will include v1 and v2 for long dataset.

## ðŸ§®Recode/calculate variables by section

1. Make variable names more descriptive
2. Change skip values (e.g., 9, 99, etc.) to missing
3. Make factor versions of categorical variables

**NOTE:** Can't put this section higher because we need to do the steps above first.

**NOTE on changing variable names:** The variable names aren't very descriptive. At first, my plan was to resist the urge to change them in this file. My thought was that I wanted the data that comes out of this file to have variable names that match the variables names in the codebook files. Then I realized, however, that none of the calculated variables will be in the codebook files anyway. Also, there isn't a codebook file for the combined survey data set. So, we can go ahead and rename variables in this file. We will either have to create a new codebook for the combined data or just live without one. 

**NOTE on calculating over multiple visits:** Right now (2021-01-26), I'm only using this data to calculate baseline descriptive stats. Meaning, I'm only concerned with values at visit 1 and visit 2 (i.e., for some questions that weren't asked at visit 1). In the future, we will probably need to rewrite this code to iterate over multiple visits as well. For now, I'm not worrying about it.

### Helper functions

#### Convert 9's (or 7's, or 8's) to NA's and then add attributes back to vector.

First, I have to remove the "have_labelled" and "vctrs_vctr" class from each variable for if_else() to work.

But, I also need to keep the label attributes. They are erased when I convert the 9's to NA.

```{r}
nines_to_na <- function(x, nines) {
  # Store the attributes
  x_attr <- attributes(x)
  # Remove "haven_labelled" and "vctrs_vctr" from class list so that if_else()
  # will work.
  # Set class of column to whatever is remaining in the class list.
  classes <- class(x)
  class(x) <- classes[!class(x) %in% c("haven_labelled", "vctrs_vctr")]
  # Convert 9's to NA's
  x <- if_else(x %in% nines, NA_real_, x)
  # Add attributes back to the vector
  attributes(x) <- x_attr
  # Return x
  x
}

# For testing
# test <- combined_participant_data
# test$SQ_13[1] <- 7
# test$SQ_13[3] <- 9
# test$SQ_13[4] <- 99
# test %>% 
#   select(SQ_13) %>% 
#   mutate(SQ_13_test = nines_to_na(SQ_13, c(7, 9, 99))) %>% 
#   pull(SQ_13_test) %>% 
#   attributes()
# rm(test)
```

#### Use SPSS labels as factor levels for categorical variables

```{r}
# For use inside across()
spss_to_fs <- function(x) {
  levs <- attr(x, "labels")
  labs <- names(levs)
  x_f <- factor(x, levs, labs)
  x_f
}

# For testing
# combined_participant_data %>%
#   select(SQ_2, SQ_3) %>%
#   mutate(
#     across(
#       everything(),
#       spss_to_fs,
#       .names = "{col}_f"
#     )
#   )
```

### ðŸ“„Template

Save for cleaning additional variables below.

```{r}
# combined_participant_data %>%
#   # For data checks
#   select() %>%
#   # X:Y doesn't immediately follow Z
#   # Make variable names more descriptive
#   rename(
# 
#   ) %>%
# 
#   # Change skip values (e.g., 9, 99, etc.) to missing
#   mutate(
#     across(
#       c(),
#       ~ nines_to_na(.x, )
#     )
#   ) %>%
# 
#   # Make factor versions of categorical variables
#   mutate(
#     across(
#       c(),
#       spss_to_fs,
#       .names = "{col}_f"
#     )
#   )
```

### 1. Administrative and Exclusion Criteria

### 2. Screening Questions (SQ)

* Visit 1, Section 2, Q20-Q30

**NOTE on SQ_18, Which of the following forms of media do you use?**
We may eventually want to combine these into a "multiple forms" category.

```{r}
combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(SQ_12:SQ_21, SQ_18A:SQ_18I) %>% 
  # SQ_18A:SQ_18I doesn't immediately follow SQ_18
  # Make variable names more descriptive
  rename(
    cell_have = sq_12, 
    cell_pays = sq_13, #9
    cell_talk_minutes = sq_14, #9
    cell_smart = sq_15, #9
    cell_data_plan = sq_16, #9
    cell_number_change = sq_17, #999
    media_use_email = sq_18a,
    media_use_facebook = sq_18b,
    media_use_google_plus = sq_18c,
    media_use_twitter = sq_18d,
    media_use_blogs = sq_18e,
    media_use_instagram = sq_18f,
    media_use_snapchat = sq_18g,
    media_use_linkedin = sq_18h,
    media_use_none = sq_18i,
    access_internet = sq_19,
    facebook_active = sq_20,
    facebook_check = sq_21, #9
  ) %>%
  # Change skip values (e.g., 9, 99, etc.) to missing
  mutate(
    across(
      c(cell_pays:cell_data_plan, facebook_check),
      ~ nines_to_na(.x, 9)
    ),
    across(
      cell_number_change,
      ~ nines_to_na(.x, 999)
    )
  ) %>% 
  
  # Make factor versions of categorical variables
  mutate(
    across(
      c(
        cell_have:cell_number_change, media_use_email:media_use_none,
        access_internet:facebook_check
      ),
      spss_to_fs,
      .names = "{col}_f"
    )
  )
```

### 3. Mini Mental Status Exam Score (MMS)

* Visit 1, Section 3, Q31-Q50

### 4. Realm

* Visit 1, Section 4, Q51-Q53

### 5. Biological/Anthropometric Measures

* Visit 1, Section 5, Q54-Q60

### 6. Socioeconomic Status/Demographic Questionnaires

* Visit 1, Section 6, No questions

### 7. Demographic/Background Information Questionnaire (DEM)

### 8. The Brief Homelessness Questionnaire (bh)

* Visit 1, Section 8, Q97-Q122

2020-12-24, from Michael: Use bh15V1 for number of times arrested.

```{r}
  # For data checks
  # select(bh1V1:bh4V1, bh4V1Y:bh4V1D, bh12AV1A:bh12AV1L, bh15V1) %>%
  # bh4V1Y:bh4V1D doesn't immediately follow bh4V1D
  # bh12AV1A:bh12AV1L doesn't immediately follow bh12AV1
  # Make variable names more descriptive
combined_participant_data <- combined_participant_data %>%
  rename(
    homeless_time_total = bh_1, #9999
    homeless_periods = bh_2, #9
    homeless_age_first_time = bh_3, #999
    homeless_current_total = bh_4, #9999
    homeless_mental_treatment = bh_5, #9
    homeless_reason_total = bh_12, #9999
    homeless_reason_not_homeless = bh_12a, #9
    homeless_reason_lost_job = bh_12b, #9
    homeless_reason_evicted = bh_12c, #9
    homeless_reason_substance = bh_12d, #9
    homeless_reason_mental_illness =bh_12e, #9
    homeless_reason_medical_bills = bh_12f, #9
    homeless_reason_family = bh_12g, #9
    homeless_reason_legal = bh_12h, #9
    homeless_reason_jail = bh_12i, #9
    homeless_reason_natural_disaster = bh_12j, #9
    homeless_reason_domestic_violence = bh_12k, #9
    homeless_reason_other = bh_12l, #9
    jail_lifetime_n = bh_15 #99
  ) %>%

  # Change skip values (e.g., 9, 99, etc.) to missing
  mutate(
    across(
      c(
        homeless_periods, homeless_mental_treatment,
        homeless_reason_not_homeless:homeless_reason_other
      ),
      ~ nines_to_na(.x, 9)
    ),
    across(
      c(jail_lifetime_n),
      ~ nines_to_na(.x, 99)
    ),
    across(
      c(
        homeless_age_first_time
      ),
      ~ nines_to_na(.x, 999)
    ),
    across(
      c(homeless_time_total, homeless_current_total),
     ~ nines_to_na(.x, 9999)
    )
  ) %>%

  # Make factor versions of categorical variables
  mutate(
    across(
      c(homeless_periods, homeless_mental_treatment, jail_lifetime_n),
      spss_to_fs,
      .names = "{col}_f"
    )
  )

# VARIABLE LABELS
attr(combined_participant_data$homeless_time_total, "label") <- "What is the total amount of time you have been homeless in your lifetime? (Months)"
attr(combined_participant_data$homeless_periods_f, "label") <- "How many separate periods of homelessness have you had in your lifetime?"
attr(combined_participant_data$homeless_age_first_time, "label") <- "How old were you the first time you became homeless?"
attr(combined_participant_data$homeless_current_total, "label") <- "How long ago did the current period of homelessness begin? (Months)"
attr(combined_participant_data$homeless_reason_total, "label") <- "What are the reasons for your current homelessness?"
attr(combined_participant_data$homeless_mental_treatment_f, "label") <- "Are you currently receiving treatment for mental health problems (For example: Depression, Bipolar Disorder, Anxiety)?"
attr(combined_participant_data$jail_lifetime_n_f, "label") <- "During your lifetime, how many separate times have you been to jail or prison?"
```

Calculate jail time

2020-12-24, from Michael: "You will have to calculate total time in jail because the current variable does not include decimals â€“ here is the syntax to calculate the lifetime period in jail variable: bh17V1Y + bh17v1M/12 + bh17v1w/52."

Just out of curiosity, I checked for differences between jail_time_total and jail_time_total_c. They are almost identical.

```{r}
combined_participant_data <- combined_participant_data %>%
  rename(
    jail_time_total = bh_17)
# VARIABLE LABELS
attr(combined_participant_data$jail_time_total, "label") <- "During your lifetime, how much time have you spent in jail or prison? (Years)"
```

### 9. MacArthur Scale of Subjective Social Status (SSS)

* Visit 1, Section 9, Q123-Q124

### 10. Health, Mental Health, and Health Behavior 

* Visit 1, Section 10, No questions
* Visit 2, Section 1, No questions

### 11. Patient Health Questionnaire (PHQ)

* Visit 1, Section 11, Q125-Q139

#### 11.1 PHQ 8

* Visit 1, Q125-Q132

PHQ 8 score greater than 10
Requested by Michael 2020-12-11

```{r}
# Imported from Visit 1.sps
combined_participant_data <- combined_participant_data %>% 
  mutate(
    phq_8_total = phq_1 + phq_2 + phq_3 + 
      phq_4 + phq_5 + phq_6 + phq_7 + 
      phq_8,
    phq_8_gt_10 = as.numeric(phq_8_total > 10),
    phq_8_gt_10_f = factor(phq_8_gt_10, 0:1, c("No", "Yes"))
  )

# VARIABLE LABELS 
attr(combined_participant_data$phq_8_total, "label") <- "Sum of phq_1-phq_8"
attr(combined_participant_data$phq_8_gt_10, "label") <- "PHQ 8 total score greater than 10"

# VALUE LABELS 
attr(combined_participant_data$phq_8_gt_10, "labels") <-  c('No' = 0, 'Yes' = 1) 
```

```{r}
# Clean up
rm(d, i, phq_8_val_labs, phq_8_var_labs, phq_8_vars)
```

#### 11.2 PHQ GAD-7

### 12. SF-12 Health Survey (HS)

* Visit 1, Section 12, Q140-Q151

General health question

```{r}
# Imported from Visit 1.sps
combined_participant_data <- combined_participant_data %>%
  mutate(
    gen_health = nines_to_na(hs_1, 9),
    gen_health_dichot = case_when(
      hs_1 == 1 | hs_1 == 2 | hs_1 == 3 ~ 0,
      hs_1 == 4 | hs_1 == 5 ~ 1
    )
  )

# VARIABLE LABELS
attr(combined_participant_data$gen_health_dichot, "label") <- "Self rated health fair or poor"

# VALUE LABELS 
attr(combined_participant_data$gen_health_dichot, "labels") <- c(
  "excellent to good health" = 0,
  "fair or poor health" = 1
)

combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(gen_health_v1, gen_health_dichot_v1) %>%
  # Make factor versions of categorical variables
  mutate(
    across(
      c(gen_health, gen_health_dichot),
      spss_to_fs,
      .names = "{col}_f"
    )
  )
```

Helpful scoring documentation: https://www.researchgate.net/profile/John_Ware/publication/291994160_How_to_score_SF-12_items/links/58combined_participant_datac467a6fdcc41bf920748/How-to-score-SF-12-items.pcombined_participant_data

Pull out the SF-12 items

```{r}
sf12 <- select(combined_participant_data, hs_1:hs_12)
names(sf12) <- c(
  "gh1", "pf02", "pf04", "rp2", "rp3", "re2", "re3", "bp2", "mh3", "vt2", "mh4", 
  "sf2"
)
sf12 <- mutate(sf12, across(everything(), as.numeric))
```

#### Step 1. Data cleaning and item recoding

```{r}
sf12 <- sf12 %>% 
  mutate(
    # Recode 7, 8, 9 to NA
    across(
      everything(),
      .fns = function(x) {
        x[x == 7] <- NA
        x[x == 8] <- NA
        x[x == 9] <- NA
        x
      }
    )
  )
```

Make sure all items are within range.

```{r rows.print=12}
sf12 %>% 
  summarise(
    across(
      .cols = everything(),
      .fns = list(min = ~min(.x, na.rm = TRUE), max = ~max(.x, na.rm = TRUE))
    )
  ) %>% 
  pivot_longer(
    everything(),
    names_to = c("column", ".value"),
    names_sep = "_"
  )
```

They are all in range, now reverse scoring for GH1 (item #1), BP2 (item #8), MH3 (item #9), and VT2 (item #10). These directions come from https://www.researchgate.net/profile/John_Ware/publication/291994160_How_to_score_SF-12_items/links/58combined_participant_datac467a6fdcc41bf920748/How-to-score-SF-12-items.pcombined_participant_data, pg. 22.

Poor health should be low score, and good health should be high score.

```{r}
sf12 <- sf12 %>% 
  mutate(
    across(
      .cols = c(gh1, bp2),
      .fns  = ~ case_when(
        .x == 1 ~ 5,
        .x == 2 ~ 4,
        .x == 3 ~ 3,
        .x == 4 ~ 2,
        .x == 5 ~ 1
      ),
      .names = "r{col}"
    ),
    across(
      .cols = c(mh3, vt2),
      .fns  = ~ case_when(
        .x == 1 ~ 6,
        .x == 2 ~ 5,
        .x == 3 ~ 4,
        .x == 4 ~ 3,
        .x == 5 ~ 2,
        .x == 6 ~ 1
      ),
      .names = "r{col}"
    )
  )
```

#### Step 2: Create indicator variables from item response choices

```{r}
sf12$pf02_1 <- as.numeric(sf12$pf02 == 1L) 
sf12$pf02_2 <- as.numeric(sf12$pf02 == 2L) 

sf12$pf04_1 <- as.numeric(sf12$pf04 == 1L) 
sf12$pf04_2 <- as.numeric(sf12$pf04 == 2L)

sf12$rp2_1 <- as.numeric(sf12$rp2 == 1L) 

sf12$rp3_1 <- as.numeric(sf12$rp3 == 1L) 

sf12$bp2_1 <- as.numeric(sf12$rbp2 == 1L) 
sf12$bp2_2 <- as.numeric(sf12$rbp2 == 2L) 
sf12$bp2_3 <- as.numeric(sf12$rbp2 == 3L) 
sf12$bp2_4 <- as.numeric(sf12$rbp2 == 4L) 

sf12$gh1_1 <- as.numeric(sf12$rgh1 == 1L) 
sf12$gh1_2 <- as.numeric(sf12$rgh1 == 2L) 
sf12$gh1_3 <- as.numeric(sf12$rgh1 == 3L) 
sf12$gh1_4 <- as.numeric(sf12$rgh1 == 4L) 

sf12$vt2_1 <- as.numeric(sf12$rvt2 == 1L) 
sf12$vt2_2 <- as.numeric(sf12$rvt2 == 2L) 
sf12$vt2_3 <- as.numeric(sf12$rvt2 == 3L) 
sf12$vt2_4 <- as.numeric(sf12$rvt2 == 4L) 
sf12$vt2_5 <- as.numeric(sf12$rvt2 == 5L) 

sf12$sf2_1 <- as.numeric(sf12$sf2 == 1L) 
sf12$sf2_2 <- as.numeric(sf12$sf2 == 2L) 
sf12$sf2_3 <- as.numeric(sf12$sf2 == 3L) 
sf12$sf2_4 <- as.numeric(sf12$sf2 == 4L) 

sf12$re2_1 <- as.numeric(sf12$re2 == 1L) 

sf12$re3_1 <- as.numeric(sf12$re3 == 1L) 

sf12$mh3_1 <- as.numeric(sf12$rmh3 == 1L) 
sf12$mh3_2 <- as.numeric(sf12$rmh3 == 2L) 
sf12$mh3_3 <- as.numeric(sf12$rmh3 == 3L) 
sf12$mh3_4 <- as.numeric(sf12$rmh3 == 4L) 
sf12$mh3_5 <- as.numeric(sf12$rmh3 == 5L) 

sf12$mh4_1 <- as.numeric(sf12$mh4 == 1L) 
sf12$mh4_2 <- as.numeric(sf12$mh4 == 2L) 
sf12$mh4_3 <- as.numeric(sf12$mh4 == 3L) 
sf12$mh4_4 <- as.numeric(sf12$mh4 == 4L) 
sf12$mh4_5 <- as.numeric(sf12$mh4 == 5L) 
```

#### Step 3. Weighting and aggregation of indicator variables using physical and mental regression weights

```{r}
raw_pcs_12 <- with(sf12,
  (-7.23216*pf02_1) + (-3.45555*pf02_2) +
  (-6.24397*pf04_1) + (-2.73557*pf04_2) +
  (-4.61617*rp2_1) + 
  (-5.51747*rp3_1) +
  (-11.25544*bp2_1) + (-8.38063*bp2_2) +
  (-6.50522*bp2_3) + (-3.80130*bp2_4) + (-8.37399*gh1_1) +
  (-5.56461*gh1_2) + (-3.02396*gh1_3) + (-1.31872*gh1_4) +
  (-2.44706*vt2_1) + (-2.02168*vt2_2) + (-1.6185*vt2_3) +
  (-1.14387*vt2_4) + (-0.42251*vt2_5) + (-0.33682*sf2_1) +
  (-0.94342*sf2_2) + (-0.18043*sf2_3) + (0.11038*sf2_4) +
  (3.04365*re2_1) + (2.32091*re3_1) + (3.46638*mh3_1) +
  (2.90426*mh3_2) + (2.37241*mh3_3) + (1.36689*mh3_4) +
  (0.66514*mh3_5) + (4.61446*mh4_1) + (3.41593*mh4_2) +
  (2.34247*mh4_3) + (1.28044*mh4_4) + (0.41188*mh4_5)
)
  
raw_mcs_12 <- with(sf12,
  (3.93115*pf02_1) + (1.8684*pf02_2) +
  (2.68282*pf04_1) + (1.43103*pf04_2) + (1.4406*rp2_1) +
  (1.66968*rp3_1) + (1.48619*bp2_1) + (1.76691*bp2_2) +
  (1.49384*bp2_3) + (0.90384*bp2_4) + (-1.71175*gh1_1) +
  (-0.16891*gh1_2) + (0.03482*gh1_3) + (-0.06064*gh1_4) +
  (-6.02409*vt2_1) + (-4.88962*vt2_2) + (-3.29805*vt2_3) +
  (-1.65178*vt2_4) + (-0.92057*vt2_5) + (-6.29724*sf2_1) +
  (-8.26066*sf2_2) + (-5.63286*sf2_3) + (-3.13896*sf2_4) +
  (-6.82672*re2_1) + (-5.69921*re3_1) + (-10.19085*mh3_1) +
  (-7.92717*mh3_2) + (-6.31121*mh3_3) + (-4.09842*mh3_4) +
  (-1.94949*mh3_5) + (-16.15395*mh4_1) + (-10.77911*mh4_2) +
  (-8.09914*mh4_3) + (-4.59055*mh4_4) + (-1.95934*mh4_5)
)
```

#### Step 4. Norm-based standardization of scale scores

And add the Physical Component Summary (pcs) and Mental Component Summary (mcs) scores to the full data frame.

```{r}
combined_participant_data <- combined_participant_data %>% 
  mutate(
    pcs_12 = raw_pcs_12 + 56.57706,
    mcs_12 = raw_mcs_12 + 60.75781
  )

# VARIABLE LABELS 
attr(combined_participant_data$pcs_12, "label") <- 'SF-12 Physical Component Summary Score'
attr(combined_participant_data$mcs_12, "label") <- 'SF-12 Physical Component Summary Score'
```

```{r}
rm(sf12, raw_mcs_12, raw_pcs_12)
```

### 13. Health Related Quality of Life (HRQ)

* Visit 1, Section 13, Q152-Q154

```{r}
combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(HRQ1_V1:HRQ3_V1) %>%
  # Make variable names more descriptive
  rename(
    hrq_physical_30	= hrq_1,
    hrq_mental_30 =	hrq_2,
    hrq_limit_activities_30 =	hrq_3
  ) %>%

  # Change skip values (e.g., 9, 99, etc.) to missing
  mutate(
    across(
      c(hrq_physical_30:hrq_limit_activities_30),
      ~ nines_to_na(.x, 99)
    )
  )
```

### 14. Self-Rated Health Questionnaire (S)

* Visit 1, Section 14, Q155-Q211

#### 14.1 History of Mental illnesses

#### 14.2 History of Substance abuse

2021-01-25: Before I can do this part, I need to figure out what the line below that says "IF (S29_V1 =0) Substance_abuse_hs = 0" does. More specifically, what is the value of Substance_abuse_hs when S29_V1 does not equal 0? Is Substance_abuse_hs just missing? Don't need this right now for the big descriptive table though.

#### 14.3 Pain

#### 14.4 Smartphone app

```{r}
combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(S41_V1:S43_V1) %>%
  # X:Y doesn't immediately follow Z
  # Make variable names more descriptive
  rename(
    sp_app_change_behavior = srh_50,
    sp_app_manage_health = srh_51
  ) %>%

  # Change skip values (e.g., 9, 99, etc.) to missing
  mutate(
    across(
      c(sp_app_change_behavior, sp_app_manage_health),
      ~ nines_to_na(.x, c(7, 8, 9))
    )
  ) %>%

  # Make factor versions of categorical variables
  mutate(
    across(
      c(sp_app_change_behavior, sp_app_manage_health),
      spss_to_fs,
      .names = "{col}_f"
    )
  ) %>% 
  
  # Drop Don't Know/Refuse to Answer/Not Applicable factor levels. 
  # We don't want them showing up on categorical analysis.
  mutate(
    across(
      c(sp_app_change_behavior_f, sp_app_manage_health_f),
      ~ fct_drop(.x, only = c("Don't Know", "Refuse to Answer", "Not Applicable"))
    )
  )
```

Create a combined What type of health related issue variable. This has been created as of 2023-03-27 for "srh_52."

### 15. PTSD Screen (PTSD)

* Visit 1, Section 15, Q212-Q215

### 16. Tobacco History Questionnaire (T)

* Visit 1, Section 16, Q216-Q271

### 17. Heaviness of Smoking Index (HSI)

* Visit 1, Section 17, Q272-Q273

Heaviness of Smoking Index for each visit + heaviness of smoking index recoded into categories

### 18. BRFSS - Inadequate Sleep (BRS)

* Visit 1, Section 18, Q274-Q278
As of 2023-03-28, variables "bris2_qd_dichot" and "unintent_slp" have been created in the combined dataset and don't need to be calculated.

### 19. Alcohol Quantity, Frequency and Binge Drinking Questionnaire (AF)

* Visit 1, Section 19, Q279-Q290

### 20. Meal Survey (MS)

* Visit 1, Section 20, Q291-Q294

```{r}
combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(starts_with("MS") & ends_with("V1")) %>%
  # X:Y doesn't immediately follow Z
  # Make variable names more descriptive
  rename(
    meals_eaten_yesterday = ms_1,
    meals_cafeteria_24_hours = ms_2,
    meals_fruit_veg_yesterday = ms_3,
    meals_missed_week = ms_4
  ) %>%

  # Change skip values (e.g., 9, 99, etc.) to missing
  mutate(
    across(
      c(meals_eaten_yesterday:meals_missed_week),
      ~ nines_to_na(.x, 9)
    )
  ) %>%

  # Make factor versions of categorical variables
  mutate(
    across(
      c(meals_eaten_yesterday:meals_missed_week),
      spss_to_fs,
      .names = "{col}_f"
    )
  )
```

### 21. Sexual Behaviors (SB)

* Visit 1, Section 21, Q295-Q303

### 22. Stress

* Visit 1, Section 22, No questions
* Visit 2, Section 7, No questions

### 23. Detroit Day Discrimination (DD)

* Visit 1, Section 23, Q304-Q313

```{r}
combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(DD1_V1:DD10_V1) %>%
  # Make variable names more descriptive
  rename(
    ddd_less_courtesy = dd_1,
    ddd_less_respect = dd_2,
    ddd_poorer_service = dd_3,
    ddd_not_smart = dd_4,
    ddd_afraid = dd_5,
    ddd_dishonest = dd_6,
    ddd_better = dd_7,
    ddd_insulted = dd_8,
    ddd_threatened = dd_9,
    ddd_main_reason = dd_10
  ) %>%

  # Change skip values (e.g., 9, 99, etc.) to missing
  mutate(
    across(
      c(ddd_less_courtesy:ddd_threatened),
      ~ nines_to_na(.x, 9)
    ),
    ddd_main_reason = nines_to_na(ddd_main_reason, c(97, 98, 99))
  ) %>% 

  # Make factor versions of categorical variables
  mutate(
    across(
      c(ddd_less_courtesy:ddd_main_reason),
      spss_to_fs,
      .names = "{col}_f"
    )
  ) %>% 
  
  # Drop Don't Know/Refuse to Answer/Not Applicable factor levels. 
  # We don't want them showing up on categorical analysis.
  mutate(
    across(
      c(ddd_main_reason_f),
      ~ fct_drop(.x, only = c("Don't Know", "Refuse to Answer", "Not Applicable"))
    )
  ) 

# VARIABLE LABELS
attr(combined_participant_data$ddd_less_courtesy_f, "label") <- "In your day-to-day life how often are you treated with less courtesy?"
attr(combined_participant_data$ddd_less_respect_f, "label") <- "In your day-to-day life how often are you treated with less respect?"
attr(combined_participant_data$ddd_poorer_service_f, "label") <- "In your day-to-day life how often do you receive poorer service than other people at restaurants or stores?"
attr(combined_participant_data$ddd_not_smart_f, "label") <- "In your day-to-day life how often do people act as if they think you are not smart?"
attr(combined_participant_data$ddd_afraid_f, "label") <- "In your day-to-day life how often do people act as if they are afraid of you?"
attr(combined_participant_data$ddd_dishonest_f, "label") <- "In your day-to-day life how often do people act as if they think you are dishonest?"
attr(combined_participant_data$ddd_better_f, "label") <- "In your day-to-day life how often do people act as if they're better than you ?"
attr(combined_participant_data$ddd_insulted_f, "label") <- "In your day-to-day life how often are you called names or insulted?"
attr(combined_participant_data$ddd_threatened_f, "label") <- "In your day-to-day life how often are you threatened or harassed?"
attr(combined_participant_data$ddd_main_reason_f, "label") <- "What was the main reason for the discrimination you experienced?"
```

### 24. Negative/Positive Affect

* Visit 1, Section 24, No questions

### 25. Agression Questionniare (AQ)

* Visit 1, Section 25, Q314-Q325

### 26. CES-D (CES)

* Visit 1, Section 26, Q326-Q335

### 27. Inter/Intrapersonal Resources 

* Visit 1, Section 27, No questions

### 28. Interpersonal Support Evaluation List (IS)

* Visit 1, Section 28, Q336-Q347

### 29. Religious Participation (RP)

* Visit 1, Section 29, Q348-Q349

### 30. Lubben Social Network Scale (LSN)

* Visit 1, Section 30, Q350-Q355

### 31. Resource Utilization (R)

* Visit 1, Section 31, Q356-Q371

### 32. Barriers to Phone Based Case Management (BPM)

* Visit 1, Section 32, Q372-Q376

### 33. TCU Drug Screen 5 (DS)

* Visit 2, Section 2, Q8-Q20

### 34. BRFSS Adverse Childhood Experience (ACE) Model (BRAC)

* Visit 2, Section 3, Q21-Q31

### 35. Personality Beliefs Questionaire-Short Form- Antisocial Beliefs (PBQ)

* Visit 2, Section 4, Q32-Q38

### 36. Food Security (FSS)

* Visit 2, Section 5, Q39-Q44

### 37. TCU CJ Client Evaluation of Self and Treatment (CJ)

* Visit 2, Section 6, Q45-Q84

### 38. MacArthur Major Discrimination (MMD)

* Visit 2, Section 8, Q85-Q98

```{r}
combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(MMD2:MMD4) %>%
  # Make variable names more descriptive
  rename(
    macarthur_main_reason = mmd_2,
    macarthur_interfere = mmd_3,
    macarthur_harder_life = mmd_4,
  ) %>%

  # Change skip values (e.g., 9, 99, etc.) to missing
  mutate(
    macarthur_main_reason = nines_to_na(macarthur_main_reason, 99),
    across(
      c(macarthur_interfere:macarthur_harder_life),
      ~ nines_to_na(.x, 9)
    )
  ) %>%

  # Make factor versions of categorical variables
  mutate(
    across(
      c(macarthur_main_reason:macarthur_harder_life),
      spss_to_fs,
      .names = "{col}_f"
    )
  )

# VARIABLE LABELS
attr(combined_participant_data$macarthur_main_reason_f, "label") <- "MacArthur: What was the main reason for the discrimination you experienced?"
attr(combined_participant_data$macarthur_interfere_f, "label") <- "MacArthur: Overall, how much has discrimination interfered with you having a full and productive life?"
attr(combined_participant_data$macarthur_harder_life_f, "label") <- "MacArthur: Overall, how much harder has your life been because of discrimination?"
```

### 39. Urban life stress scale (ULS)

* Visit 2, Section 9, Q99-Q84

### 40. Personal Victimization (PV)

* Visit 2, Section 10, Q120-Q122

```{r}
combined_participant_data <- combined_participant_data %>%
  # For data checks
  # select(PV1_V2:PV3_V2) %>%
  # Make variable names more descriptive
  rename(
    pv_violence_victim_30 = pv_1,
    pv_witness_violence_30 = pv_2,
    pv_witness_violence_6 = pv_3
  ) %>%

  # Make factor versions of categorical variables
  mutate(
    across(
      c(pv_violence_victim_30:pv_witness_violence_6),
      spss_to_fs,
      .names = "{col}_f"
    )
  )

# VARIABLE LABELS
attr(combined_participant_data$pv_violence_victim_30_f, "label") <- "In the past 30 days, has anyone used violence, such as in a mugging, fight, or sexual assault, against you?"
attr(combined_participant_data$pv_witness_violence_30_f, "label") <- "In the past 30 days, how many times have you been a witness to acts of violence?"
attr(combined_participant_data$pv_witness_violence_6_f, "label") <- "In the past 6 months, how many times have you been a witness to acts of violence?"
```

### 41. Perceived Stress Scale (PS)

* Visit 2, Section 11, Q123-Q126

### 42. Distress Tolerance Scale (DTS)

* Visit 2, Section 12, Q127-Q142

All the questions in QDS were reversed coded. Each question was recoded to the correct score, except question DTS7_V2 because that question should be reversed coded. Question DTS8_V2 is not included in any subscale or the total score. See appendix for paper citation.

Print a message for when this file is being sourced

```{r}
# The number of rows will change over time as we recruit people.
# However, we should never end up with more rows in the combined data than
# exist in the v1 data.
# Also, any changes to the number of columns should initiate an investigation
# into why.
cat(
  paste0(Sys.Date(), ":"),
  "The combined_participant_data data frame was cleaned with calculated variables in data_survey_39_long_calc_import.Rds with",
  nrow(combined_participant_data), "rows and", ncol(combined_participant_data), "columns.\n\n"
)
cat("The number of rows will change over time as we recruit people. However, we should never end up with more rows in the combined data than exist in the v1 data.\n\n")
cat("Also, any changes to the number of columns should initiate an investigation into why.")

# 2021-01-28: The combined_participant_data data frame was created and cleaned in data_survey_01_import.Rds with 263 rows and 2850 columns.
# 2023-03-28: The combined_participant_data data frame was cleaned with calculated variables in data_survey_39_long_calc_import.Rds with 1601 rows and 1280 columns.
# 2023-05-02: The combined_participant_data data frame was cleaned with calculated variables in data_survey_39_long_calc_import.Rds with 48064 rows and 1184 columns.

```
# ðŸ’¾Save the data frame

```{r}
path <- "../Participant Data/SPSS Data/combined_participant_data.sav"
```

```{r}
write_sav(combined_participant_data, path)
```

Print a message for when this file is being sourced

```{r}
cat(
  paste0(Sys.Date(), ":"),
  "Combined Participant data saved to", path, "\n"
)
```

```{r}
path <- "../Participant Data/R Data/combined_participant_data.rds"
```

```{r}
write_rds(combined_participant_data, path)
```

Print a message for when this file is being sourced

```{r}
cat(
  paste0(Sys.Date(), ":"),
  "Combined Participant data saved to", path, "\n"
)
```

# ðŸ—‘Clean up

```{r}
rm(list = ls()[ls() != "source_rmd"])
```








